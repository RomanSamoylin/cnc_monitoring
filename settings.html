<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏—Å—Ç–µ–º—ã</title>
    <link rel="icon" type="image/x-icon" href="images/favicon.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="styles4.css">
</head>
<body>
    <header>
        <h1>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏—Å—Ç–µ–º—ã</h1>
        <button class="logout-button" onclick="location.href='login.html'">
            <i class="fas fa-sign-out-alt"></i> –í—ã–π—Ç–∏
        </button>
    </header>
    
    <nav>
        <button onclick="location.href='dashboard.html'">
            <i class="fas fa-tachometer-alt"></i> –î–∞—à–±–æ—Ä–¥—ã
        </button>
        <button onclick="location.href='charts.html'">
            <i class="fas fa-chart-line"></i> –ì—Ä–∞—Ñ–∏–∫–∏ –∞–Ω–∞–ª–∏–∑–∞
        </button>
        <button onclick="location.href='reports.html'">
            <i class="fas fa-file-alt"></i> –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –æ—Ç—á–µ—Ç–æ–≤
        </button>
        <button class="active" onclick="location.href='settings.html'">
            <i class="fas fa-cog"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏
        </button>
    </nav>
    
    <div class="container">
        <div class="sidebar">
            <h3><i class="fas fa-sliders-h"></i> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã</h3>
            <div class="stats-panel">
                <div class="stat-item">
                    <span class="stat-label">–¶–µ—Ö–æ–≤:</span>
                    <span class="stat-value" id="workshopsCount">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">–°—Ç–∞–Ω–∫–æ–≤:</span>
                    <span class="stat-value" id="machinesCount">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">–û–±–Ω–æ–≤–ª–µ–Ω–æ:</span>
                    <span class="stat-value" id="lastUpdate">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">–°—Ç–∞—Ç—É—Å:</span>
                    <span class="stat-value" id="serverStatus">-</span>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-success" onclick="saveAllSettings()">
                    <i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                </button>
                <button class="btn btn-info" onclick="refreshData()" style="margin-top: 10px;">
                    <i class="fas fa-sync"></i> –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
                </button>
                <button class="btn btn-warning" onclick="resetToDefaults()" style="margin-top: 10px;">
                    <i class="fas fa-undo"></i> –°–±—Ä–æ—Å–∏—Ç—å –∫ —É–º–æ–ª—á–∞–Ω–∏—è–º
                </button>
                <button class="btn btn-secondary" onclick="checkDatabaseState()" style="margin-top: 10px;">
                    <i class="fas fa-database"></i> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                </button>
            </div>
        </div>
        
        <div class="content">
            <!-- –°–µ–∫—Ü–∏—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ü–µ—Ö–∞–º–∏ -->
            <div class="settings-section">
                <div class="section-header">
                    <h2><i class="fas fa-industry"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ü–µ—Ö–∞–º–∏</h2>
                    <div class="btn-group">
                        <button class="btn btn-success btn-sm" onclick="addWorkshop()" id="addWorkshopBtn">
                            <i class="fas fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å —Ü–µ—Ö
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="removeLastWorkshop()" id="removeWorkshopBtn" disabled>
                            <i class="fas fa-minus"></i> –£–¥–∞–ª–∏—Ç—å —Ü–µ—Ö
                        </button>
                    </div>
                </div>
                <div id="workshopsSettings" class="workshops-container">
                    <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ü–µ—Ö–æ–≤ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –∑–¥–µ—Å—å -->
                </div>
            </div>
            
            <!-- –°–µ–∫—Ü–∏—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å—Ç–∞–Ω–∫–æ–≤ -->
            <div class="settings-section">
                <div class="section-header">
                    <h2><i class="fas fa-cogs"></i> –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç–∞–Ω–∫–æ–≤ –ø–æ —Ü–µ—Ö–∞–º</h2>
                    <small>–°—Ç–∞–Ω–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö. –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Å—Ç–∞–Ω–æ–∫ –≤ –Ω—É–∂–Ω—ã–π —Ü–µ—Ö.</small>
                </div>
                
                <div class="machines-management">
                    <div class="available-machines">
                        <h4>–î–æ—Å—Ç—É–ø–Ω—ã–µ —Å—Ç–∞–Ω–∫–∏:</h4>
                        <div id="machinesList" class="machines-list">
                            <!-- –°–ø–∏—Å–æ–∫ —Å—Ç–∞–Ω–∫–æ–≤ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –∑–¥–µ—Å—å -->
                        </div>
                    </div>
                    
                    <div class="distribution-help">
                        <h4><i class="fas fa-info-circle"></i> –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</h4>
                        <ul>
                            <li>–°—Ç–∞–Ω–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö</li>
                            <li>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Å—Ç–∞–Ω–æ–∫ –≤ –Ω—É–∂–Ω—ã–π —Ü–µ—Ö –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è</li>
                            <li>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä –≤ –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–∞—Ö –¥–ª—è –≥—Ä—É–ø–ø–æ–≤–æ–≥–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è</li>
                            <li>–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–∏</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- –°–µ–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞/–∏–º–ø–æ—Ä—Ç–∞ -->
            <div class="settings-section">
                <h2><i class="fas fa-database"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏</h2>
                <div class="data-management">
                    <div class="form-group">
                        <button class="btn btn-primary" onclick="exportSettings()">
                            <i class="fas fa-file-export"></i> –≠–∫—Å–ø–æ—Ä—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫
                        </button>
                        <button class="btn btn-secondary" onclick="importSettings()" style="margin-left: 10px;">
                            <i class="fas fa-file-import"></i> –ò–º–ø–æ—Ä—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫
                        </button>
                        <button class="btn btn-warning" onclick="forceReloadWorkshops()" style="margin-left: 10px;">
                            <i class="fas fa-sync"></i> –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Ü–µ—Ö–∏
                        </button>
                    </div>
                    
                    <div class="backups-section">
                        <h4><i class="fas fa-history"></i> –†–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏</h4>
                        <div class="form-group">
                            <button class="btn btn-info btn-sm" onclick="loadBackupsList()">
                                <i class="fas fa-sync"></i> –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫
                            </button>
                        </div>
                        <div id="backupsList" class="backups-list"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="notification" id="notification"></div>
    
    <script>
        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        const state = {
            workshops: [],
            machines: [],
            lastUpdate: null,
            serverStatus: 'unknown'
        };
        
        // –ö—ç—à DOM —ç–ª–µ–º–µ–Ω—Ç–æ–≤
        const DOM = {
            workshopsCount: document.getElementById('workshopsCount'),
            machinesCount: document.getElementById('machinesCount'),
            lastUpdate: document.getElementById('lastUpdate'),
            serverStatus: document.getElementById('serverStatus'),
            workshopsSettings: document.getElementById('workshopsSettings'),
            machinesList: document.getElementById('machinesList'),
            notification: document.getElementById('notification'),
            backupsList: document.getElementById('backupsList'),
            addWorkshopBtn: document.getElementById('addWorkshopBtn'),
            removeWorkshopBtn: document.getElementById('removeWorkshopBtn')
        };

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤ —Å–∞–π–¥–±–∞—Ä–µ
        function updateSidebarStats() {
            DOM.workshopsCount.textContent = state.workshops.length;
            DOM.machinesCount.textContent = state.machines.length;
            DOM.lastUpdate.textContent = state.lastUpdate ? 
                new Date(state.lastUpdate).toLocaleTimeString() : '-';
            DOM.serverStatus.textContent = state.serverStatus;
            
            console.log('üìä –û–±–Ω–æ–≤–ª–µ–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:', {
                workshops: state.workshops.length,
                machines: state.machines.length,
                lastUpdate: state.lastUpdate
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–æ–≤ —Å—Ç–∞–Ω–∫–æ–≤ –≤ —Ü–µ—Ö–∞—Ö
        function updateWorkshopsMachinesCount() {
            state.workshops.forEach(workshop => {
                workshop.machinesCount = state.machines.filter(m => m.workshopId === workshop.id).length;
            });
            
            console.log('üî¢ –û–±–Ω–æ–≤–ª–µ–Ω—ã —Å—á–µ—Ç—á–∏–∫–∏ —Å—Ç–∞–Ω–∫–æ–≤:', 
                state.workshops.map(w => `${w.name}: ${w.machinesCount} —Å—Ç–∞–Ω–∫–æ–≤`));
        }

        // –ü–æ–ª–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        function refreshInterface() {
            updateWorkshopsMachinesCount();
            updateSidebarStats();
            renderWorkshopsSettings();
            renderMachinesList();
            updateButtonsState();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        function updateApplicationState(newSettings) {
            console.log('üîÑ –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–û–°–¢–û–Ø–ù–ò–Ø –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø:', {
                workshops: newSettings.workshops ? newSettings.workshops.length : 0,
                machines: newSettings.machines ? newSettings.machines.length : 0,
                workshopsList: newSettings.workshops ? newSettings.workshops.map(w => `${w.name}(id:${w.id})`) : []
            });
            
            // –í–ê–ñ–ù–û: –ü–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–º–µ–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            state.workshops = newSettings.workshops ? [...newSettings.workshops] : [];
            state.machines = newSettings.machines ? [...newSettings.machines] : [];
            state.lastUpdate = new Date().toISOString();
            state.serverStatus = 'connected';
            
            // –ï—Å–ª–∏ —Ü–µ—Ö–æ–≤ –Ω–µ—Ç, —Å–æ–∑–¥–∞–µ–º —Ü–µ—Ö –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            if (state.workshops.length === 0) {
                state.workshops = [{ id: 1, name: "–¶–ï–•-1", machinesCount: 0 }];
                console.log('‚ö†Ô∏è –¶–µ—Ö–æ–≤ –Ω–µ—Ç, —Å–æ–∑–¥–∞–Ω —Ü–µ—Ö –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é');
            }
            
            refreshInterface();
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å —Å–µ—Ä–≤–µ—Ä–∞
        async function loadSettings() {
            try {
                showNotification('–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫...', 'info');
                
                console.log('üì• –ó–ê–ü–†–û–° –ù–ê–°–¢–†–û–ï–ö –° –°–ï–†–í–ï–†–ê...');
                const response = await fetch('http://localhost:3004/api/settings');
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error: ${response.status} - ${errorText}`);
                }
                
                const data = await response.json();
                if (!data.success) throw new Error(data.message || '–û—à–∏–±–∫–∞ –≤ –¥–∞–Ω–Ω—ã—Ö');
                
                console.log('‚úÖ –ü–û–õ–£–ß–ï–ù–´ –ù–ê–°–¢–†–û–ô–ö–ò –° –°–ï–†–í–ï–†–ê:', {
                    workshops: data.settings.workshops.length,
                    machines: data.settings.machines.length,
                    workshopsList: data.settings.workshops.map(w => `${w.name}(id:${w.id})`),
                    machinesDistribution: data.settings.machines.map(m => `${m.name} -> –¶–ï–•-${m.workshopId}`)
                });
                
                // –í–ê–ñ–ù–û: –ü–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–º–µ–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                updateApplicationState(data.settings);
                
                showNotification(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${state.workshops.length} —Ü–µ—Ö–æ–≤, ${state.machines.length} —Å—Ç–∞–Ω–∫–æ–≤`, 'success');
                
            } catch (error) {
                console.error('‚ùå –û–®–ò–ë–ö–ê –ó–ê–ì–†–£–ó–ö–ò –ù–ê–°–¢–†–û–ï–ö:', error);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫: ' + error.message, 'error');
                state.serverStatus = 'disconnected';
                updateSidebarStats();
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                updateApplicationState({
                    workshops: [{ id: 1, name: "–¶–ï–•-1", machinesCount: 0 }],
                    machines: []
                });
            }
        }

        // –ï–î–ò–ù–´–ô –ú–ï–¢–û–î –°–û–•–†–ê–ù–ï–ù–ò–Ø: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –í–°–ï–• –Ω–∞—Å—Ç—Ä–æ–µ–∫ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        async function saveAllSettings() {
            try {
                showNotification('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫...', 'info');
                
                const settings = {
                    workshops: state.workshops,
                    machines: state.machines
                };
                
                console.log('üíæ –û–¢–ü–†–ê–í–ö–ê –í–°–ï–• –ù–ê–°–¢–†–û–ï–ö –ù–ê –°–ï–†–í–ï–†:', {
                    workshops: settings.workshops.length,
                    machines: settings.machines.length,
                    workshopsList: settings.workshops.map(w => `${w.name}(id:${w.id})`),
                    machinesDistribution: settings.machines.map(m => `${m.name} -> –¶–ï–•-${m.workshopId}`)
                });
                
                const response = await fetch('http://localhost:3004/api/settings/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ settings })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error: ${response.status} - ${errorText}`);
                }
                
                const data = await response.json();
                if (!data.success) throw new Error(data.message || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
                
                state.lastUpdate = new Date().toISOString();
                state.serverStatus = 'connected';
                updateSidebarStats();
                
                console.log('‚úÖ –í–°–ï –ù–ê–°–¢–†–û–ô–ö–ò –£–°–ü–ï–®–ù–û –°–û–•–†–ê–ù–ï–ù–´ –ù–ê –°–ï–†–í–ï–†:', {
                    workshops: data.settings.workshops.length,
                    machines: data.settings.machines.length
                });
                
                showNotification(`–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ${data.settings.workshops.length} —Ü–µ—Ö–æ–≤, ${data.settings.machines.length} —Å—Ç–∞–Ω–∫–æ–≤`, 'success');
                return true;
                
            } catch (error) {
                console.error('‚ùå –û–®–ò–ë–ö–ê –°–û–•–†–ê–ù–ï–ù–ò–Ø –ù–ê–°–¢–†–û–ï–ö:', error);
                state.serverStatus = 'error';
                updateSidebarStats();
                showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫: ' + error.message, 'error');
                return false;
            }
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Ü–µ—Ö–æ–≤
        function renderWorkshopsSettings() {
            const fragment = document.createDocumentFragment();
            
            console.log('üé® –û–¢–†–ò–°–û–í–ö–ê –¶–ï–•–û–í:', state.workshops.length);
            
            state.workshops.forEach(workshop => {
                const workshopDiv = document.createElement('div');
                workshopDiv.className = 'workshop-card';
                workshopDiv.dataset.workshopId = workshop.id;
                
                const machinesInWorkshop = state.machines.filter(m => m.workshopId === workshop.id);
                
                workshopDiv.innerHTML = `
                    <div class="workshop-header">
                        <h4>${workshop.name} (ID: ${workshop.id})</h4>
                        <span class="machines-badge">${workshop.machinesCount} —Å—Ç–∞–Ω–∫–æ–≤</span>
                    </div>
                    <div class="workshop-body">
                        <div class="form-group">
                            <label>–ù–∞–∑–≤–∞–Ω–∏–µ —Ü–µ—Ö–∞:</label>
                            <input type="text" value="${workshop.name}" 
                                   onchange="updateWorkshopName(${workshop.id}, this.value)"
                                   placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ü–µ—Ö–∞">
                        </div>
                        <div class="form-group">
                            <label>–°—Ç–∞–Ω–∫–∏ –≤ —Ü–µ—Ö–µ (${machinesInWorkshop.length}):</label>
                            <select multiple class="machines-select" 
                                    onchange="updateMachinesDistribution(${workshop.id}, this)">
                                ${state.machines.map(m => 
                                    `<option value="${m.id}" ${m.workshopId === workshop.id ? 'selected' : ''}>
                                        ${m.name} (ID: ${m.id})
                                    </option>`
                                ).join('')}
                            </select>
                            <small>–î–ª—è –≤—ã–±–æ—Ä–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å—Ç–∞–Ω–∫–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Ctrl+Click</small>
                        </div>
                        <div class="workshop-machines-list">
                            <strong>–¢–µ–∫—É—â–∏–µ —Å—Ç–∞–Ω–∫–∏ –≤ —Ü–µ—Ö–µ:</strong>
                            ${machinesInWorkshop.length > 0 ? 
                                machinesInWorkshop.map(m => 
                                    `<div class="machine-tag">${m.name} (ID: ${m.id})</div>`
                                ).join('') : 
                                '<div class="no-machines">–ù–µ—Ç —Å—Ç–∞–Ω–∫–æ–≤</div>'
                            }
                        </div>
                    </div>
                `;
                
                fragment.appendChild(workshopDiv);
            });
            
            DOM.workshopsSettings.innerHTML = '';
            DOM.workshopsSettings.appendChild(fragment);
            initDragAndDrop();
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–ø–∏—Å–∫–∞ —Å—Ç–∞–Ω–∫–æ–≤
        function renderMachinesList() {
            const fragment = document.createDocumentFragment();
            
            console.log('üé® –û–¢–†–ò–°–û–í–ö–ê –°–ü–ò–°–ö–ê –°–¢–ê–ù–ö–û–í:', state.machines.length);
            
            state.machines.forEach(machine => {
                const workshop = state.workshops.find(w => w.id === machine.workshopId);
                const workshopName = workshop ? workshop.name : '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω';
                
                const machineItem = document.createElement('div');
                machineItem.className = 'machine-item';
                machineItem.dataset.machineId = machine.id;
                machineItem.draggable = true;
                machineItem.innerHTML = `
                    <div class="machine-info">
                        <div class="machine-name">${machine.name}</div>
                        <div class="machine-details">
                            <span class="machine-id">ID: ${machine.id}</span>
                            <span class="machine-workshop">–¶–µ—Ö: ${workshopName}</span>
                        </div>
                    </div>
                    <div class="machine-actions">
                        <small>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –≤ —Ü–µ—Ö</small>
                    </div>
                `;
                
                fragment.appendChild(machineItem);
            });
            
            DOM.machinesList.innerHTML = '';
            DOM.machinesList.appendChild(fragment);
            initDragAndDrop();
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è drag-and-drop
        function initDragAndDrop() {
            const machineItems = document.querySelectorAll('.machine-item');
            const workshopCards = document.querySelectorAll('.workshop-card');
            
            machineItems.forEach(item => {
                item.addEventListener('dragstart', function(e) {
                    e.dataTransfer.setData('text/plain', this.dataset.machineId);
                    this.classList.add('dragging');
                    console.log('üß© –ù–∞—á–∞—Ç–æ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ —Å—Ç–∞–Ω–∫–∞:', this.dataset.machineId);
                });
                
                item.addEventListener('dragend', function() {
                    this.classList.remove('dragging');
                    console.log('üß© –ó–∞–≤–µ—Ä—à–µ–Ω–æ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ —Å—Ç–∞–Ω–∫–∞');
                });
            });
            
            workshopCards.forEach(card => {
                card.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    this.classList.add('drop-hover');
                });
                
                card.addEventListener('dragleave', function() {
                    this.classList.remove('drop-hover');
                });
                
                card.addEventListener('drop', async function(e) {
                    e.preventDefault();
                    this.classList.remove('drop-hover');
                    
                    const machineId = parseInt(e.dataTransfer.getData('text/plain'));
                    const workshopId = parseInt(this.dataset.workshopId);
                    
                    console.log(`‚û°Ô∏è –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ —Å—Ç–∞–Ω–∫–∞ ${machineId} –≤ —Ü–µ—Ö ${workshopId}`);
                    await moveMachineToWorkshop(machineId, workshopId);
                });
            });
        }

        // –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ —Å—Ç–∞–Ω–∫–∞ –≤ —Ü–µ—Ö
        async function moveMachineToWorkshop(machineId, workshopId) {
            const machine = state.machines.find(m => m.id === machineId);
            if (machine) {
                const oldWorkshopId = machine.workshopId;
                const oldWorkshop = state.workshops.find(w => w.id === oldWorkshopId);
                machine.workshopId = workshopId;
                
                console.log(`üîÑ –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ —Å—Ç–∞–Ω–∫–∞ "${machine.name}" –∏–∑ —Ü–µ—Ö–∞ ${oldWorkshopId} –≤ —Ü–µ—Ö ${workshopId}`);
                
                refreshInterface();
                await saveAllSettings();
                
                const workshop = state.workshops.find(w => w.id === workshopId);
                showNotification(`–°—Ç–∞–Ω–æ–∫ "${machine.name}" –ø–µ—Ä–µ–º–µ—â–µ–Ω –∏–∑ "${oldWorkshop?.name || '–Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω'}" –≤ "${workshop.name}"`, 'success');
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è —Ü–µ—Ö–∞
        async function updateWorkshopName(workshopId, newName) {
            const workshop = state.workshops.find(w => w.id === workshopId);
            if (workshop && newName.trim()) {
                const oldName = workshop.name;
                workshop.name = newName.trim();
                
                console.log(`‚úèÔ∏è –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ü–µ—Ö–∞: "${oldName}" ‚Üí "${workshop.name}"`);
                
                refreshInterface();
                
                // –°–û–•–†–ê–ù–Ø–ï–ú –í–°–ï –ù–ê–°–¢–†–û–ô–ö–ò
                await saveAllSettings();
                showNotification(`–¶–µ—Ö –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω: "${oldName}" ‚Üí "${workshop.name}"`, 'success');
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å—Ç–∞–Ω–∫–æ–≤ —á–µ—Ä–µ–∑ select
        async function updateMachinesDistribution(workshopId, selectElement) {
            const selectedOptions = Array.from(selectElement.selectedOptions).map(opt => parseInt(opt.value));
            
            console.log(`üéØ –ì—Ä—É–ø–ø–æ–≤–æ–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ ${selectedOptions.length} —Å—Ç–∞–Ω–∫–æ–≤ –≤ —Ü–µ—Ö ${workshopId}`);
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ —Å—Ç–∞–Ω–∫–∏ —ç—Ç–æ–≥–æ —Ü–µ—Ö–∞
            state.machines.forEach(m => {
                if (m.workshopId === workshopId) {
                    m.workshopId = 1; // –ü–µ—Ä–µ–Ω–∞–∑–Ω–∞—á–∞–µ–º –≤ –ø–µ—Ä–≤—ã–π —Ü–µ—Ö
                }
            });
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Å—Ç–∞–Ω–∫–∏ –≤ —ç—Ç–æ—Ç —Ü–µ—Ö
            selectedOptions.forEach(machineId => {
                const machine = state.machines.find(m => m.id === machineId);
                if (machine) machine.workshopId = workshopId;
            });
            
            refreshInterface();
            await saveAllSettings();
            
            const workshop = state.workshops.find(w => w.id === workshopId);
            showNotification(`–í —Ü–µ—Ö "${workshop.name}" –Ω–∞–∑–Ω–∞—á–µ–Ω–æ ${selectedOptions.length} —Å—Ç–∞–Ω–∫–æ–≤`, 'success');
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ü–µ—Ö–∞
        async function addWorkshop() {
            const newId = state.workshops.length > 0 ? 
                Math.max(...state.workshops.map(w => w.id)) + 1 : 1;
            
            const newWorkshop = {
                id: newId,
                name: `–¶–ï–•-${newId}`,
                machinesCount: 0
            };
            
            state.workshops.push(newWorkshop);
            
            console.log(`‚ûï –î–æ–±–∞–≤–ª–µ–Ω –Ω–æ–≤—ã–π —Ü–µ—Ö:`, newWorkshop);
            
            refreshInterface();
            
            // –°–û–•–†–ê–ù–Ø–ï–ú –í–°–ï –ù–ê–°–¢–†–û–ô–ö–ò
            await saveAllSettings();
            
            showNotification(`–î–æ–±–∞–≤–ª–µ–Ω –Ω–æ–≤—ã–π —Ü–µ—Ö: –¶–ï–•-${newId}`, 'success');
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Ü–µ—Ö–∞
        async function removeLastWorkshop() {
            if (state.workshops.length <= 1) {
                showNotification('–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —Ü–µ—Ö', 'warning');
                return;
            }
            
            const removedWorkshop = state.workshops.pop();
            
            // –ü–µ—Ä–µ–Ω–∞–∑–Ω–∞—á–∞–µ–º —Å—Ç–∞–Ω–∫–∏ —É–¥–∞–ª—è–µ–º–æ–≥–æ —Ü–µ—Ö–∞ –≤ –ø–µ—Ä–≤—ã–π —Ü–µ—Ö
            let reassignedCount = 0;
            state.machines.forEach(machine => {
                if (machine.workshopId === removedWorkshop.id) {
                    machine.workshopId = 1;
                    reassignedCount++;
                }
            });
            
            console.log(`‚ûñ –£–¥–∞–ª–µ–Ω —Ü–µ—Ö:`, removedWorkshop, `–ü–µ—Ä–µ–º–µ—â–µ–Ω–æ —Å—Ç–∞–Ω–∫–æ–≤: ${reassignedCount}`);
            
            refreshInterface();
            
            // –°–û–•–†–ê–ù–Ø–ï–ú –í–°–ï –ù–ê–°–¢–†–û–ö–ò
            await saveAllSettings();
            
            showNotification(`–£–¥–∞–ª–µ–Ω —Ü–µ—Ö: ${removedWorkshop.name} (${reassignedCount} —Å—Ç–∞–Ω–∫–æ–≤ –ø–µ—Ä–µ–º–µ—â–µ–Ω–æ –≤ –¶–ï–•-1)`, 'success');
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–æ–∫
        function updateButtonsState() {
            DOM.removeWorkshopBtn.disabled = state.workshops.length <= 1;
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
        async function refreshData() {
            console.log('üîÑ –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï –î–ê–ù–ù–´–•...');
            await loadSettings();
        }

        // –°–±—Ä–æ—Å –∫ —É–º–æ–ª—á–∞–Ω–∏—è–º
        async function resetToDefaults() {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫ –∑–Ω–∞—á–µ–Ω–∏—è–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é?')) {
                return;
            }
            
            console.log('üîÑ –°–±—Ä–æ—Å –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∫ –∑–Ω–∞—á–µ–Ω–∏—è–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é');
            
            updateApplicationState({
                workshops: [{ id: 1, name: "–¶–ï–•-1", machinesCount: 0 }],
                machines: state.machines.map(m => ({ ...m, workshopId: 1 }))
            });
            
            await saveAllSettings();
            showNotification('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–±—Ä–æ—à–µ–Ω—ã –∫ –∑–Ω–∞—á–µ–Ω–∏—è–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é', 'success');
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ë–î
        async function checkDatabaseState() {
            try {
                showNotification('–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã...', 'info');
                
                console.log('üîç –ó–∞–ø—Ä–æ—Å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ —Å–∏—Å—Ç–µ–º—ã...');
                const response = await fetch('http://localhost:3004/api/settings/debug');
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error: ${response.status} - ${errorText}`);
                }
                
                const data = await response.json();
                if (!data.success) throw new Error(data.message || '–û—à–∏–±–∫–∞ –≤ –¥–∞–Ω–Ω—ã—Ö');
                
                console.log('üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã:', data.debug);
                
                const debugInfo = data.debug;
                const message = `–°–∏—Å—Ç–µ–º–∞: ${debugInfo.workshops_count} —Ü–µ—Ö–æ–≤, ${debugInfo.assignment_count} —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π, ${debugInfo.machines_count} —Å—Ç–∞–Ω–∫–æ–≤`;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ alert
                alert(`üìä –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –°–ò–°–¢–ï–ú–´:\n\n` +
                      `–¶–µ—Ö–æ–≤ –≤ —Å–∏—Å—Ç–µ–º–µ: ${debugInfo.workshops_count}\n` +
                      `–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π: ${debugInfo.assignment_count}\n` +
                      `–í—Å–µ–≥–æ —Å—Ç–∞–Ω–∫–æ–≤ –≤ —Å–∏—Å—Ç–µ–º–µ: ${debugInfo.machines_count}\n\n` +
                      `–¢–µ–∫—É—â–∏–µ —Ü–µ—Ö–∏: ${debugInfo.workshops.map(w => `${w.workshop_name}(id:${w.workshop_id})`).join(', ')}`);
                
                showNotification(message, 'info');
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã:', error);
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã', 'error');
            }
        }

        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Ü–µ—Ö–æ–≤
        async function forceReloadWorkshops() {
            try {
                showNotification('–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Ü–µ—Ö–æ–≤...', 'info');
                
                console.log('üîÑ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Ü–µ—Ö–æ–≤...');
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ü–µ—Ö–∏ –æ—Ç–¥–µ–ª—å–Ω–æ
                const response = await fetch('http://localhost:3004/api/settings/workshops');
                const data = await response.json();
                
                if (data.success && data.workshops) {
                    state.workshops = data.workshops;
                    updateWorkshopsMachinesCount();
                    refreshInterface();
                    console.log('‚úÖ –¶–µ—Ö–∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω—ã:', data.workshops.length);
                    showNotification(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${data.workshops.length} —Ü–µ—Ö–æ–≤`, 'success');
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Ü–µ—Ö–æ–≤:', error);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ü–µ—Ö–æ–≤', 'error');
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        function showNotification(message, type = 'success') {
            const types = {
                success: { bg: '#2ecc71', icon: 'fa-check' },
                error: { bg: '#e74c3c', icon: 'fa-exclamation-circle' },
                warning: { bg: '#f39c12', icon: 'fa-exclamation-triangle' },
                info: { bg: '#3498db', icon: 'fa-info-circle' }
            };
            
            DOM.notification.innerHTML = `
                <i class="fas ${types[type].icon}"></i> ${message}
            `;
            DOM.notification.style.backgroundColor = types[type].bg;
            DOM.notification.className = 'notification show';
            
            console.log(`üì¢ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ [${type}]: ${message}`);
            
            setTimeout(() => {
                DOM.notification.classList.remove('show');
            }, 4000);
        }

        // –≠–∫—Å–ø–æ—Ä—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫
        async function exportSettings() {
            try {
                showNotification('–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞...', 'info');
                
                const exportData = {
                    exportDate: new Date().toISOString(),
                    version: '2.0',
                    databaseStructure: 'workshop_settings',
                    settings: {
                        workshops: state.workshops,
                        machines: state.machines
                    }
                };

                const blob = new Blob([JSON.stringify(exportData, null, 2)], { 
                    type: 'application/json' 
                });
                
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `cnc_settings_${getFormattedDate()}.json`;
                
                document.body.appendChild(a);
                a.click();
                
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                console.log('üì§ –≠–∫—Å–ø–æ—Ä—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω');
                showNotification('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É—Å–ø–µ—à–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã', 'success');
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞:', error);
                showNotification('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫: ' + error.message, 'error');
            }
        }

        // –ò–º–ø–æ—Ä—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫
        async function importSettings() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                try {
                    showNotification('–ò–º–ø–æ—Ä—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫...', 'info');
                    
                    const text = await file.text();
                    let importData;
                    
                    try {
                        importData = JSON.parse(text);
                    } catch (parseError) {
                        throw new Error('–§–∞–π–ª –ø–æ–≤—Ä–µ–∂–¥–µ–Ω –∏–ª–∏ –∏–º–µ–µ—Ç –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç JSON');
                    }
                    
                    let settingsToImport;
                    
                    if (importData.settings) {
                        settingsToImport = importData.settings;
                    } else if (Array.isArray(importData.workshops) && Array.isArray(importData.machines)) {
                        settingsToImport = importData;
                    } else {
                        throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞');
                    }
                    
                    if (!Array.isArray(settingsToImport.workshops) || !Array.isArray(settingsToImport.machines)) {
                        throw new Error('–ù–µ–≤–µ—Ä–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –≤ —Ñ–∞–π–ª–µ');
                    }
                    
                    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏? –¢–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±—É–¥—É—Ç –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–Ω—ã.')) {
                        return;
                    }
                    
                    console.log('üì• –ò–º–ø–æ—Ä—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–∑ —Ñ–∞–π–ª–∞:', {
                        workshops: settingsToImport.workshops.length,
                        machines: settingsToImport.machines.length
                    });
                    
                    const response = await fetch('http://localhost:3004/api/settings/import', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ settings: settingsToImport })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || '–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞');
                    }
                    
                    const data = await response.json();
                    if (!data.success) throw new Error(data.message || '–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞');
                    
                    if (data.settings) {
                        updateApplicationState(data.settings);
                    } else {
                        await loadSettings();
                    }
                    
                    console.log('‚úÖ –ò–º–ø–æ—Ä—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω');
                    showNotification('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã', 'success');
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞:', error);
                    showNotification('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫: ' + error.message, 'error');
                }
            };
            
            input.click();
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞—Ç—ã
        function getFormattedDate() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day}_${hours}-${minutes}`;
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π
        async function loadBackupsList() {
            try {
                console.log('üìã –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π...');
                const response = await fetch('http://localhost:3004/api/settings/backups');
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error: ${response.status} - ${errorText}`);
                }
                
                const data = await response.json();
                if (!data.success) throw new Error('–û—à–∏–±–∫–∞ –≤ –¥–∞–Ω–Ω—ã—Ö');
                
                renderBackupsList(data.backups);
                console.log('‚úÖ –°–ø–∏—Å–æ–∫ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π –æ–±–Ω–æ–≤–ª–µ–Ω');
                showNotification('–°–ø–∏—Å–æ–∫ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π:', error);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π', 'error');
            }
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–ø–∏—Å–∫–∞ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π
        function renderBackupsList(backups) {
            if (!backups || backups.length === 0) {
                DOM.backupsList.innerHTML = '<p style="color: #666; font-style: italic;">–†–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
                return;
            }
            
            const list = document.createElement('div');
            list.className = 'backups-items';
            
            backups.forEach(backup => {
                const backupItem = document.createElement('div');
                backupItem.className = 'backup-item';
                backupItem.innerHTML = `
                    <div class="backup-info">
                        <strong>${backup.name}</strong>
                        <div class="backup-details">
                            <span>${new Date(backup.date).toLocaleString()}</span>
                            <span>${formatFileSize(backup.size)}</span>
                        </div>
                    </div>
                    <button class="btn btn-sm btn-success" onclick="restoreFromBackup('${backup.name}')">
                        <i class="fas fa-undo"></i> –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
                    </button>
                `;
                list.appendChild(backupItem);
            });
            
            DOM.backupsList.innerHTML = '';
            DOM.backupsList.appendChild(list);
        }

        // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏
        async function restoreFromBackup(filename) {
            if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ "${filename}"? –¢–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã.`)) {
                return;
            }
            
            try {
                showNotification('–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏...', 'info');
                
                console.log(`üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏: ${filename}`);
                const response = await fetch('http://localhost:3004/api/settings/restore', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ filename })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || '–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è');
                }
                
                const data = await response.json();
                if (!data.success) throw new Error(data.message || '–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è');
                
                if (data.settings) {
                    updateApplicationState(data.settings);
                } else {
                    await loadSettings();
                }
                
                console.log('‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–æ');
                showNotification('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É—Å–ø–µ—à–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∏–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏', 'success');
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è:', error);
                showNotification('–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è: ' + error.message, 'error');
            }
        }

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –°–¢–†–ê–ù–ò–¶–´ –ù–ê–°–¢–†–û–ï–ö...');
            console.log('üìä –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ë–î: workshop_settings + machine_workshop_assignment');
            loadSettings();
            loadBackupsList();
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden) {
                    console.log('üîÑ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å—Ç–∞–ª–∞ –∞–∫—Ç–∏–≤–Ω–æ–π, –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ...');
                    loadSettings();
                    loadBackupsList();
                }
            });
        });
    </script>
</body>
</html>