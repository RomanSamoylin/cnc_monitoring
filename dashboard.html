<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–∞—à–±–æ—Ä–¥—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="icon" type="image/x-icon" href="images/favicon.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="styles1.css">

</head>
<body>
    <header>
        <h1>–î–∞—à–±–æ—Ä–¥—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞</h1>
        <button class="logout-button" onclick="location.href='login.html'">
            <i class="fas fa-sign-out-alt"></i> –í—ã–π—Ç–∏
        </button>
    </header>
    
    <nav>
        <button class="active" onclick="location.href='dashboard.html'">
            <i class="fas fa-tachometer-alt"></i> –î–∞—à–±–æ—Ä–¥—ã
        </button>
        <button onclick="location.href='charts.html'">
            <i class="fas fa-chart-line"></i> –ì—Ä–∞—Ñ–∏–∫–∏ –∞–Ω–∞–ª–∏–∑–∞
        </button>
        <button onclick="location.href='reports.html'">
            <i class="fas fa-file-alt"></i> –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –æ—Ç—á–µ—Ç–æ–≤
        </button>
        <button onclick="location.href='settings.html'">
            <i class="fas fa-cog"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏
        </button>
    </nav>
    
    <div class="container">
        <div class="sidebar">
            <div class="filters">
                <h3><i class="fas fa-industry"></i> –¶–µ—Ö</h3>
                <select id="workshopFilter">
                    <option value="all">–í—Å–µ —Ü–µ—Ö–∞</option>
                    <option value="1">–¶–µ—Ö 1</option>
                    <option value="2">–¶–µ—Ö 2</option>
                </select>

                <h3><i class="fas fa-filter"></i> –§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞–Ω–∫–∞–º</h3>
                <select id="machineFilter">
                    <option value="all">–í—Å–µ —Å—Ç–∞–Ω–∫–∏</option>
                </select>

                <h3>–°—Ç–∞—Ç—É—Å —Å—Ç–∞–Ω–∫–æ–≤</h3>
                <div class="filter-group">
                    <button class="filter-btn active" data-status="all">–í—Å–µ</button>
                    <button class="filter-btn" data-status="working">
                        <i class="fas fa-circle" style="color: var(--working-color);"></i> –†–∞–±–æ—Ç–∞—é—Ç
                    </button>
                    <button class="filter-btn" data-status="stopped">
                        <i class="fas fa-circle" style="color: var(--stopped-color);"></i> –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
                    </button>
                    <button class="filter-btn" data-status="shutdown">
                        <i class="fas fa-circle" style="color: var(--shutdown-color);"></i> –í—ã–∫–ª—é—á–µ–Ω—ã
                    </button>
                </div>
            </div>
        </div>
        
        <div class="content" id="machineList">
            <div class="summary-card" id="summaryInfo">
                <div class="summary-item">
                    <span class="summary-label">–í—Å–µ–≥–æ —Å—Ç–∞–Ω–∫–æ–≤</span>
                    <span class="summary-value" id="totalMachines">0</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">–†–∞–±–æ—Ç–∞—é—Ç</span>
                    <span class="summary-value" id="workingMachines">0</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã</span>
                    <span class="summary-value" id="stoppedMachines">0</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">–í—ã–∫–ª—é—á–µ–Ω—ã</span>
                    <span class="summary-value" id="shutdownMachines">0</span>
                </div>
               
                <div class="summary-item">
                    <span class="summary-label">–°—Ç–∞—Ç—É—Å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</span>
                    <span class="summary-value" id="connectionStatus">
                        <i class="fas fa-circle-notch fa-spin"></i> –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...
                    </span>
                </div>
            </div>
            <!-- –ó–¥–µ—Å—å –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –∫–∞—Ä—Ç–æ—á–∫–∏ —Å—Ç–∞–Ω–∫–æ–≤ -->
        </div>
    </div>

    <div class="notification" id="notification">
        –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã
    </div>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        const config = {
            apiUrl: window.location.origin.replace(/:\d+$/, ':3000'),
            wsUrl: `ws://${window.location.hostname || 'localhost'}:8080`,
            settingsApiUrl: 'http://localhost:3004',
            refreshInterval: 20000,
            reconnectDelay: 5000,
            maxRetries: 3
        };

        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        const state = {
            machines: {},
            summary: {
                total: 0,
                working: 0,
                stopped: 0,
                shutdown: 0
            },
            filters: {
                workshop: 'all',
                machine: 'all',
                status: 'all'
            },
            ws: null,
            retryCount: 0,
            lastUpdate: null,
            isConnected: false,
            pollingInterval: null,
            charts: {}, // –î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ –≥—Ä–∞—Ñ–∏–∫–æ–≤
            distribution: { // –î–∞–Ω–Ω—ã–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫
                workshops: [],
                machines: [],
                machineToWorkshopMap: {}
            }
        };

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        function showNotification(message, isError = false) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = isError ? 'notification error show' : 'notification show';
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        /**
         * –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç–∞–Ω–∫–æ–≤ –ø–æ —Ü–µ—Ö–∞–º –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫
         */
        async function loadWorkshopDistribution() {
            try {
                console.log('üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å—Ç–∞–Ω–∫–æ–≤ –¥–ª—è –¥–∞—à–±–æ—Ä–¥–∞...');
                
                const response = await fetch(`${config.settingsApiUrl}/api/settings/distribution-data`);
                if (!response.ok) {
                    throw new Error(`HTTP error: ${response.status}`);
                }
                
                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.message || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è');
                }
                
                state.distribution = data.distribution;
                
                console.log('‚úÖ –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –¥–ª—è –¥–∞—à–±–æ—Ä–¥–∞:', {
                    workshops: state.distribution.workshops.length,
                    machines: state.distribution.machines.length,
                    workshopsList: state.distribution.workshops.map(w => `${w.name}(id:${w.id})`)
                });
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä —Ü–µ—Ö–æ–≤
                updateWorkshopsFilter();
                
                return true;
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–ª—è –¥–∞—à–±–æ—Ä–¥–∞:', error);
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                state.distribution = {
                    workshops: [
                        { id: 1, name: '–¶–µ—Ö 1' },
                        { id: 2, name: '–¶–µ—Ö 2' }
                    ],
                    machines: [],
                    machineToWorkshopMap: {}
                };
                
                updateWorkshopsFilter();
                showNotification('–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é', true);
                return false;
            }
        }

        /**
         * –û–±–Ω–æ–≤–ª—è–µ—Ç —Ñ–∏–ª—å—Ç—Ä —Ü–µ—Ö–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
         */
        function updateWorkshopsFilter() {
            const workshopFilter = document.getElementById('workshopFilter');
            const currentValue = workshopFilter.value;
            
            workshopFilter.innerHTML = '<option value="all">–í—Å–µ —Ü–µ—Ö–∞</option>';
            
            state.distribution.workshops.forEach(workshop => {
                const option = document.createElement('option');
                option.value = workshop.id;
                option.textContent = workshop.name;
                workshopFilter.appendChild(option);
            });
            
            if (currentValue && workshopFilter.querySelector(`option[value="${currentValue}"]`)) {
                workshopFilter.value = currentValue;
            }
            
            console.log('‚úÖ –§–∏–ª—å—Ç—Ä —Ü–µ—Ö–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω –≤ –¥–∞—à–±–æ—Ä–¥–µ');
        }

        /**
         * –ü–æ–ª—É—á–∞–µ—Ç —Ü–µ—Ö –¥–ª—è —Å—Ç–∞–Ω–∫–∞ –ø–æ –µ–≥–æ ID
         */
        function getWorkshopForMachine(machineId) {
            const workshopId = state.distribution.machineToWorkshopMap[machineId];
            if (workshopId) {
                const workshop = state.distribution.workshops.find(w => w.id === workshopId);
                return workshop ? workshop.name : '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω';
            }
            return '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω';
        }

        /**
         * –ü–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞–Ω–∫–∏ –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —Ü–µ—Ö–∞
         */
        function getMachinesForWorkshop(workshopId) {
            if (workshopId === 'all') {
                return state.distribution.machines;
            }
            return state.distribution.machines.filter(machine => 
                machine.workshopId === parseInt(workshopId)
            );
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WebSocket
        function initWebSocket() {
            if (!('WebSocket' in window)) {
                console.error('–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç WebSocket');
                showNotification('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç WebSocket', true);
                startPolling();
                return;
            }

            if (!config.wsUrl || !config.wsUrl.startsWith('ws://')) {
                console.error('–ù–µ–≤–µ—Ä–Ω—ã–π URL WebSocket:', config.wsUrl);
                showNotification('–û—à–∏–±–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', true);
                return;
            }

            console.log('–ü–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ WebSocket:', config.wsUrl);
            updateConnectionStatus('connecting');
            
            try {
                state.ws = new WebSocket(config.wsUrl);

                state.ws.onopen = () => {
                    console.log('WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω');
                    state.isConnected = true;
                    state.retryCount = 0;
                    updateConnectionStatus('connected');
                    showNotification('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–æ–º —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
                    
                    if (state.pollingInterval) {
                        clearInterval(state.pollingInterval);
                        state.pollingInterval = null;
                    }
                };

                state.ws.onmessage = (event) => {
                    try {
                        const message = JSON.parse(event.data);
                        console.log('–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ:', message.type, '–≤', new Date().toLocaleTimeString());
                        
                        if (message.type === 'PONG') {
                            console.log('–ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
                            return;
                        }
                        
                        if (message.type === 'INITIAL_DATA' || message.type === 'UPDATE') {
                            console.log('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å—Ç–∞–Ω–∫–æ–≤:', Object.keys(message.data).length, '—Å—Ç–∞–Ω–∫–æ–≤');
                            processMachineData(message.data);
                            updateLastUpdateTime(message.timestamp || new Date().toISOString());
                        }
                    } catch (e) {
                        console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', e);
                    }
                };

                state.ws.onclose = (event) => {
                    console.log(`WebSocket –∑–∞–∫—Ä—ã—Ç. –ö–æ–¥: ${event.code}, –ü—Ä–∏—á–∏–Ω–∞: ${event.reason}`);
                    state.isConnected = false;
                    updateConnectionStatus('disconnected');
                    
                    if (state.retryCount < config.maxRetries) {
                        state.retryCount++;
                        const delay = config.reconnectDelay * state.retryCount;
                        console.log(`–ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è ${state.retryCount}/${config.maxRetries} —á–µ—Ä–µ–∑ ${delay}–º—Å`);
                        showNotification(`–ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ (${state.retryCount}/${config.maxRetries})...`, true);
                        setTimeout(initWebSocket, delay);
                    } else {
                        console.log('–î–æ—Å—Ç–∏–≥–Ω—É—Ç–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
                        showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É', true);
                        startPolling();
                    }
                };

                state.ws.onerror = (error) => {
                    console.error('WebSocket –æ—à–∏–±–∫–∞:', error);
                    updateConnectionStatus('error');
                    state.ws.close();
                };

            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è WebSocket:', e);
                showNotification('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', true);
                startPolling();
            }
        }

        // –†–µ–∑–µ—Ä–≤–Ω—ã–π polling –º–µ—Ö–∞–Ω–∏–∑–º
        function startPolling() {
            console.log('–ê–∫—Ç–∏–≤–∞—Ü–∏—è HTTP polling');
            updateConnectionStatus('polling');
            
            if (state.pollingInterval) {
                clearInterval(state.pollingInterval);
            }
            
            fetchData();
            
            state.pollingInterval = setInterval(fetchData, config.refreshInterval);
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        function updateConnectionStatus(status) {
            const statusElement = document.getElementById('connectionStatus');
            let icon, text, color;
            
            switch(status) {
                case 'connected':
                    icon = 'fa-check-circle';
                    text = '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
                    color = 'var(--working-color)';
                    break;
                case 'connecting':
                    icon = 'fa-circle-notch fa-spin';
                    text = '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';
                    color = 'var(--warning-color)';
                    break;
                case 'disconnected':
                    icon = 'fa-times-circle';
                    text = '–û—Ç–∫–ª—é—á–µ–Ω–æ';
                    color = 'var(--stopped-color)';
                    break;
                case 'error':
                    icon = 'fa-exclamation-circle';
                    text = '–û—à–∏–±–∫–∞';
                    color = 'var(--stopped-color)';
                    break;
                case 'polling':
                    icon = 'fa-sync-alt fa-spin';
                    text = 'Polling —Ä–µ–∂–∏–º';
                    color = 'var(--warning-color)';
                    break;
                default:
                    icon = 'fa-question-circle';
                    text = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                    color = 'var(--shutdown-color)';
            }
            
            statusElement.innerHTML = `
                <i class="fas ${icon}" style="color: ${color};"></i> ${text}
            `;
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        function updateLastUpdateTime(timestamp) {
            state.lastUpdate = new Date(timestamp);
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ HTTP (—Ä–µ–∑–µ—Ä–≤–Ω—ã–π –º–µ—Ç–æ–¥)
        async function fetchData() {
            try {
                console.log('–ó–∞–ø—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ HTTP API');
                const response = await fetch(`${config.apiUrl}/api/machines`);
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
                
                const data = await response.json();
                console.log('–ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ:', data);
                
                if (data.success) {
                    processMachineData(data.machines);
                    updateLastUpdateTime(new Date().toISOString());
                    if (!data.fromCache) {
                        showNotification('–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã');
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö:', error);
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö', true);
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å—Ç–∞–Ω–∫–æ–≤
        function processMachineData(machinesData) {
            console.log('–û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è', Object.keys(machinesData).length, '—Å—Ç–∞–Ω–∫–æ–≤');
            state.machines = machinesData;
            updateSummary();
            populateFilters();
            renderMachines();
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –∫—Ä—É–≥–æ–≤–æ–π –¥–∏–∞–≥—Ä–∞–º–º—ã —Ä–∞–±–æ—Ç—ã —Å—Ç–∞–Ω–∫–∞
        function createWorkingTimeChart(canvasId, workingTimeData) {
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –≥—Ä–∞—Ñ–∏–∫, –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            if (state.charts[canvasId]) {
                state.charts[canvasId].destroy();
            }
            
            const ctx = document.getElementById(canvasId).getContext('2d');
            state.charts[canvasId] = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['–†–∞–±–æ—Ç–∞–µ—Ç', '–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω', '–í—ã–∫–ª—é—á–µ–Ω'],
                    datasets: [{
                        data: [
                            workingTimeData.workingMinutes || 0,
                            workingTimeData.stoppedMinutes || 0,
                            workingTimeData.shutdownMinutes || 0
                        ],
                        backgroundColor: [
                            'rgba(46, 204, 113, 0.8)', // –ó–µ–ª–µ–Ω—ã–π –¥–ª—è "–†–∞–±–æ—Ç–∞–µ—Ç"
                            'rgba(231, 76, 60, 0.8)',   // –ö—Ä–∞—Å–Ω—ã–π –¥–ª—è "–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
                            'rgba(149, 165, 166, 0.8)'  // –°–µ—Ä—ã–π –¥–ª—è "–í—ã–∫–ª—é—á–µ–Ω"
                        ],
                        borderColor: [
                            'rgba(46, 204, 113, 1)',
                            'rgba(231, 76, 60, 1)',
                            'rgba(149, 165, 166, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${context.raw} –º–∏–Ω`;
                                }
                            }
                        }
                    },
                    cutout: '70%'
                }
            });
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ —Ä–∞–±–æ—Ç—ã –ø–æ —á–∞—Å–∞–º
        function createDailyChart(canvasId, chartData) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            const chartKey = `${canvasId}-daily`;
            
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –≥—Ä–∞—Ñ–∏–∫, –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            if (state.charts[chartKey]) {
                state.charts[chartKey].destroy();
            }
            
            state.charts[chartKey] = new Chart(ctx, {
                type: 'bar',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: true,
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '–ú–∏–Ω—É—Ç—ã'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.raw} –º–∏–Ω`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ/–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
        function saveFilters() {
            state.filters = {
                workshop: document.getElementById('workshopFilter').value,
                machine: document.getElementById('machineFilter').value,
                status: document.querySelector('.filter-btn[data-status].active')?.dataset.status || 'all'
            };
        }

        function restoreFilters() {
            document.getElementById('workshopFilter').value = state.filters.workshop;
            document.getElementById('machineFilter').value = state.filters.machine;
            
            document.querySelectorAll('.filter-btn[data-status]').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const statusBtn = document.querySelector(`.filter-btn[data-status="${state.filters.status}"]`);
            if (statusBtn) {
                statusBtn.classList.add('active');
            } else {
                document.querySelector('.filter-btn[data-status="all"]').classList.add('active');
                state.filters.status = 'all';
            }
        }

        // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
        function populateFilters() {
            const workshopFilter = document.getElementById('workshopFilter');
            const machineFilter = document.getElementById('machineFilter');
            
            const currentWorkshop = workshopFilter.value;
            const currentMachine = machineFilter.value;
            
            machineFilter.innerHTML = '<option value="all">–í—Å–µ —Å—Ç–∞–Ω–∫–∏</option>';
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
            const selectedWorkshop = workshopFilter.value;
            let machinesToShow = [];
            
            if (selectedWorkshop === 'all') {
                machinesToShow = state.distribution.machines;
            } else {
                machinesToShow = state.distribution.machines.filter(machine => 
                    machine.workshopId === parseInt(selectedWorkshop)
                );
            }
            
            machinesToShow.forEach(machine => {
                const option = document.createElement('option');
                option.value = machine.id;
                option.textContent = `${machine.name} (ID: ${machine.id})`;
                machineFilter.appendChild(option);
            });

            if (currentMachine && machineFilter.querySelector(`option[value="${currentMachine}"]`)) {
                machineFilter.value = currentMachine;
            }
        }

        // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
        function applyFilters() {
            saveFilters();
            updateMachinesDisplay();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–∞–Ω–∫–æ–≤
        function updateMachinesDisplay() {
            const cards = document.querySelectorAll('.machine-card');
            if (cards.length === 0) return;

            cards.forEach(card => {
                const cardMachineId = parseInt(card.id.split('-')[1]);
                const machine = state.machines[cardMachineId];
                if (!machine) return;

                // –û–ë–ù–û–í–õ–ï–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫
                const workshopId = state.distribution.machineToWorkshopMap[machine.internalId];
                
                const workshopMatch = state.filters.workshop === 'all' || 
                                     workshopId === parseInt(state.filters.workshop);
                const machineMatch = state.filters.machine === 'all' || 
                                    cardMachineId.toString() === state.filters.machine;
                const statusMatch = state.filters.status === 'all' || 
                                   machine.status === state.filters.status;
                
                card.style.display = (workshopMatch && machineMatch && statusMatch) ? 'block' : 'none';
            });

            updateFilteredSummary();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–≤–æ–¥–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
        function updateSummary() {
            const machines = Object.values(state.machines);
            
            state.summary = {
                total: machines.length,
                working: machines.filter(m => m.status === 'working').length,
                stopped: machines.filter(m => m.status === 'stopped').length,
                shutdown: machines.filter(m => m.status === 'shutdown').length
            };
        }

        function updateFilteredSummary() {
            const filteredMachines = Object.values(state.machines).filter(machine => {
                // –û–ë–ù–û–í–õ–ï–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫
                const workshopId = state.distribution.machineToWorkshopMap[machine.internalId];
                
                const workshopMatch = state.filters.workshop === 'all' || 
                                     workshopId === parseInt(state.filters.workshop);
                const machineMatch = state.filters.machine === 'all' || 
                                    machine.internalId.toString() === state.filters.machine;
                const statusMatch = state.filters.status === 'all' || 
                                   machine.status === state.filters.status;
                
                return workshopMatch && machineMatch && statusMatch;
            });

            document.getElementById('totalMachines').textContent = filteredMachines.length;
            document.getElementById('workingMachines').textContent = filteredMachines.filter(m => m.status === 'working').length;
            document.getElementById('stoppedMachines').textContent = filteredMachines.filter(m => m.status === 'stopped').length;
            document.getElementById('shutdownMachines').textContent = filteredMachines.filter(m => m.status === 'shutdown').length;
        }

        function getSystemStateText(value) {
            const states = {
                1: 'IDLE',
                2: 'RUN',
                3: 'HOLD',
                4: 'RUNH',
                5: 'RESE',
                6: 'RTSE'
            };
            return states[value] || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å—Ç–∞–Ω–∫–æ–≤
        function renderMachines() {
            const container = document.getElementById('machineList');
            const summaryCard = document.getElementById('summaryInfo');
            container.innerHTML = '';
            container.appendChild(summaryCard);

            const sortedMachines = Object.values(state.machines).sort((a, b) => a.internalId - b.internalId);
            
            sortedMachines.forEach(machine => {
                const card = document.createElement('div');
                card.className = `machine-card ${machine.status}`;
                card.id = `machine-${machine.internalId}`;
                
                // –û–ë–ù–û–í–õ–ï–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫
                const workshopName = getWorkshopForMachine(machine.internalId);
                
                const formatParam = (value) => {
                    if (value === null || value === undefined) return '‚Äî';
                    if (Number.isInteger(value)) return value.toString();
                    return value.toFixed(2);
                };

                card.innerHTML = `
                    <div class="machine-header">
                        <div class="machine-name">${machine.displayName}</div>
                        <div class="machine-status">
                            <span class="status-indicator ${machine.status}"></span>
                            ${machine.statusText}
                        </div>
                    </div>
                    <div class="machine-details">
                        <div>ID: ${machine.internalId}</div>
                        <div>–¶–µ—Ö: ${workshopName}</div> <!-- –û–ë–ù–û–í–õ–ï–ù–û -->
                        <div class="last-update">–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${new Date(machine.lastUpdate).toLocaleTimeString()}</div>
                    </div>
                    <div class="machine-params">
                        <div class="param-item">
                            <span class="param-label">–ü–æ–¥–∞—á–∞:</span>
                            <span class="param-value">${formatParam(machine.params.feedRate)}</span>
                        </div>
                        <div class="param-item">
                            <span class="param-label">–°–∫–æ—Ä–æ—Å—Ç—å —à–ø–∏–Ω–¥–µ–ª—è:</span>
                            <span class="param-value">${formatParam(machine.params.spindleSpeed)}</span>
                        </div>
                        <div class="param-item">
                            <span class="param-label">JOG:</span>
                            <span class="param-value">${formatParam(machine.params.jogSwitch)}</span>
                        </div>
                        <div class="param-item">
                            <span class="param-label">–ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å F:</span>
                            <span class="param-value">${formatParam(machine.params.fSwitch)}</span>
                        </div>
                        <div class="param-item">
                            <span class="param-label">–ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å S:</span>
                            <span class="param-value">${formatParam(machine.params.sSwitch)}</span>
                        </div>
                        <div class="param-item">
                            <span class="param-label">–ú–æ—â–Ω–æ—Å—Ç—å —à–ø–∏–Ω–¥–µ–ª—è:</span>
                            <span class="param-value">${formatParam(machine.params.spindlePower)}</span>
                        </div>
                    </div>
                    <div class="machine-chart-container">
                        <div class="chart-title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–∞–±–æ—Ç—ã –∑–∞ —Å–µ–≥–æ–¥–Ω—è</div>
                        <div class="chart-row">
                            <div class="chart-half">
                                <canvas id="chart-${machine.internalId}" class="machine-chart"></canvas>
                            </div>
                            <div class="chart-half">
                                <canvas id="daily-chart-${machine.internalId}" class="machine-chart"></canvas>
                            </div>
                        </div>
                        <div class="time-stats">
                            <div class="time-stat working">
                                <i class="fas fa-circle"></i> –†–∞–±–æ—Ç–∞–µ—Ç: ${machine.workingTime?.workingMinutes || 0} –º–∏–Ω
                            </div>
                            <div class="time-stat stopped">
                                <i class="fas fa-circle"></i> –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: ${machine.workingTime?.stoppedMinutes || 0} –º–∏–Ω
                            </div>
                            <div class="time-stat shutdown">
                                <i class="fas fa-circle"></i> –í—ã–∫–ª—é—á–µ–Ω: ${machine.workingTime?.shutdownMinutes || 0} –º–∏–Ω
                            </div>
                            <div class="machine-program">
                                <div class="program-item">
                                    <span class="program-label">–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã:</span>
                                    <span class="program-value">${machine.currentProgram}</span>
                                </div>
                                <div class="param-item">
                                    <span class="param-label">–†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã:</span>
                                    <span class="param-value">${machine.operationMode || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</span>
                                </div>
                                <div class="param-item">
                                    <span class="param-label">–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã:</span>
                                    <span class="param-value">${getSystemStateText(machine.systemState)}</span>
                                </div>
                                <div class="param-item">
                                    <span class="param-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ—Ç–∞–ª–µ–π –∑–∞ —Å–µ–≥–æ–¥–Ω—è:</span>
                                    <span class="param-value">${machine.partsCount}</span>
                                </div>
                            </div>
                            <div class="machine-params">
                                <div class="param-item">
                                    <span class="param-label">–ù–æ–º–µ—Ä –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞:</span>
                                    <span class="param-value">${machine.toolNumber}</span>
                                </div>
                                <div class="param-item">
                                    <span class="param-label">–ù–æ–º–µ—Ä –∫–æ—Ä—Ä–µ–∫—Ç–æ—Ä–∞:</span>
                                    <span class="param-value">${machine.correctorNumber}</span>
                                </div>
                            </div>
                            <div class="machine-errors">
                                <div class="error-header">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    –ü–æ—Å–ª–µ–¥–Ω—è—è –æ—à–∏–±–∫–∞:
                                </div>
                                ${machine.lastError ? `
                                    <div class="error-item">
                                        <span class="error-message">${machine.lastError.message}</span>
                                        <span class="error-time">${new Date(machine.lastError.timestamp).toLocaleString()}</span>
                                    </div>
                                ` : `
                                    <div class="no-errors">–û—à–∏–±–æ–∫ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ</div>
                                `}
                            </div>
                        </div>
                    </div>
                `;
                
                container.appendChild(card);
                
                // –°–æ–∑–¥–∞–µ–º –≥—Ä–∞—Ñ–∏–∫–∏ –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ DOM
                setTimeout(() => {
                    if (machine.workingTime) {
                        createWorkingTimeChart(`chart-${machine.internalId}`, machine.workingTime);
                        if (machine.workingTime.chartData) {
                            createDailyChart(`daily-chart-${machine.internalId}`, machine.workingTime.chartData);
                        }
                    }
                }, 0);
            });
            
            applyFilters();
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
        function startDistributionRefresh() {
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 2 –º–∏–Ω—É—Ç—ã
            setInterval(async () => {
                console.log('üîÑ –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è...');
                await loadWorkshopDistribution();
            }, 120000); // 2 –º–∏–Ω—É—Ç—ã
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞—à–±–æ—Ä–¥–∞...');
            
            // –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ, –ø–æ—Ç–æ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º WebSocket
            try {
                await loadWorkshopDistribution();
                console.log('‚úÖ –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ, –∑–∞–ø—É—Å–∫ WebSocket...');
                initWebSocket();
                startDistributionRefresh();
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è', true);
                // –í—Å–µ —Ä–∞–≤–Ω–æ –∑–∞–ø—É—Å–∫–∞–µ–º WebSocket —Å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                initWebSocket();
            }
            
            document.getElementById('workshopFilter').addEventListener('change', applyFilters);
            document.getElementById('machineFilter').addEventListener('change', applyFilters);

            document.querySelectorAll('.filter-btn[data-status]').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.filter-btn[data-status]').forEach(b => 
                        b.classList.remove('active'));
                    this.classList.add('active');
                    applyFilters();
                });
            });
        });
    </script>
</body>
</html>