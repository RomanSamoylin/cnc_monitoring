<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Графики анализа станков</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment"></script>
    <link rel="icon" type="image/x-icon" href="images/favicon.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="styles2.css">
    <style>
        /* Основные стили контейнера */
        .container {
            display: flex;
            min-height: calc(100vh - 120px);
            width: 100%;
        }

        /* Стили для графиков */
        .chart-container {
            width: 100%;
            height: 400px;
            margin-bottom: 30px;
            position: relative;
        }

        canvas {
            width: 100% !important;
            height: 100% !important;
        }

        /* Стили для уведомлений */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 5px;
            color: white;
            display: none;
            z-index: 1000;
            max-width: 300px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            font-size: 14px;
        }

        .notification.show {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }

        .notification.success {
            background-color: #2ecc71;
        }

        .notification.error {
            background-color: #e74c3c;
        }

        .notification.loading {
            background-color: #3498db;
        }

        /* Анимация для уведомлений */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Стили для индикатора загрузки */
        #loading-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Стили для заголовков графиков */
        .chart-title {
            margin-bottom: 15px;
            font-size: 18px;
            color: #333;
            font-weight: 600;
        }

        /* Стили для фильтров */
        select, input[type="date"] {
            width: 100%;
            padding: 8px 12px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }

        /* Стили для кнопки применения фильтров */
        .filter-btn {
            width: 100%;
            padding: 10px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: background-color 0.2s;
        }

        .filter-btn:hover {
            background-color: #2980b9;
        }

        /* Стили для сетки графиков */
        .charts-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        /* Адаптивные стили */
        @media (max-width: 1200px) {
            .container {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid #ddd;
            }
            .charts-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Шапка страницы -->
    <header>
        <h1>Графики анализа станков</h1>
        <button class="logout-button" onclick="location.href='login.html'">
            <i class="fas fa-sign-out-alt"></i> Выйти
        </button>
    </header>
    
    <!-- Навигационное меню -->
    <nav>
        <button onclick="location.href='dashboard.html'">
            <i class="fas fa-tachometer-alt"></i> Дашборды
        </button>
        <button class="active" onclick="location.href='charts.html'">
            <i class="fas fa-chart-line"></i> Графики анализа
        </button>
        <button onclick="location.href='reports.html'">
            <i class="fas fa-file-alt"></i> Конструктор отчетов
        </button>
        <button onclick="location.href='settings.html'">
            <i class="fas fa-cog"></i> Настройки
        </button>
    </nav>
    
    <!-- Основной контейнер -->
    <div class="container">
        <!-- Боковая панель с фильтрами -->
        <div class="sidebar">
            <h3><i class="fas fa-industry"></i> Цех</h3>
            <select id="workshopFilter">
                <option value="all">Все цеха</option>
                <option value="1">Цех 1</option>
                <option value="2">Цех 2</option>
            </select>
            
            <h3><i class="fas fa-filter"></i> Фильтр по станкам</h3>
            <select id="machineFilter">
                <option value="all">Все станки</option>
            </select>
            
            <h3><i class="fas fa-calendar-alt"></i> Период</h3>
            <div class="period-buttons">
                <button class="active" onclick="setPeriod('day')"><i class="fas fa-calendar-day"></i> День</button>
                <button onclick="setPeriod('week')"><i class="fas fa-calendar-week"></i> Неделя</button>
                <button onclick="setPeriod('month')"><i class="fas fa-calendar"></i> Месяц</button>
                <button onclick="setPeriod('year')"><i class="fas fa-calendar"></i> Год</button>
            </div>
            
            <div>
                <label for="startDate"><i class="fas fa-clock"></i> Начальная дата:</label>
                <input type="date" id="startDate">
            </div>
            <div>
                <label for="endDate"><i class="fas fa-clock"></i> Конечная дата:</label>
                <input type="date" id="endDate">
            </div>
            
            <button id="applyFilters" class="filter-btn">
                <i class="fas fa-filter"></i> Применить фильтры
            </button>
        </div>
        
        <!-- Основное содержимое -->
        <div class="content">
            <!-- Графики для режима просмотра цехов -->
            <div id="workshopCharts" class="charts-row">
                <div class="chart-container">
                    <h3 class="chart-title" id="pieChartTitle">Состояние станков (круговая диаграмма)</h3>
                    <canvas id="pieChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title" id="barChartTitle">Работа станков по часам</h3>
                    <canvas id="barChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title" id="horizontalBarChartTitle">Состояние станков (горизонтальные столбцы)</h3>
                    <canvas id="horizontalBarChart"></canvas>
                </div>
            </div>
            
            <!-- Графики для режима просмотра отдельных станков -->
            <div id="individualCharts" style="display: none;">
                <div class="chart-container">
                    <h3 class="chart-title" id="chartTitle">Состояние станков</h3>
                    <canvas id="machineStatusChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title" id="timelineChartTitle">График изменения состояния</h3>
                    <canvas id="timelineChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Уведомления -->
    <div class="notification" id="notification"></div>
    
    <!-- Основной JavaScript код -->
    <script>
        // Базовый URL API аналитики
        const API_BASE_URL = 'http://localhost:3001';
        
        // Константы для состояний станков (совместимые с dashboard.html)
        const STATUS = {
            WORKING: 'working',
            STOPPED: 'stopped',
            SHUTDOWN: 'shutdown'
        };
        
        // Цвета для разных состояний
        const STATUS_COLORS = {
            [STATUS.WORKING]: '#2ecc71',
            [STATUS.STOPPED]: '#e74c3c',
            [STATUS.SHUTDOWN]: '#95a5a6'
        };
        
        // Названия состояний
        const STATUS_LABELS = {
            [STATUS.WORKING]: 'Работает',
            [STATUS.STOPPED]: 'Остановлено',
            [STATUS.SHUTDOWN]: 'Выключено'
        };
        
        // Текущий выбранный период
        let currentPeriod = 'day';
        let currentViewMode = 'workshop';
        
        // Данные о станках
        let machinesList = [];
        let workshopData = {
            '1': { working: 0, stopped: 0, shutdown: 0 },
            '2': { working: 0, stopped: 0, shutdown: 0 }
        };
        
        // Объекты графиков
        let pieChart, barChart, horizontalBarChart, machineStatusChart, timelineChart;
        
        // DOM элементы
        const DOM = {
            workshopFilter: document.getElementById('workshopFilter'),
            machineFilter: document.getElementById('machineFilter'),
            notification: document.getElementById('notification'),
            startDate: document.getElementById('startDate'),
            endDate: document.getElementById('endDate'),
            applyFilters: document.getElementById('applyFilters'),
            workshopCharts: document.getElementById('workshopCharts'),
            individualCharts: document.getElementById('individualCharts')
        };

        /**
         * Показывает уведомление
         * @param {string} message - Текст сообщения
         * @param {string} type - Тип уведомления (success, error, loading)
         * @param {number} [duration=3000] - Время показа в миллисекундах
         */
        function showNotification(message, type = 'success', duration = 3000) {
            // Очищаем предыдущее уведомление
            DOM.notification.innerHTML = '';
            
            // Создаем содержимое уведомления
            const content = document.createElement('div');
            content.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : 
                                  type === 'error' ? 'fa-exclamation-circle' : 
                                  'fa-spinner fa-spin'}"></i>
                <span>${message}</span>
            `;
            
            // Устанавливаем классы и стили
            DOM.notification.className = `notification show ${type}`;
            DOM.notification.appendChild(content);
            
            // Автоматическое скрытие для не-loading уведомлений
            if (type !== 'loading') {
                setTimeout(() => {
                    DOM.notification.classList.remove('show');
                }, duration);
            }
        }

        /**
         * Показывает индикатор загрузки
         * @param {string} [message='Загрузка данных...'] - Текст сообщения
         */
        function showLoadingIndicator(message = 'Загрузка данных...') {
            showNotification(message, 'loading', 0);
        }

        /**
         * Скрывает индикатор загрузки
         */
        function hideLoadingIndicator() {
            if (DOM.notification.classList.contains('loading')) {
                DOM.notification.classList.remove('show');
                setTimeout(() => {
                    DOM.notification.className = 'notification';
                    DOM.notification.innerHTML = '';
                }, 300);
            }
        }

        /**
         * Обработчик ответов от API
         * @param {Response} response - Объект ответа fetch
         * @returns {Promise<object>} - Распарсенные данные
         * @throws {Error} - Если ответ не успешный
         */
        async function handleApiResponse(response) {
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP error! status: ${response.status}, details: ${errorText}`);
            }
            
            const data = await response.json();
            
            if (!data.success) {
                throw new Error(data.error || 'Неизвестная ошибка сервера');
            }
            
            return data;
        }

        /**
         * Проверяет, является ли дата сегодняшним днем
         * @param {string} dateString - Дата в формате YYYY-MM-DD
         * @returns {boolean} - true если дата сегодняшняя
         */
        function isToday(dateString) {
            const today = new Date();
            const todayFormatted = today.toISOString().split('T')[0];
            return dateString === todayFormatted;
        }

        /**
         * Обрезает данные часового графика до текущего часа для сегодняшней даты
         * @param {object} chartData - Данные графика
         * @param {string} date - Дата в формате YYYY-MM-DD
         * @returns {object} - Обновленные данные графика
         */
        function truncateToCurrentHour(chartData, date) {
            if (!isToday(date)) {
                return chartData;
            }
            
            const currentHour = new Date().getHours();
            
            // Обрезаем метки и данные до текущего часа
            chartData.labels = chartData.labels.slice(0, currentHour + 1);
            
            chartData.datasets.forEach(dataset => {
                dataset.data = dataset.data.slice(0, currentHour + 1);
            });
            
            return chartData;
        }

        /**
         * Инициализирует все графики на странице
         */
        function initCharts() {
            console.log('Инициализация графиков...');
            
            // 1. Круговая диаграмма (статусы станков)
            const pieCtx = document.getElementById('pieChart').getContext('2d');
            pieChart = new Chart(pieCtx, {
                type: 'pie',
                data: {
                    labels: Object.values(STATUS_LABELS),
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: [
                            STATUS_COLORS[STATUS.WORKING],
                            STATUS_COLORS[STATUS.STOPPED],
                            STATUS_COLORS[STATUS.SHUTDOWN]
                        ],
                        borderColor: '#fff',
                        borderWidth: 1,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            position: 'top',
                            labels: {
                                padding: 20,
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                    return `${label}: ${value.toFixed(1)} ч (${percentage}%)`;
                                }
                            }
                        }
                    },
                    animation: {
                        animateScale: true,
                        animateRotate: true
                    }
                }
            });
            
            // 2. Вертикальная столбчатая диаграмма (почасовые данные)
            const barCtx = document.getElementById('barChart').getContext('2d');
            barChart = new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                    datasets: [
                        {
                            label: STATUS_LABELS[STATUS.WORKING],
                            data: Array(24).fill(0),
                            backgroundColor: 'rgba(46, 204, 113, 0.7)',
                            borderColor: 'rgba(46, 204, 113, 1)',
                            borderWidth: 1,
                            borderRadius: 3
                        },
                        {
                            label: STATUS_LABELS[STATUS.STOPPED],
                            data: Array(24).fill(0),
                            backgroundColor: 'rgba(231, 76, 60, 0.7)',
                            borderColor: 'rgba(231, 76, 60, 1)',
                            borderWidth: 1,
                            borderRadius: 3
                        },
                        {
                            label: STATUS_LABELS[STATUS.SHUTDOWN],
                            data: Array(24).fill(0),
                            backgroundColor: 'rgba(149, 165, 166, 0.7)',
                            borderColor: 'rgba(149, 165, 166, 1)',
                            borderWidth: 1,
                            borderRadius: 3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { 
                            stacked: true,
                            title: {
                                display: true,
                                text: 'Часы',
                                padding: {top: 10}
                            },
                            grid: {
                                display: false
                            }
                        },
                        y: { 
                            stacked: true,
                            title: { 
                                display: true, 
                                text: 'Минуты',
                                padding: {bottom: 10}
                            },
                            beginAtZero: true,
                            ticks: {
                                stepSize: 30
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.raw} мин`;
                                },
                                footer: function(context) {
                                    const total = context[0].parsed._stacks.y[context[0].datasetIndex];
                                    return `Всего: ${total} мин`;
                                }
                            }
                        },
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 12,
                                padding: 20
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
            
            // 3. Горизонтальная столбчатая диаграмма (сравнение цехов)
            const horizontalBarCtx = document.getElementById('horizontalBarChart').getContext('2d');
            horizontalBarChart = new Chart(horizontalBarCtx, {
                type: 'bar',
                data: {
                    labels: ['ЦЕХ-1', 'ЦЕХ-2'],
                    datasets: [
                        {
                            label: STATUS_LABELS[STATUS.SHUTDOWN],
                            data: [0, 0],
                            backgroundColor: STATUS_COLORS[STATUS.SHUTDOWN],
                            borderColor: STATUS_COLORS[STATUS.SHUTDOWN],
                            borderWidth: 1,
                            borderRadius: 3
                        },
                        {
                            label: STATUS_LABELS[STATUS.STOPPED],
                            data: [0, 0],
                            backgroundColor: STATUS_COLORS[STATUS.STOPPED],
                            borderColor: STATUS_COLORS[STATUS.STOPPED],
                            borderWidth: 1,
                            borderRadius: 3
                        },
                        {
                            label: STATUS_LABELS[STATUS.WORKING],
                            data: [0, 0],
                            backgroundColor: STATUS_COLORS[STATUS.WORKING],
                            borderColor: STATUS_COLORS[STATUS.WORKING],
                            borderWidth: 1,
                            borderRadius: 3
                        }
                    ]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { 
                            stacked: true,
                            title: {
                                display: true,
                                text: 'Часы работы',
                                padding: {top: 10}
                            }
                        },
                        y: { 
                            stacked: true,
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.raw.toFixed(1)} ч`;
                                }
                            }
                        },
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 12,
                                padding: 20
                            }
                        }
                    }
                }
            });
            
            // 4. График статусов для отдельного станка
            const machineCtx = document.getElementById('machineStatusChart').getContext('2d');
            machineStatusChart = new Chart(machineCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: STATUS_LABELS[STATUS.SHUTDOWN],
                            data: [],
                            backgroundColor: STATUS_COLORS[STATUS.SHUTDOWN],
                            borderColor: STATUS_COLORS[STATUS.SHUTDOWN],
                            borderWidth: 1,
                            borderRadius: 3
                        },
                        {
                            label: STATUS_LABELS[STATUS.STOPPED],
                            data: [],
                            backgroundColor: STATUS_COLORS[STATUS.STOPPED],
                            borderColor: STATUS_COLORS[STATUS.STOPPED],
                            borderWidth: 1,
                            borderRadius: 3
                        },
                        {
                            label: STATUS_LABELS[STATUS.WORKING],
                            data: [],
                            backgroundColor: STATUS_COLORS[STATUS.WORKING],
                            borderColor: STATUS_COLORS[STATUS.WORKING],
                            borderWidth: 1,
                            borderRadius: 3
                        }
                    ]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { 
                            stacked: true,
                            title: {
                                display: true,
                                text: 'Часы работы',
                                padding: {top: 10}
                            }
                        },
                        y: { 
                            stacked: true,
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.raw.toFixed(1)} ч`;
                                }
                            }
                        },
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 12,
                                padding: 20
                            }
                        }
                    }
                }
            });
            
            // 5. График временной шкалы для отдельного станка
            const timelineCtx = document.getElementById('timelineChart').getContext('2d');
            timelineChart = new Chart(timelineCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Статус станка',
                            data: [],
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.1,
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            pointBackgroundColor: '#3498db'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            min: 0,
                            max: 2,
                            ticks: {
                                callback: function(value) {
                                    return STATUS_LABELS[Object.keys(STATUS_LABELS)[value]];
                                },
                                stepSize: 1
                            },
                            title: {
                                display: true,
                                text: 'Статус'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Время'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return STATUS_LABELS[Object.keys(STATUS_LABELS)[context.raw]];
                                }
                            }
                        },
                        legend: {
                            display: false
                        }
                    }
                }
            });
            
            console.log('Все графики инициализированы');
        }
        
        /**
         * Загружает список станков с сервера
         */
        async function loadMachineList() {
            try {
                showLoadingIndicator('Загрузка списка станков...');
                console.log('Загрузка списка станков...');
                
                const response = await fetch(`${API_BASE_URL}/api/machines`);
                const data = await handleApiResponse(response);
                
                machinesList = Object.entries(data.machines).map(([id, machine]) => ({
                    id,
                    name: machine.name,
                    workshop: machine.workshop
                }));
                
                console.log('Получен список станков:', machinesList);
                updateMachineFilter();
                
            } catch (error) {
                console.error('Ошибка загрузки списка станков:', error);
                showNotification(`Ошибка загрузки списка станков: ${error.message}`, 'error');
            } finally {
                hideLoadingIndicator();
            }
        }
        
        /**
         * Обновляет фильтр станков на основе выбранного цеха
         */
        function updateMachineFilter() {
            console.log('Обновление фильтра станков...');
            
            // Сохраняем текущее выбранное значение
            const currentMachine = DOM.machineFilter.value;
            
            // Очищаем список
            DOM.machineFilter.innerHTML = '<option value="all">Все станки</option>';
            
            const selectedWorkshop = DOM.workshopFilter.value;
            
            // Фильтруем станки по выбранному цеху
            const filteredMachines = selectedWorkshop === 'all' 
                ? machinesList 
                : machinesList.filter(machine => machine.workshop === selectedWorkshop);
            
            // Добавляем станки в фильтр
            filteredMachines.forEach(machine => {
                const option = document.createElement('option');
                option.value = machine.id;
                option.textContent = `${machine.name} (ID: ${machine.id})`;
                DOM.machineFilter.appendChild(option);
            });
            
            // Восстанавливаем выбранное значение, если оно есть в новом списке
            if (currentMachine && DOM.machineFilter.querySelector(`option[value="${currentMachine}"]`)) {
                DOM.machineFilter.value = currentMachine;
            }
            
            console.log('Фильтр станков обновлен');
        }
        
        /**
         * Загружает данные по выбранному станку
         * @param {string} machineId - ID станка
         */
        async function loadMachineData(machineId) {
            const startDate = DOM.startDate.value;
            const endDate = DOM.endDate.value;
            
            if (!startDate || !endDate) {
                showNotification('Пожалуйста, выберите начальную и конечную дату', 'error');
                return;
            }
            
            try {
                showLoadingIndicator('Загрузка данных станка...');
                console.log(`Загрузка данных для станка ${machineId} с ${startDate} по ${endDate}`);
                
                // 1. Загружаем почасовые данные
                const hourlyResponse = await fetch(`${API_BASE_URL}/api/machines/${machineId}/hourly?date=${startDate}`);
                const hourlyData = await handleApiResponse(hourlyResponse);
                console.log('Почасовые данные:', hourlyData.data);
                
                // Обрезаем данные до текущего часа, если это сегодня
                const truncatedHourlyData = truncateToCurrentHour(hourlyData.data, startDate);
                updateHourlyChart(machineId, truncatedHourlyData);
                
                // 2. Загружаем сводные данные
                const summaryResponse = await fetch(`${API_BASE_URL}/api/machines/${machineId}/history/summary?startDate=${startDate}&endDate=${endDate}`);
                const summaryData = await handleApiResponse(summaryResponse);
                console.log('Сводные данные:', summaryData.data);
                updateMachineChart(machineId, summaryData.data);
                
                // 3. Загружаем детальные данные для временной шкалы
                const detailedResponse = await fetch(`${API_BASE_URL}/api/machines/${machineId}/history/detailed?startDate=${startDate}&endDate=${endDate}`);
                const detailedData = await handleApiResponse(detailedResponse);
                console.log('Детальные данные:', detailedData.data);
                updateTimelineChart(machineId, detailedData.data);
                
                showNotification('Данные станка успешно загружены', 'success');
                
            } catch (error) {
                console.error('Ошибка загрузки данных станка:', error);
                showNotification(`Ошибка загрузки данных: ${error.message}`, 'error');
                
                // Показываем тестовые данные при ошибке
                const machine = machinesList.find(m => m.id === machineId);
                if (machine) {
                    updateHourlyChart(machineId, null);
                    updateMachineChart(machineId, {working: 0, stopped: 0, shutdown: 0});
                }
            } finally {
                hideLoadingIndicator();
            }
        }

        /**
         * Обновляет почасовой график работы станка
         * @param {string} machineId - ID станка
         * @param {object} chartData - Данные для графика
         */
        function updateHourlyChart(machineId, chartData) {
            console.log(`Обновление почасового графика для станка ${machineId}`, chartData);
            
            const machine = machinesList.find(m => m.id === machineId);
            if (!machine) {
                console.error('Станок не найден:', machineId);
                return;
            }

            // Если нет данных, создаем тестовые данные для демонстрации
            if (!chartData || !chartData.datasets) {
                console.warn('Нет данных для графика, используем тестовые данные');
                chartData = {
                    labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                    datasets: [
                        {
                            label: STATUS_LABELS[STATUS.WORKING],
                            data: Array(24).fill().map(() => Math.floor(Math.random() * 30)),
                            backgroundColor: 'rgba(46, 204, 113, 0.7)',
                            borderColor: 'rgba(46, 204, 113, 1)',
                            borderWidth: 1,
                            borderRadius: 3
                        },
                        {
                            label: STATUS_LABELS[STATUS.STOPPED],
                            data: Array(24).fill().map(() => Math.floor(Math.random() * 30)),
                            backgroundColor: 'rgba(231, 76, 60, 0.7)',
                            borderColor: 'rgba(231, 76, 60, 1)',
                            borderWidth: 1,
                            borderRadius: 3
                        },
                        {
                            label: STATUS_LABELS[STATUS.SHUTDOWN],
                            data: Array(24).fill().map(() => Math.floor(Math.random() * 30)),
                            backgroundColor: 'rgba(149, 165, 166, 0.7)',
                            borderColor: 'rgba(149, 165, 166, 1)',
                            borderWidth: 1,
                            borderRadius: 3
                        }
                    ]
                };
            }

            // Обновляем данные графика
            barChart.data = chartData;
            
            // Обновляем заголовок
            const isTodayDate = isToday(DOM.startDate.value);
            const timeInfo = isTodayDate ? `(до ${new Date().getHours()}:00)` : `(${DOM.startDate.value})`;
            
            document.getElementById('barChartTitle').textContent = 
                `Работа станка ${machine.name} (ID: ${machineId}) по часам ${timeInfo}`;
            
            // Обновляем график
            try {
                barChart.update();
                console.log('Почасовой график успешно обновлен');
            } catch (e) {
                console.error('Ошибка обновления почасового графика:', e);
            }
        }

        /**
         * Обновляет график статусов станка
         * @param {string} machineId - ID станка
         * @param {object} data - Данные о статусах
         */
        function updateMachineChart(machineId, data) {
            console.log(`Обновление графика статусов для станка ${machineId}`, data);
            
            const machine = machinesList.find(m => m.id === machineId);
            if (!machine) {
                console.error('Станок не найден:', machineId);
                return;
            }

            const machineName = `${machine.name} (ID: ${machineId})`;
            
            // Обновляем данные графика
            machineStatusChart.data.labels = [machineName];
            machineStatusChart.data.datasets[0].data = [data.shutdown || 0];
            machineStatusChart.data.datasets[1].data = [data.stopped || 0];
            machineStatusChart.data.datasets[2].data = [data.working || 0];
            
            // Обновляем заголовок
            document.getElementById('chartTitle').textContent = 
                `Состояние станка ${machineName} (${DOM.startDate.value} - ${DOM.endDate.value})`;
            
            // Обновляем график
            try {
                machineStatusChart.update();
                console.log('График статусов успешно обновлен');
            } catch (e) {
                console.error('Ошибка обновления графика статусов:', e);
            }
        }
        
        /**
         * Обновляет график временной шкалы
         * @param {string} machineId - ID станка
         * @param {Array} data - Данные временной шкалы
         */
        function updateTimelineChart(machineId, data) {
            console.log(`Обновление временной шкалы для станка ${machineId}`, data);
            
            const machine = machinesList.find(m => m.id === machineId);
            if (!machine || !data || !Array.isArray(data)) {
                console.error('Нет данных для временной шкалы');
                return;
            }

            const machineName = `${machine.name} (ID: ${machineId})`;
            const isSingleDay = DOM.startDate.value === DOM.endDate.value;
            
            // Подготавливаем данные для графика
            const labels = [];
            const statusData = [];
            
            data.forEach(event => {
                const date = moment(event.timestamp);
                if (isSingleDay) {
                    labels.push(date.format('HH:mm:ss'));
                } else {
                    labels.push(date.format('YYYY-MM-DD HH:mm'));
                }
                
                // Преобразуем статус в числовое значение
                let statusValue;
                switch (event.status) {
                    case STATUS.SHUTDOWN: statusValue = 0; break;
                    case STATUS.STOPPED: statusValue = 1; break;
                    case STATUS.WORKING: statusValue = 2; break;
                    default: statusValue = 0;
                }
                
                statusData.push(statusValue);
            });
            
            // Обновляем график
            timelineChart.data.labels = labels;
            timelineChart.data.datasets[0].data = statusData;
            
            // Обновляем заголовок
            document.getElementById('timelineChartTitle').textContent = 
                `Изменение состояния станка ${machineName} (${DOM.startDate.value} - ${DOM.endDate.value})`;
            
            // Обновляем настройки оси Y
            timelineChart.options.scales.y.ticks.callback = function(value) {
                return STATUS_LABELS[Object.keys(STATUS_LABELS)[value]];
            };
            
            // Обновляем график
            try {
                timelineChart.update();
                console.log('График временной шкалы успешно обновлен');
            } catch (e) {
                console.error('Ошибка обновления графика временной шкалы:', e);
            }
        }

        /**
         * Загружает данные по цехам
         */
        async function loadWorkshopData() {
            const startDate = DOM.startDate.value;
            const endDate = DOM.endDate.value;
            
            if (!startDate || !endDate) {
                showNotification('Пожалуйста, выберите начальную и конечную дату', 'error');
                return;
            }

            try {
                showLoadingIndicator('Загрузка данных цехов...');
                console.log(`Загрузка данных цехов с ${startDate} по ${endDate}`);
                
                const response = await fetch(`${API_BASE_URL}/api/workshops/summary?startDate=${startDate}&endDate=${endDate}`);
                const data = await handleApiResponse(response);
                
                workshopData = data.data;
                console.log('Данные цехов:', workshopData);
                
                updateWorkshopCharts();
                showNotification('Данные цехов успешно загружены', 'success');
                
            } catch (error) {
                console.error('Ошибка загрузки данных цехов:', error);
                showNotification(`Ошибка загрузки данных цехов: ${error.message}`, 'error');
            } finally {
                hideLoadingIndicator();
            }
        }

        /**
         * Обновляет графики для режима просмотра цехов
         */
        async function updateWorkshopCharts() {
            console.log('Обновление графиков цехов');
            
            // 1. Круговая диаграмма (общие данные)
            pieChart.data.datasets[0].data = [
                workshopData.total.working,
                workshopData.total.stopped,
                workshopData.total.shutdown
            ];
            
            // 2. Горизонтальная столбчатая диаграмма (сравнение цехов)
            horizontalBarChart.data.datasets[0].data = [
                workshopData.workshop1.shutdown,
                workshopData.workshop2.shutdown
            ];
            horizontalBarChart.data.datasets[1].data = [
                workshopData.workshop1.stopped,
                workshopData.workshop2.stopped
            ];
            horizontalBarChart.data.datasets[2].data = [
                workshopData.workshop1.working,
                workshopData.workshop2.working
            ];
            
            // 3. Почасовой график (загружаем агрегированные данные)
            await updateHourlyChartForAllMachines();
            
            // Обновляем заголовки
            document.getElementById('pieChartTitle').textContent = 
                `Состояние станков всех цехов (${DOM.startDate.value} - ${DOM.endDate.value})`;
            document.getElementById('horizontalBarChartTitle').textContent = 
                `Сравнение цехов (${DOM.startDate.value} - ${DOM.endDate.value})`;
            
            // Обновляем все графики
            try {
                pieChart.update();
                horizontalBarChart.update();
                console.log('Графики цехов успешно обновлены');
            } catch (e) {
                console.error('Ошибка обновления графиков цехов:', e);
            }
        }

        /**
         * Обновляет почасовой график для всех станков или выбранного цеха
         */
        async function updateHourlyChartForAllMachines() {
            const selectedWorkshop = DOM.workshopFilter.value;
            const date = DOM.startDate.value;
            
            try {
                showLoadingIndicator('Загрузка агрегированных данных...');
                
                // Используем новый эндпоинт для получения агрегированных данных
                const response = await fetch(
                    `${API_BASE_URL}/api/workshops/hourly?date=${date}&workshop=${selectedWorkshop}`
                );
                const data = await handleApiResponse(response);
                
                // Обрезаем данные до текущего часа, если это сегодня
                const truncatedData = truncateToCurrentHour(data.data, date);
                
                // Обновляем график
                barChart.data = truncatedData;
                
                const isTodayDate = isToday(date);
                const timeInfo = isTodayDate ? `(до ${new Date().getHours()}:00)` : `(${date})`;
                
                document.getElementById('barChartTitle').textContent = 
                    `Работа ${selectedWorkshop === 'all' ? 'всех станков' : 'станков цеха ' + selectedWorkshop} по часам ${timeInfo}`;
                
                barChart.update();
                
            } catch (error) {
                console.error('Ошибка загрузки агрегированных данных:', error);
                showNotification('Ошибка загрузки данных по станкам', 'error');
                
                // Показываем тестовые данные при ошибке
                const chartData = {
                    labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                    datasets: [
                        {
                            label: STATUS_LABELS[STATUS.WORKING],
                            data: Array(24).fill().map(() => Math.floor(Math.random() * 30)),
                            backgroundColor: 'rgba(46, 204, 113, 0.7)',
                            borderColor: 'rgba(46, 204, 113, 1)',
                            borderWidth: 1,
                            borderRadius: 3
                        },
                        {
                            label: STATUS_LABELS[STATUS.STOPPED],
                            data: Array(24).fill().map(() => Math.floor(Math.random() * 30)),
                            backgroundColor: 'rgba(231, 76, 60, 0.7)',
                            borderColor: 'rgba(231, 76, 60, 1)',
                            borderWidth: 1,
                            borderRadius: 3
                        },
                        {
                            label: STATUS_LABELS[STATUS.SHUTDOWN],
                            data: Array(24).fill().map(() => Math.floor(Math.random() * 30)),
                            backgroundColor: 'rgba(149, 165, 166, 0.7)',
                            borderColor: 'rgba(149, 165, 166, 1)',
                            borderWidth: 1,
                            borderRadius: 3
                        }
                    ]
                };
                
                barChart.data = chartData;
                barChart.update();
            } finally {
                hideLoadingIndicator();
            }
        }

        /**
         * Устанавливает период для отображения данных
         * @param {string} period - Тип периода (day, week, month, year)
         */
        function setPeriod(period) {
            console.log(`Установка периода: ${period}`);
            
            currentPeriod = period;
            const today = new Date();
            let startDate, endDate;
            
            // Обновляем активную кнопку периода
            document.querySelectorAll('.period-buttons button').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.toLowerCase().includes(period)) {
                    btn.classList.add('active');
                }
            });
            
            // Устанавливаем даты в соответствии с периодом
            switch (period) {
                case 'day':
                    startDate = new Date(today);
                    startDate.setHours(0, 0, 0, 0);
                    endDate = new Date(today);
                    endDate.setHours(23, 59, 59, 999);
                    break;
                    
                case 'week':
                    startDate = new Date(today);
                    startDate.setDate(today.getDate() - today.getDay());
                    startDate.setHours(0, 0, 0, 0);
                    endDate = new Date(today);
                    endDate.setDate(today.getDate() + (6 - today.getDay()));
                    endDate.setHours(23, 59, 59, 999);
                    break;
                    
                case 'month':
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                    endDate.setHours(23, 59, 59, 999);
                    break;
                    
                case 'year':
                    startDate = new Date(today.getFullYear(), 0, 1);
                    endDate = new Date(today.getFullYear(), 11, 31);
                    endDate.setHours(23, 59, 59, 999);
                    break;
            }
            
            // Устанавливаем даты в полях ввода
            DOM.startDate.valueAsDate = startDate;
            DOM.endDate.valueAsDate = endDate;
            
            // Загружаем данные для текущего режима просмотра
            if (currentViewMode === 'workshop') {
                loadWorkshopData();
            } else {
                const machineId = DOM.machineFilter.value;
                if (machineId && machineId !== 'all') {
                    loadMachineData(machineId);
                }
            }
        }

        /**
         * Переключает режим просмотра на цеха
         */
        function showWorkshopView() {
            console.log('Переключение в режим просмотра цехов');
            currentViewMode = 'workshop';
            DOM.workshopCharts.style.display = 'grid';
            DOM.individualCharts.style.display = 'none';
            loadWorkshopData();
        }

        /**
         * Переключает режим просмотра на отдельный станок
         */
        function showMachineView() {
            console.log('Переключение в режим просмотра станка');
            currentViewMode = 'individual';
            DOM.workshopCharts.style.display = 'none';
            DOM.individualCharts.style.display = 'block';
            
            const machineId = DOM.machineFilter.value;
            if (machineId && machineId !== 'all') {
                loadMachineData(machineId);
            }
        }

        // Инициализация приложения после загрузки DOM
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM загружен, инициализация приложения...');
            
            // 1. Инициализируем графики
            initCharts();
            
            // 2. Загружаем список станков
            loadMachineList();
            
            // 3. Устанавливаем текущую дату по умолчанию
            const today = new Date();
            DOM.startDate.valueAsDate = today;
            DOM.endDate.valueAsDate = today;
            
            // 4. Настраиваем обработчики событий
            DOM.workshopFilter.addEventListener('change', function() {
                updateMachineFilter();
                if (currentViewMode === 'workshop') {
                    loadWorkshopData();
                }
            });
            
            DOM.machineFilter.addEventListener('change', function() {
                if (this.value === 'all') {
                    showWorkshopView();
                } else {
                    showMachineView();
                }
            });
            
            DOM.applyFilters.addEventListener('click', function() {
                if (currentViewMode === 'workshop') {
                    loadWorkshopData();
                } else {
                    const machineId = DOM.machineFilter.value;
                    if (machineId && machineId !== 'all') {
                        loadMachineData(machineId);
                    }
                }
            });
            
            // 5. Загружаем начальные данные
            setPeriod('day');
            
            console.log('Приложение инициализировано');
        });
    </script>
</body>
</html>