<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ì—Ä–∞—Ñ–∏–∫–∏ –∞–Ω–∞–ª–∏–∑–∞ —Å—Ç–∞–Ω–∫–æ–≤</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment"></script>
    <link rel="icon" type="image/x-icon" href="images/favicon.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="styles2.css">
   
</head>
<body>
    <!-- –®–∞–ø–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
    <header>
        <h1>–ì—Ä–∞—Ñ–∏–∫–∏ –∞–Ω–∞–ª–∏–∑–∞ —Å—Ç–∞–Ω–∫–æ–≤</h1>
        <button class="logout-button" onclick="location.href='login.html'">
            <i class="fas fa-sign-out-alt"></i> –í—ã–π—Ç–∏
        </button>
    </header>
    
    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω–æ–µ –º–µ–Ω—é -->
    <nav>
        <button onclick="location.href='dashboard.html'">
            <i class="fas fa-tachometer-alt"></i> –î–∞—à–±–æ—Ä–¥—ã
        </button>
        <button class="active" onclick="location.href='charts.html'">
            <i class="fas fa-chart-line"></i> –ì—Ä–∞—Ñ–∏–∫–∏ –∞–Ω–∞–ª–∏–∑–∞
        </button>
        <button onclick="location.href='reports.html'">
            <i class="fas fa-file-alt"></i> –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –æ—Ç—á–µ—Ç–æ–≤
        </button>
        <button onclick="location.href='settings.html'">
            <i class="fas fa-cog"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏
        </button>
    </nav>
    
    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä -->
    <div class="container">
        <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ -->
        <div class="sidebar">
            <h3><i class="fas fa-industry"></i> –¶–µ—Ö</h3>
            <select id="workshopFilter">
                <option value="all">–í—Å–µ —Ü–µ—Ö–∞</option>
                <option value="1">–¶–µ—Ö 1</option>
                <option value="2">–¶–µ—Ö 2</option>
            </select>
            
            <h3><i class="fas fa-filter"></i> –§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞–Ω–∫–∞–º</h3>
            <select id="machineFilter">
                <option value="all">–í—Å–µ —Å—Ç–∞–Ω–∫–∏</option>
            </select>
            
            <h3><i class="fas fa-calendar-alt"></i> –ü–µ—Ä–∏–æ–¥</h3>
            <div class="period-buttons">
                <button class="active" onclick="setPeriod('day')"><i class="fas fa-calendar-day"></i> –î–µ–Ω—å</button>
                <button onclick="setPeriod('week')"><i class="fas fa-calendar-week"></i> –ù–µ–¥–µ–ª—è</button>
                <button onclick="setPeriod('month')"><i class="fas fa-calendar"></i> –ú–µ—Å—è—Ü</button>
                <button onclick="setPeriod('year')"><i class="fas fa-calendar"></i> –ì–æ–¥</button>
            </div>
            
            <div>
                <label for="startDate"><i class="fas fa-clock"></i> –ù–∞—á–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞:</label>
                <input type="date" id="startDate">
            </div>
            <div>
                <label for="endDate"><i class="fas fa-clock"></i> –ö–æ–Ω–µ—á–Ω–∞—è –¥–∞—Ç–∞:</label>
                <input type="date" id="endDate">
            </div>
            
            <button id="applyFilters" class="filter-btn">
                <i class="fas fa-filter"></i> –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
            </button>
        </div>
        
        <!-- –û—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ -->
        <div class="content">
            <!-- –ì—Ä–∞—Ñ–∏–∫–∏ –¥–ª—è —Ä–µ–∂–∏–º–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ü–µ—Ö–æ–≤ -->
            <div id="workshopCharts" class="charts-row">
                <div class="chart-container">
                    <h3 class="chart-title" id="pieChartTitle">–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å—Ç–∞–Ω–∫–æ–≤ (–∫—Ä—É–≥–æ–≤–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞)</h3>
                    <canvas id="pieChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title" id="partsChartTitle">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ—Ç–∞–ª–µ–π –ø–æ –¥–Ω—è–º</h3>
                    <canvas id="partsChart"></canvas>
                    <div id="totalParts" class="total-parts">
                        –í—Å–µ–≥–æ –¥–µ—Ç–∞–ª–µ–π –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥: <span>0</span>
                    </div>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title" id="horizontalBarChartTitle">–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å—Ç–∞–Ω–∫–æ–≤ (–≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–æ–ª–±—Ü—ã)</h3>
                    <canvas id="horizontalBarChart"></canvas>
                </div>
            </div>
            
            <!-- –ì—Ä–∞—Ñ–∏–∫–∏ –¥–ª—è —Ä–µ–∂–∏–º–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Å—Ç–∞–Ω–∫–æ–≤ -->
            <div id="individualCharts" style="display: none;" class="charts-row">
                <div class="chart-container">
                    <h3 class="chart-title" id="machineStatusTitle">–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å—Ç–∞–Ω–∫–∞</h3>
                    <canvas id="machineStatusChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title" id="machinePartsTitle">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ—Ç–∞–ª–µ–π</h3>
                    <canvas id="machinePartsChart"></canvas>
                    <div id="machineTotalParts" class="total-parts">
                        –í—Å–µ–≥–æ –¥–µ—Ç–∞–ª–µ–π –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥: <span>0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
    <div class="notification" id="notification"></div>
    
    <!-- –û—Å–Ω–æ–≤–Ω–æ–π JavaScript –∫–æ–¥ -->
    <script>
        // –ë–∞–∑–æ–≤—ã–π URL API –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
        const API_BASE_URL = 'http://localhost:3001';
        const SETTINGS_API_URL = 'http://localhost:3004';
        
        // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è —Å–æ—Å—Ç–æ—è–Ω–∏–π —Å—Ç–∞–Ω–∫–æ–≤ (—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–µ —Å dashboard.html)
        const STATUS = {
            WORKING: 'working',
            STOPPED: 'stopped',
            SHUTDOWN: 'shutdown'
        };
        
        // –¶–≤–µ—Ç–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π
        const STATUS_COLORS = {
            [STATUS.WORKING]: '#2ecc71',
            [STATUS.STOPPED]: '#e74c3c',
            [STATUS.SHUTDOWN]: '#95a5a6'
        };
        
        // –ù–∞–∑–≤–∞–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–π
        const STATUS_LABELS = {
            [STATUS.WORKING]: '–†–∞–±–æ—Ç–∞–µ—Ç',
            [STATUS.STOPPED]: '–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ',
            [STATUS.SHUTDOWN]: '–í—ã–∫–ª—é—á–µ–Ω–æ'
        };
        
        // –¢–µ–∫—É—â–∏–π –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥
        let currentPeriod = 'day';
        let currentViewMode = 'workshop';
        
        // –î–∞–Ω–Ω—ã–µ –æ —Å—Ç–∞–Ω–∫–∞—Ö
        let machinesList = [];
        let workshopData = {};
        
        // –î–∞–Ω–Ω—ã–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫
        let workshopDistribution = {
            workshops: [],
            machines: [],
            machineToWorkshopMap: {}
        };
        
        // –û–±—ä–µ–∫—Ç—ã –≥—Ä–∞—Ñ–∏–∫–æ–≤
        let pieChart, partsChart, horizontalBarChart, machineStatusChart, machinePartsChart;
        
        // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
        const DOM = {
            workshopFilter: document.getElementById('workshopFilter'),
            machineFilter: document.getElementById('machineFilter'),
            notification: document.getElementById('notification'),
            startDate: document.getElementById('startDate'),
            endDate: document.getElementById('endDate'),
            applyFilters: document.getElementById('applyFilters'),
            workshopCharts: document.getElementById('workshopCharts'),
            individualCharts: document.getElementById('individualCharts')
        };

        /**
         * –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç–∞–Ω–∫–æ–≤ –ø–æ —Ü–µ—Ö–∞–º –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫
         */
        async function loadWorkshopDistribution() {
            try {
                console.log('üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å—Ç–∞–Ω–∫–æ–≤ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤...');
                
                const response = await fetch(`${SETTINGS_API_URL}/api/settings/distribution-data`);
                if (!response.ok) {
                    throw new Error(`HTTP error: ${response.status}`);
                }
                
                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.message || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è');
                }
                
                workshopDistribution = data.distribution;
                
                console.log('‚úÖ –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤:', {
                    workshops: workshopDistribution.workshops.length,
                    machines: workshopDistribution.machines.length,
                    workshopsList: workshopDistribution.workshops.map(w => `${w.name}(id:${w.id})`)
                });
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä —Ü–µ—Ö–æ–≤
                updateWorkshopsFilter();
                
                return true;
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤:', error);
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                workshopDistribution = {
                    workshops: [
                        { id: 1, name: '–¶–µ—Ö 1' },
                        { id: 2, name: '–¶–µ—Ö 2' }
                    ],
                    machines: [],
                    machineToWorkshopMap: {}
                };
                
                updateWorkshopsFilter();
                showNotification('–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é', 'warning');
                return false;
            }
        }

        /**
         * –û–±–Ω–æ–≤–ª—è–µ—Ç —Ñ–∏–ª—å—Ç—Ä —Ü–µ—Ö–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
         */
        function updateWorkshopsFilter() {
            const workshopFilter = document.getElementById('workshopFilter');
            const currentValue = workshopFilter.value;
            
            // –û—á–∏—â–∞–µ–º —Ç–µ–∫—É—â–∏–µ –æ–ø—Ü–∏–∏
            workshopFilter.innerHTML = '<option value="all">–í—Å–µ —Ü–µ—Ö–∞</option>';
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Ü–µ—Ö–∞ –∏–∑ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
            workshopDistribution.workshops.forEach(workshop => {
                const option = document.createElement('option');
                option.value = workshop.id;
                option.textContent = workshop.name;
                workshopFilter.appendChild(option);
            });
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ, –µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ
            if (currentValue && workshopFilter.querySelector(`option[value="${currentValue}"]`)) {
                workshopFilter.value = currentValue;
            }
            
            console.log('‚úÖ –§–∏–ª—å—Ç—Ä —Ü–µ—Ö–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω:', workshopDistribution.workshops.map(w => w.name));
        }

        /**
         * –ü–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞–Ω–∫–∏ –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —Ü–µ—Ö–∞
         */
        function getMachinesForWorkshop(workshopId) {
            if (workshopId === 'all') {
                return workshopDistribution.machines;
            }
            return workshopDistribution.machines.filter(machine => 
                machine.workshopId === parseInt(workshopId)
            );
        }

        /**
         * –ü–æ–ª—É—á–∞–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ —Ü–µ—Ö–∞ –ø–æ ID
         */
        function getWorkshopName(workshopId) {
            const workshop = workshopDistribution.workshops.find(w => w.id === parseInt(workshopId));
            return workshop ? workshop.name : `–¶–µ—Ö ${workshopId}`;
        }

        /**
         * –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –ø–µ—Ä–∏–æ–¥ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö
         */
        function formatPeriod(startDateStr, endDateStr) {
            const startDate = new Date(startDateStr);
            const endDate = new Date(endDateStr);
            
            // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω –ø–µ—Ä–∏–æ–¥ "–î–µ–Ω—å", –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –æ–¥–Ω—É –¥–∞—Ç—É
            if (currentPeriod === 'day') {
                return startDateStr;
            }
            
            // –î–ª—è –¥—Ä—É–≥–∏—Ö –ø–µ—Ä–∏–æ–¥–æ–≤ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω, –µ—Å–ª–∏ –¥–∞—Ç—ã —Ä–∞–∑–Ω—ã–µ
            if (startDateStr === endDateStr) {
                return startDateStr;
            }
            return `${startDateStr} - ${endDateStr}`;
        }

        /**
         * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
         * @param {string} message - –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
         * @param {string} type - –¢–∏–ø —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (success, error, loading)
         * @param {number} [duration=3000] - –í—Ä–µ–º—è –ø–æ–∫–∞–∑–∞ –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
         */
        function showNotification(message, type = 'success', duration = 3000) {
            // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            DOM.notification.innerHTML = '';
            
            // –°–æ–∑–¥–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            const content = document.createElement('div');
            content.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : 
                                  type === 'error' ? 'fa-exclamation-circle' : 
                                  type === 'warning' ? 'fa-exclamation-triangle' :
                                  'fa-spinner fa-spin'}"></i>
                <span>${message}</span>
            `;
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–ª–∞—Å—Å—ã –∏ —Å—Ç–∏–ª–∏
            DOM.notification.className = `notification show ${type}`;
            DOM.notification.appendChild(content);
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫—Ä—ã—Ç–∏–µ –¥–ª—è –Ω–µ-loading —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
            if (type !== 'loading') {
                setTimeout(() => {
                    DOM.notification.classList.remove('show');
                }, duration);
            }
        }

        /**
         * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
         * @param {string} [message='–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...'] - –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
         */
        function showLoadingIndicator(message = '–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...') {
            showNotification(message, 'loading', 0);
        }

        /**
         * –°–∫—Ä—ã–≤–∞–µ—Ç –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
         */
        function hideLoadingIndicator() {
            if (DOM.notification.classList.contains('loading')) {
                DOM.notification.classList.remove('show');
                setTimeout(() => {
                    DOM.notification.className = 'notification';
                    DOM.notification.innerHTML = '';
                }, 300);
            }
        }

        /**
         * –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–≤–µ—Ç–æ–≤ –æ—Ç API
         * @param {Response} response - –û–±—ä–µ–∫—Ç –æ—Ç–≤–µ—Ç–∞ fetch
         * @returns {Promise<object>} - –†–∞—Å–ø–∞—Ä—Å–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
         * @throws {Error} - –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –Ω–µ —É—Å–ø–µ—à–Ω—ã–π
         */
        async function handleApiResponse(response) {
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP error! status: ${response.status}, details: ${errorText}`);
            }
            
            const data = await response.json();
            
            if (!data.success) {
                throw new Error(data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
            }
            
            return data;
        }

        /**
         * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –¥–∞—Ç–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–º –¥–Ω–µ–º
         * @param {string} dateString - –î–∞—Ç–∞ –≤ —Ñ–æ—Ä–º–∞ite YYYY-MM-DD
         * @returns {boolean} - true –µ—Å–ª–∏ –¥–∞—Ç–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω—è—è
         */
        function isToday(dateString) {
            const today = new Date();
            const todayFormatted = today.toISOString().split('T')[0];
            return dateString === todayFormatted;
        }

        /**
         * –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Å—Ç–∞–Ω–∫–æ–≤ —Å —Å–µ—Ä–≤–µ—Ä–∞
         */
        async function loadMachineList() {
            try {
                showLoadingIndicator('–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Å—Ç–∞–Ω–∫–æ–≤...');
                console.log('–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Å—Ç–∞–Ω–∫–æ–≤...');
                
                const response = await fetch(`${API_BASE_URL}/api/machines`);
                const data = await handleApiResponse(response);
                
                machinesList = Object.entries(data.machines).map(([id, machine]) => ({
                    id,
                    name: machine.name,
                    workshop: machine.workshop
                }));
                
                console.log('–ü–æ–ª—É—á–µ–Ω —Å–ø–∏—Å–æ–∫ —Å—Ç–∞–Ω–∫–æ–≤:', machinesList);
                updateMachineFilter();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ —Å—Ç–∞–Ω–∫–æ–≤:', error);
                showNotification(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ —Å—Ç–∞–Ω–∫–æ–≤: ${error.message}`, 'error');
            } finally {
                hideLoadingIndicator();
            }
        }
        
        /**
         * –û–±–Ω–æ–≤–ª—è–µ—Ç —Ñ–∏–ª—å—Ç—Ä —Å—Ç–∞–Ω–∫–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ü–µ—Ö–∞
         */
        function updateMachineFilter() {
            console.log('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞ —Å—Ç–∞–Ω–∫–æ–≤...');
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
            const currentMachine = DOM.machineFilter.value;
            
            // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫
            DOM.machineFilter.innerHTML = '<option value="all">–í—Å–µ —Å—Ç–∞–Ω–∫–∏</option>';
            
            const selectedWorkshop = DOM.workshopFilter.value;
            
            // –§–∏–ª—å—Ç—Ä—É–µ–º —Å—Ç–∞–Ω–∫–∏ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —Ü–µ—Ö—É –∏–∑ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
            const filteredMachines = getMachinesForWorkshop(selectedWorkshop);
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞–Ω–∫–∏ –≤ —Ñ–∏–ª—å—Ç—Ä
            filteredMachines.forEach(machine => {
                const option = document.createElement('option');
                option.value = machine.id;
                option.textContent = `${machine.name} (ID: ${machine.id})`;
                DOM.machineFilter.appendChild(option);
            });
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ, –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å –≤ –Ω–æ–≤–æ–º —Å–ø–∏—Å–∫–µ
            if (currentMachine && DOM.machineFilter.querySelector(`option[value="${currentMachine}"]`)) {
                DOM.machineFilter.value = currentMachine;
            }
            
            console.log('–§–∏–ª—å—Ç—Ä —Å—Ç–∞–Ω–∫–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è —Ü–µ—Ö–∞', selectedWorkshop, ':', filteredMachines.length, '—Å—Ç–∞–Ω–∫–æ–≤');
        }

        /**
         * –û—Ç–ª–∞–¥–æ—á–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–∞–Ω–Ω—ã—Ö
         */
        function debugPartsData(chartData) {
            console.log('=== –î–ï–ë–ê–ì –î–ê–ù–ù–´–• –î–ï–¢–ê–õ–ï–ô ===');
            console.log('Labels:', chartData.labels);
            console.log('Data:', chartData.datasets[0].data);
            console.log('Total:', chartData.datasets[0].data.reduce((a, b) => a + b, 0));
            console.log('============================');
        }

        /**
         * –ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –¥–µ—Ç–∞–ª–µ–π –ø–æ –¥–Ω—è–º
         */
        async function loadPartsData() {
            const startDate = DOM.startDate.value;
            const endDate = DOM.endDate.value;
            const workshop = DOM.workshopFilter.value;

            if (!startDate || !endDate) {
                console.log('–î–∞—Ç—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –¥–∞–Ω–Ω—ã—Ö –æ –¥–µ—Ç–∞–ª—è—Ö');
                return;
            }

            try {
                showLoadingIndicator('–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ –¥–µ—Ç–∞–ª—è—Ö...');
                console.log(`–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ –¥–µ—Ç–∞–ª—è—Ö –¥–ª—è —Ü–µ—Ö–∞ ${workshop} —Å ${startDate} –ø–æ ${endDate}`);
                
                // –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –¥–Ω–µ–≤–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                const response = await fetch(
                    `${API_BASE_URL}/api/workshops/parts-daily?startDate=${startDate}&endDate=${endDate}&workshop=${workshop}`
                );
                const data = await handleApiResponse(response);
                
                console.log('–ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –æ –¥–µ—Ç–∞–ª—è—Ö:', data);
                updatePartsChart(data.data, data.total);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –æ –¥–µ—Ç–∞–ª—è—Ö:', error);
                showNotification(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –æ –¥–µ—Ç–∞–ª—è—Ö: ${error.message}`, 'error');
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–ª–µ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
                updatePartsChart(null, 0);
            } finally {
                hideLoadingIndicator();
            }
        }

        /**
         * –û–±–Ω–æ–≤–ª—è–µ—Ç –≥—Ä–∞—Ñ–∏–∫ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–µ—Ç–∞–ª–µ–π –ø–æ –¥–Ω—è–º
         * @param {object} chartData - –î–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
         * @param {number} totalParts - –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ—Ç–∞–ª–µ–π
         */
        function updatePartsChart(chartData, totalParts) {
            console.log('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ –¥–µ—Ç–∞–ª–µ–π –ø–æ –¥–Ω—è–º', chartData, totalParts);
            
            // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–ª–µ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
            if (!chartData || !chartData.labels || !chartData.datasets) {
                console.warn('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ –¥–µ—Ç–∞–ª–µ–π, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–ª–∏');
                
                // –°–æ–∑–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Å–µ—Ö –¥–Ω–µ–π –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –ø–µ—Ä–∏–æ–¥–µ
                const start = new Date(DOM.startDate.value);
                const end = new Date(DOM.endDate.value);
                const days = [];
                const partsData = [];
                
                let currentDate = new Date(start);
                while (currentDate <= end) {
                    days.push(currentDate.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' }));
                    partsData.push(0);
                    currentDate.setDate(currentDate.getDate() + 1);
                }
                
                chartData = {
                    labels: days,
                    datasets: [{
                        label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ—Ç–∞–ª–µ–π',
                        data: partsData,
                        backgroundColor: 'rgba(54, 162, 235, 0.7)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1,
                        borderRadius: 3
                    }]
                };
                totalParts = 0;
            }

            // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
            debugPartsData(chartData);

            // –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∞
            partsChart.data.labels = chartData.labels;
            partsChart.data.datasets[0].data = chartData.datasets[0].data;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø–µ—Ä–∏–æ–¥–∞
            const periodText = formatPeriod(DOM.startDate.value, DOM.endDate.value);
            const workshopText = DOM.workshopFilter.value === 'all' ? '–í—Å–µ —Ü–µ—Ö–∞' : getWorkshopName(DOM.workshopFilter.value);
            
            if (currentPeriod === 'day') {
                document.getElementById('partsChartTitle').textContent = 
                    `–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ—Ç–∞–ª–µ–π –∑–∞ ${periodText} (${workshopText})`;
            } else {
                document.getElementById('partsChartTitle').textContent = 
                    `–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ—Ç–∞–ª–µ–π –ø–æ –¥–Ω—è–º (${workshopText}, ${periodText})`;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
            document.querySelector('#totalParts span').textContent = totalParts;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫
            try {
                partsChart.update('active');
                console.log('–ì—Ä–∞—Ñ–∏–∫ –¥–µ—Ç–∞–ª–µ–π –ø–æ –¥–Ω—è–º —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω');
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞ –¥–µ—Ç–∞–ª–µ–π –ø–æ –¥–Ω—è–º:', e);
            }
        }

        /**
         * –ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ —Ü–µ—Ö–∞–º
         */
        async function loadWorkshopData() {
            const startDate = DOM.startDate.value;
            const endDate = DOM.endDate.value;
            
            if (!startDate || !endDate) {
                showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –Ω–∞—á–∞–ª—å–Ω—É—é –∏ –∫–æ–Ω–µ—á–Ω—É—é –¥–∞—Ç—É', 'error');
                return;
            }

            try {
                showLoadingIndicator('–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Ü–µ—Ö–æ–≤...');
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ü–µ—Ö–æ–≤
                workshopData = {};
                workshopDistribution.workshops.forEach(workshop => {
                    workshopData[workshop.id] = { working: 0, stopped: 0, shutdown: 0 };
                });
                workshopData.total = { working: 0, stopped: 0, shutdown: 0 };

                // –î–ª—è –ø–µ—Ä–∏–æ–¥–∞ "–î–µ–Ω—å" –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ—á–∞—Å–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
                if (currentPeriod === 'day') {
                    await loadWorkshopDataForDay(startDate);
                } else {
                    // –î–ª—è –¥—Ä—É–≥–∏—Ö –ø–µ—Ä–∏–æ–¥–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∞–≥—Ä–µ–≥–∞—Ü–∏—é –¥–∞–Ω–Ω—ã—Ö
                    const selectedWorkshop = DOM.workshopFilter.value;
                    
                    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ü–µ—Ö–∞
                    const workshopsToProcess = selectedWorkshop === 'all' 
                        ? workshopDistribution.workshops 
                        : workshopDistribution.workshops.filter(w => w.id.toString() === selectedWorkshop);

                    for (const workshop of workshopsToProcess) {
                        const workshopStats = await aggregateWorkshopDataFromHourly(workshop.id.toString(), startDate, endDate);
                        workshopData[workshop.id] = workshopStats;
                        
                        // –°—É–º–º–∏—Ä—É–µ–º –≤ –æ–±—â–∏–µ –¥–∞–Ω–Ω—ã–µ
                        workshopData.total.working += workshopStats.working;
                        workshopData.total.stopped += workshopStats.stopped;
                        workshopData.total.shutdown += workshopStats.shutdown;
                    }
                    
                    console.log('–î–∞–Ω–Ω—ã–µ —Ü–µ—Ö–æ–≤:', workshopData);
                }
                
                updateWorkshopCharts();
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –¥–µ—Ç–∞–ª—è—Ö
                await loadPartsData();
                
                showNotification('–î–∞–Ω–Ω—ã–µ —Ü–µ—Ö–æ–≤ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã', 'success');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Ü–µ—Ö–æ–≤:', error);
                showNotification(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Ü–µ—Ö–æ–≤: ${error.message}`, 'error');
            } finally {
                hideLoadingIndicator();
            }
        }

        /**
         * –ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ —Ü–µ—Ö–æ–≤ –¥–ª—è –æ–¥–Ω–æ–≥–æ –¥–Ω—è
         */
        async function loadWorkshopDataForDay(date) {
            try {
                const selectedWorkshop = DOM.workshopFilter.value;
                
                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ü–µ—Ö–∞
                const workshopsToProcess = selectedWorkshop === 'all' 
                    ? workshopDistribution.workshops 
                    : workshopDistribution.workshops.filter(w => w.id.toString() === selectedWorkshop);

                for (const workshop of workshopsToProcess) {
                    const workshopHourlyData = await getWorkshopHourlyData(workshop.id.toString(), date);
                    workshopData[workshop.id] = aggregateHourlyToDaily(workshopHourlyData);
                    
                    // –°—É–º–º–∏—Ä—É–µ–º –≤ –æ–±—â–∏–µ –¥–∞–Ω–Ω—ã–µ
                    workshopData.total.working += workshopData[workshop.id].working;
                    workshopData.total.stopped += workshopData[workshop.id].stopped;
                    workshopData.total.shutdown += workshopData[workshop.id].shutdown;
                }
                
                console.log('–î–∞–Ω–Ω—ã–µ —Ü–µ—Ö–æ–≤ –∑–∞ –¥–µ–Ω—å:', workshopData);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Ü–µ—Ö–æ–≤ –∑–∞ –¥–µ–Ω—å:', error);
                throw error;
            }
        }

        /**
         * –ó–∞–≥—Ä—É–∂–∞–µ—Ç –ø–æ—á–∞—Å–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ü–µ—Ö–∞ –∑–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –¥–µ–Ω—å
         */
        async function getWorkshopHourlyData(workshop, date) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/workshops/hourly?date=${date}&workshop=${workshop}`);
                const data = await handleApiResponse(response);
                return data.data;
            } catch (error) {
                console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—á–∞—Å–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ü–µ—Ö–∞ ${workshop}:`, error);
                return null;
            }
        }

        /**
         * –ê–≥—Ä–µ–≥–∏—Ä—É–µ—Ç –ø–æ—á–∞—Å–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –æ–±—â–∏–µ –∑–∞ –¥–µ–Ω—å
         */
        function aggregateHourlyToDaily(hourlyData) {
            if (!hourlyData || !hourlyData.datasets) {
                return { working: 0, stopped: 0, shutdown: 0 };
            }

            const working = hourlyData.datasets[0].data.reduce((sum, val) => sum + val, 0) / 60; // –º–∏–Ω—É—Ç—ã –≤ —á–∞—Å—ã
            const stopped = hourlyData.datasets[1].data.reduce((sum, val) => sum + val, 0) / 60;
            const shutdown = hourlyData.datasets[2].data.reduce((sum, val) => sum + val, 0) / 60;

            return {
                working: Math.round(working * 100) / 100,
                stopped: Math.round(stopped * 100) / 100,
                shutdown: Math.round(shutdown * 100) / 100
            };
        }

        /**
         * –ê–≥—Ä–µ–≥–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ —Ü–µ—Ö–∞ –∏–∑ –ø–æ—á–∞—Å–æ–≤—ã—Ö –æ—Ç—á–µ—Ç–æ–≤
         */
        async function aggregateWorkshopDataFromHourly(workshop, startDate, endDate) {
            let totalWorking = 0;
            let totalStopped = 0;
            let totalShutdown = 0;

            const start = new Date(startDate);
            const end = new Date(endDate);
            const current = new Date(start);

            while (current <= end) {
                const dateStr = current.toISOString().split('T')[0];
                try {
                    const response = await fetch(`${API_BASE_URL}/api/workshops/hourly?date=${dateStr}&workshop=${workshop}`);
                    const data = await handleApiResponse(response);

                    // –°—É–º–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞ –¥–µ–Ω—å
                    if (data.data && data.data.datasets) {
                        totalWorking += data.data.datasets[0].data.reduce((a, b) => a + b, 0);
                        totalStopped += data.data.datasets[1].data.reduce((a, b) => a + b, 0);
                        totalShutdown += data.data.datasets[2].data.reduce((a, b) => a + b, 0);
                    }
                } catch (error) {
                    console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∑–∞ ${dateStr}:`, error);
                }
                current.setDate(current.getDate() + 1);
            }

            // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –º–∏–Ω—É—Ç—ã –≤ —á–∞—Å—ã
            return {
                working: totalWorking / 60,
                stopped: totalStopped / 60,
                shutdown: totalShutdown / 60
            };
        }

        /**
         * –û–±–Ω–æ–≤–ª—è–µ—Ç –≥—Ä–∞—Ñ–∏–∫–∏ –¥–ª—è —Ä–µ–∂–∏–º–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ü–µ—Ö–æ–≤
         */
        async function updateWorkshopCharts() {
            console.log('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–æ–≤ —Ü–µ—Ö–æ–≤');
            
            const periodText = formatPeriod(DOM.startDate.value, DOM.endDate.value);
            const selectedWorkshop = DOM.workshopFilter.value;
            
            // 1. –ö—Ä—É–≥–æ–≤–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ (–æ–±—â–∏–µ –¥–∞–Ω–Ω—ã–µ)
            pieChart.data.datasets[0].data = [
                workshopData.total.working || 0,
                workshopData.total.stopped || 0,
                workshopData.total.shutdown || 0
            ];
            
            // 2. –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è —Å—Ç–æ–ª–±—á–∞—Ç–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ (—Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ü–µ—Ö–æ–≤)
            if (selectedWorkshop === 'all') {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ —Ü–µ—Ö–∞ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
                horizontalBarChart.data.labels = workshopDistribution.workshops.map(w => w.name);
                horizontalBarChart.data.datasets[0].data = workshopDistribution.workshops.map(w => 
                    workshopData[w.id]?.shutdown || 0
                );
                horizontalBarChart.data.datasets[1].data = workshopDistribution.workshops.map(w => 
                    workshopData[w.id]?.stopped || 0
                );
                horizontalBarChart.data.datasets[2].data = workshopDistribution.workshops.map(w => 
                    workshopData[w.id]?.working || 0
                );
            } else {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ü–µ—Ö
                const workshop = workshopDistribution.workshops.find(w => w.id.toString() === selectedWorkshop);
                horizontalBarChart.data.labels = [workshop?.name || `–¶–µ—Ö ${selectedWorkshop}`];
                horizontalBarChart.data.datasets[0].data = [workshopData[selectedWorkshop]?.shutdown || 0];
                horizontalBarChart.data.datasets[1].data = [workshopData[selectedWorkshop]?.stopped || 0];
                horizontalBarChart.data.datasets[2].data = [workshopData[selectedWorkshop]?.working || 0];
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø–µ—Ä–∏–æ–¥–∞
            const workshopText = selectedWorkshop === 'all' ? '–í—Å–µ —Ü–µ—Ö–∞' : getWorkshopName(selectedWorkshop);
            
            if (currentPeriod === 'day') {
                document.getElementById('pieChartTitle').textContent = 
                    `–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å—Ç–∞–Ω–∫–æ–≤ ${workshopText} –∑–∞ ${periodText}`;
                document.getElementById('horizontalBarChartTitle').textContent = 
                    selectedWorkshop === 'all' 
                        ? `–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ü–µ—Ö–æ–≤ –∑–∞ ${periodText}`
                        : `–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å—Ç–∞–Ω–∫–æ–≤ —Ü–µ—Ö–∞ –∑–∞ ${periodText}`;
            } else {
                document.getElementById('pieChartTitle').textContent = 
                    `–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å—Ç–∞–Ω–∫–æ–≤ ${workshopText} (${periodText})`;
                document.getElementById('horizontalBarChartTitle').textContent = 
                    selectedWorkshop === 'all' 
                        ? `–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ü–µ—Ö–æ–≤ (${periodText})`
                        : `–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å—Ç–∞–Ω–∫–æ–≤ —Ü–µ—Ö–∞ (${periodText})`;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ –≥—Ä–∞—Ñ–∏–∫–∏
            try {
                pieChart.update();
                horizontalBarChart.update();
                console.log('–ì—Ä–∞—Ñ–∏–∫–∏ —Ü–µ—Ö–æ–≤ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã');
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ —Ü–µ—Ö–æ–≤:', e);
            }
        }

        /**
         * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø–µ—Ä–∏–æ–¥ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
         * @param {string} period - –¢–∏–ø –ø–µ—Ä–∏–æ–¥–∞ (day, week, month, year)
         */
        function setPeriod(period) {
            console.log(`–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–µ—Ä–∏–æ–¥–∞: ${period}`);
            
            currentPeriod = period;
            const today = new Date();
            let startDate, endDate;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É –ø–µ—Ä–∏–æ–¥–∞
            document.querySelectorAll('.period-buttons button').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.toLowerCase().includes(period)) {
                    btn.classList.add('active');
                }
            });
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞—Ç—ã –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –ø–µ—Ä–∏–æ–¥–æ–º
            switch (period) {
                case 'day':
                    // –î–ª—è –ø–µ—Ä–∏–æ–¥–∞ "–î–µ–Ω—å" –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â–∏–π –¥–µ–Ω—å
                    startDate = new Date(today);
                    endDate = new Date(today);
                    break;
                    
                case 'week':
                    startDate = new Date(today);
                    startDate.setDate(today.getDate() - today.getDay());
                    endDate = new Date(today);
                    endDate.setDate(today.getDate() + (6 - today.getDay()));
                    break;
                    
                case 'month':
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                    break;
                    
                case 'year':
                    startDate = new Date(today.getFullYear(), 0, 1);
                    endDate = new Date(today.getFullYear(), 11, 31);
                    break;
            }
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞—Ç—ã –≤ –ø–æ–ª—è—Ö –≤–≤–æ–¥–∞
            DOM.startDate.valueAsDate = startDate;
            DOM.endDate.valueAsDate = endDate;
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Ä–µ–∂–∏–º–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
            if (currentViewMode === 'workshop') {
                loadWorkshopData();
            } else {
                const machineId = DOM.machineFilter.value;
                if (machineId && machineId !== 'all') {
                    loadMachineData(machineId);
                }
            }
        }

        /**
         * –ü–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç —Ä–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –Ω–∞ —Ü–µ—Ö–∞
         */
        function showWorkshopView() {
            console.log('–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤ —Ä–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ü–µ—Ö–æ–≤');
            currentViewMode = 'workshop';
            DOM.workshopCharts.style.display = 'grid';
            DOM.individualCharts.style.display = 'none';
            loadWorkshopData();
        }

        /**
         * –ü–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç —Ä–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å—Ç–∞–Ω–æ–∫
         */
        function showMachineView() {
            console.log('–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤ —Ä–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å—Ç–∞–Ω–∫–∞');
            currentViewMode = 'individual';
            DOM.workshopCharts.style.display = 'none';
            DOM.individualCharts.style.display = 'grid';
            
            const machineId = DOM.machineFilter.value;
            if (machineId && machineId !== 'all') {
                loadMachineData(machineId);
            }
        }

        /**
         * –ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ —Å—Ç–∞–Ω–∫–∞
         */
        async function loadMachineData(machineId) {
            try {
                showLoadingIndicator(`–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å—Ç–∞–Ω–∫–∞ ${machineId}...`);
                
                const startDate = DOM.startDate.value;
                const endDate = DOM.endDate.value;
                
                if (!startDate || !endDate) {
                    showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –Ω–∞—á–∞–ª—å–Ω—É—é –∏ –∫–æ–Ω–µ—á–Ω—É—é –¥–∞—Ç—É', 'error');
                    return;
                }

                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ —Å—Ç–∞–Ω–∫–∞
                const statusResponse = await fetch(
                    `${API_BASE_URL}/api/machines/${machineId}/history/summary?startDate=${startDate}&endDate=${endDate}`
                );
                const statusData = await handleApiResponse(statusResponse);
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –¥–µ—Ç–∞–ª—è—Ö –¥–ª—è —Å—Ç–∞–Ω–∫–∞
                const partsResponse = await fetch(
                    `${API_BASE_URL}/api/machines/${machineId}/parts-daily?startDate=${startDate}&endDate=${endDate}`
                );
                const partsData = await handleApiResponse(partsResponse);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫–∏
                updateMachineCharts(machineId, statusData.data, partsData.data, partsData.total);
                
                showNotification(`–î–∞–Ω–Ω—ã–µ –¥–ª—è —Å—Ç–∞–Ω–∫–∞ ${machineId} —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã`, 'success');
                
            } catch (error) {
                console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å—Ç–∞–Ω–∫–∞ ${machineId}:`, error);
                showNotification(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å—Ç–∞–Ω–∫–∞: ${error.message}`, 'error');
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–ª–µ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
                updateMachineCharts(machineId, {working: 0, stopped: 0, shutdown: 0}, null, 0);
            } finally {
                hideLoadingIndicator();
            }
        }

        /**
         * –û–±–Ω–æ–≤–ª—è–µ—Ç –≥—Ä–∞—Ñ–∏–∫–∏ –¥–ª—è –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ —Å—Ç–∞–Ω–∫–∞
         */
        function updateMachineCharts(machineId, statusData, partsData, totalParts) {
            console.log('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–æ–≤ –¥–ª—è —Å—Ç–∞–Ω–∫–∞', machineId, statusData, partsData);
            
            const machine = machinesList.find(m => m.id === machineId);
            const machineName = machine ? machine.name : `–°—Ç–∞–Ω–æ–∫ ${machineId}`;
            const periodText = formatPeriod(DOM.startDate.value, DOM.endDate.value);
            
            // 1. –ì—Ä–∞—Ñ–∏–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å—Ç–∞–Ω–∫–∞
            machineStatusChart.data.datasets[0].data = [
                statusData.shutdown || 0,
                statusData.stopped || 0,
                statusData.working || 0
            ];
            
            document.getElementById('machineStatusTitle').textContent = 
                `–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å—Ç–∞–Ω–∫–∞ ${machineName} (${periodText})`;
            
            // 2. –ì—Ä–∞—Ñ–∏–∫ –¥–µ—Ç–∞–ª–µ–π
            if (partsData && partsData.labels && partsData.datasets) {
                machinePartsChart.data.labels = partsData.labels;
                machinePartsChart.data.datasets[0].data = partsData.datasets[0].data;
            } else {
                // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–ª–µ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
                const start = new Date(DOM.startDate.value);
                const end = new Date(DOM.endDate.value);
                const days = [];
                const partsDataArray = [];
                
                let currentDate = new Date(start);
                while (currentDate <= end) {
                    days.push(currentDate.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' }));
                    partsDataArray.push(0);
                    currentDate.setDate(currentDate.getDate() + 1);
                }
                
                machinePartsChart.data.labels = days;
                machinePartsChart.data.datasets[0].data = partsDataArray;
            }
            
            document.getElementById('machinePartsTitle').textContent = 
                `–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ—Ç–∞–ª–µ–π —Å—Ç–∞–Ω–∫–∞ ${machineName} (${periodText})`;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ—Ç–∞–ª–µ–π
            document.querySelector('#machineTotalParts span').textContent = totalParts || 0;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫–∏
            try {
                machineStatusChart.update();
                machinePartsChart.update();
                console.log('–ì—Ä–∞—Ñ–∏–∫–∏ —Å—Ç–∞–Ω–∫–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã');
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ —Å—Ç–∞–Ω–∫–∞:', e);
            }
        }

        /**
         * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –≤—Å–µ –≥—Ä–∞—Ñ–∏–∫–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
         */
        function initCharts() {
            console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤...');
            
            // 1. –ö—Ä—É–≥–æ–≤–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ (—Å—Ç–∞—Ç—É—Å—ã —Å—Ç–∞–Ω–∫–æ–≤)
            const pieCtx = document.getElementById('pieChart').getContext('2d');
            pieChart = new Chart(pieCtx, {
                type: 'pie',
                data: {
                    labels: Object.values(STATUS_LABELS),
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: [
                            STATUS_COLORS[STATUS.WORKING],
                            STATUS_COLORS[STATUS.STOPPED],
                            STATUS_COLORS[STATUS.SHUTDOWN]
                        ],
                        borderColor: '#fff',
                        borderWidth: 1,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            position: 'top',
                            labels: {
                                padding: 20,
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                    return `${label}: ${value} —á (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });

            // 2. –ì—Ä–∞—Ñ–∏–∫ –¥–µ—Ç–∞–ª–µ–π –ø–æ –¥–Ω—è–º (–¥–ª—è —Ü–µ—Ö–æ–≤)
            const partsCtx = document.getElementById('partsChart').getContext('2d');
            partsChart = new Chart(partsCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ—Ç–∞–ª–µ–π',
                        data: [],
                        backgroundColor: 'rgba(54, 162, 235, 0.7)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1,
                        borderRadius: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ—Ç–∞–ª–µ–π'
                            },
                            ticks: {
                                precision: 0
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '–î–∞—Ç—ã'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `–î–µ—Ç–∞–ª–∏: ${context.parsed.y}`;
                                }
                            }
                        }
                    }
                }
            });

            // 3. –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è —Å—Ç–æ–ª–±—á–∞—Ç–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ (—Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ü–µ—Ö–æ–≤)
            const horizontalBarCtx = document.getElementById('horizontalBarChart').getContext('2d');
            horizontalBarChart = new Chart(horizontalBarCtx, {
                type: 'bar',
                data: {
                    labels: ['–¶–µ—Ö 1', '–¶–µ—Ö 2'],
                    datasets: [
                        {
                            label: STATUS_LABELS[STATUS.SHUTDOWN],
                            data: [0, 0],
                            backgroundColor: STATUS_COLORS[STATUS.SHUTDOWN],
                            borderColor: '#fff',
                            borderWidth: 1
                        },
                        {
                            label: STATUS_LABELS[STATUS.STOPPED],
                            data: [0, 0],
                            backgroundColor: STATUS_COLORS[STATUS.STOPPED],
                            borderColor: '#fff',
                            borderWidth: 1
                        },
                        {
                            label: STATUS_LABELS[STATUS.WORKING],
                            data: [0, 0],
                            backgroundColor: STATUS_COLORS[STATUS.WORKING],
                            borderColor: '#fff',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                padding: 15,
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.x} —á`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            stacked: true,
                            title: {
                                display: true,
                                text: '–í—Ä–µ–º—è (—á–∞—Å—ã)'
                            }
                        },
                        y: {
                            stacked: true
                        }
                    }
                }
            });

            // 4. –ì—Ä–∞—Ñ–∏–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ —Å—Ç–∞–Ω–∫–∞
            const machineStatusCtx = document.getElementById('machineStatusChart').getContext('2d');
            machineStatusChart = new Chart(machineStatusCtx, {
                type: 'pie',
                data: {
                    labels: Object.values(STATUS_LABELS),
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: [
                            STATUS_COLORS[STATUS.SHUTDOWN],
                            STATUS_COLORS[STATUS.STOPPED],
                            STATUS_COLORS[STATUS.WORKING]
                        ],
                        borderColor: '#fff',
                        borderWidth: 1,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            position: 'top',
                            labels: {
                                padding: 20,
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                    return `${label}: ${value} —á (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });

            // 5. –ì—Ä–∞—Ñ–∏–∫ –¥–µ—Ç–∞–ª–µ–π –¥–ª—è –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ —Å—Ç–∞–Ω–∫–∞
            const machinePartsCtx = document.getElementById('machinePartsChart').getContext('2d');
            machinePartsChart = new Chart(machinePartsCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ—Ç–∞–ª–µ–π',
                        data: [],
                        backgroundColor: 'rgba(255, 159, 64, 0.7)',
                        borderColor: 'rgba(255, 159, 64, 1)',
                        borderWidth: 1,
                        borderRadius: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ—Ç–∞–ª–µ–π'
                            },
                            ticks: {
                                precision: 0
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '–î–∞—Ç—ã'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `–î–µ—Ç–∞–ª–∏: ${context.parsed.y}`;
                                }
                            }
                        }
                    }
                }
            });

            console.log('–í—Å–µ –≥—Ä–∞—Ñ–∏–∫–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã');
        }

        /**
         * –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
         */
        function startDistributionRefresh() {
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 2 –º–∏–Ω—É—Ç—ã
            setInterval(async () => {
                console.log('üîÑ –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è...');
                await loadWorkshopDistribution();
            }, 120000); // 2 –º–∏–Ω—É—Ç—ã
        }

        /**
         * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—É
         */
        async function initPage() {
            console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≥—Ä–∞—Ñ–∏–∫–æ–≤...');
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            const today = new Date();
            DOM.startDate.valueAsDate = today;
            DOM.endDate.valueAsDate = today;
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≥—Ä–∞—Ñ–∏–∫–∏
            initCharts();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç–∞–Ω–∫–æ–≤
            try {
                await loadWorkshopDistribution();
                console.log('‚úÖ –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ, –∑–∞–ø—É—Å–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö...');
                
                // –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å—Ç–∞–Ω–∫–æ–≤
                loadMachineList();
                startDistributionRefresh();
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è:', error);
                // –í—Å–µ —Ä–∞–≤–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É —Å—Ç–∞–Ω–∫–æ–≤
                loadMachineList();
            }
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
            DOM.workshopFilter.addEventListener('change', function() {
                console.log('–ò–∑–º–µ–Ω–µ–Ω —Ñ–∏–ª—å—Ç—Ä —Ü–µ—Ö–∞:', this.value);
                updateMachineFilter();
                
                if (currentViewMode === 'workshop') {
                    loadWorkshopData();
                }
            });
            
            DOM.machineFilter.addEventListener('change', function() {
                console.log('–ò–∑–º–µ–Ω–µ–Ω —Ñ–∏–ª—å—Ç—Ä —Å—Ç–∞–Ω–∫–∞:', this.value);
                
                if (this.value === 'all') {
                    showWorkshopView();
                } else {
                    showMachineView();
                }
            });
            
            DOM.applyFilters.addEventListener('click', function() {
                console.log('–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤');
                
                if (currentViewMode === 'workshop') {
                    loadWorkshopData();
                } else {
                    const machineId = DOM.machineFilter.value;
                    if (machineId && machineId !== 'all') {
                        loadMachineData(machineId);
                    }
                }
            });
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–∏–æ–¥ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            setPeriod('day');
            
            console.log('–°—Ç—Ä–∞–Ω–∏—Ü–∞ –≥—Ä–∞—Ñ–∏–∫–æ–≤ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', initPage);
    </script>
</body>
</html>