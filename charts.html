<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Графики анализа станков</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment"></script>
    <link rel="icon" type="image/x-icon" href="images/favicon.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="styles2.css">
   
</head>
<body>
    <!-- Шапка страницы -->
    <header>
        <h1>Графики анализа станков</h1>
        <button class="logout-button" onclick="location.href='login.html'">
            <i class="fas fa-sign-out-alt"></i> Выйти
        </button>
    </header>
    
    <!-- Навигационное меню -->
    <nav>
        <button onclick="location.href='dashboard.html'">
            <i class="fas fa-tachometer-alt"></i> Дашборды
        </button>
        <button class="active" onclick="location.href='charts.html'">
            <i class="fas fa-chart-line"></i> Графики анализа
        </button>
        <button onclick="location.href='reports.html'">
            <i class="fas fa-file-alt"></i> Конструктор отчетов
        </button>
        <button onclick="location.href='settings.html'">
            <i class="fas fa-cog"></i> Настройки
        </button>
    </nav>
    
    <!-- Основной контейнер -->
    <div class="container">
        <!-- Боковая панель с фильтрами -->
        <div class="sidebar">
            <h3><i class="fas fa-industry"></i> Цех</h3>
            <select id="workshopFilter">
                <option value="all">Все цеха</option>
                <!-- Цеха будут добавляться динамически -->
            </select>
            
            <h3><i class="fas fa-filter"></i> Фильтр по станкам</h3>
            <select id="machineFilter">
                <option value="all">Все станки</option>
                <!-- Станки будут добавляться динамически -->
            </select>
            
            <h3><i class="fas fa-calendar-alt"></i> Период</h3>
            <div class="period-buttons">
                <button class="active" onclick="setPeriod('day')"><i class="fas fa-calendar-day"></i> День</button>
                <button onclick="setPeriod('week')"><i class="fas fa-calendar-week"></i> Неделя</button>
                <button onclick="setPeriod('month')"><i class="fas fa-calendar"></i> Месяц</button>
                <button onclick="setPeriod('year')"><i class="fas fa-calendar"></i> Год</button>
            </div>
            
            <div>
                <label for="startDate"><i class="fas fa-clock"></i> Начальная дата:</label>
                <input type="date" id="startDate">
            </div>
            <div>
                <label for="endDate"><i class="fas fa-clock"></i> Конечная дата:</label>
                <input type="date" id="endDate">
            </div>
            
            <button id="applyFilters" class="filter-btn">
                <i class="fas fa-filter"></i> Применить фильтры
            </button>

            <div class="settings-info">
                <h3><i class="fas fa-info-circle"></i> Информация</h3>
                <div id="settingsStatus">
                    <i class="fas fa-sync fa-spin"></i> Загрузка настроек...
                </div>
                <div id="workshopsInfo"></div>
            </div>
        </div>
        
        <!-- Основное содержимое -->
        <div class="content">
            <!-- Графики для режима просмотра цехов -->
            <div id="workshopCharts" class="charts-row">
                <div class="chart-container">
                    <h3 class="chart-title" id="pieChartTitle">Состояние станков (круговая диаграмма)</h3>
                    <canvas id="pieChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title" id="partsChartTitle">Количество деталей по дням</h3>
                    <canvas id="partsChart"></canvas>
                    <div id="totalParts" class="total-parts">
                        Всего деталей за выбранный период: <span>0</span>
                    </div>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title" id="horizontalBarChartTitle">Состояние станков (горизонтальные столбцы)</h3>
                    <canvas id="horizontalBarChart"></canvas>
                </div>
            </div>
            
            <!-- Графики для режима просмотра отдельных станков -->
            <div id="individualCharts" style="display: none;" class="charts-row">
                <div class="chart-container">
                    <h3 class="chart-title" id="machineStatusTitle">Состояние станка</h3>
                    <canvas id="machineStatusChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title" id="machinePartsTitle">Количество деталей</h3>
                    <canvas id="machinePartsChart"></canvas>
                    <div id="machineTotalParts" class="total-parts">
                        Всего деталей за выбранный период: <span>0</span>
                    </div>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title" id="machineHourlyTitle">Работа по часам</h3>
                    <canvas id="machineHourlyChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Уведомления -->
    <div class="notification" id="notification"></div>

    <!-- Подключаем менеджер настроек -->
    <script src="settings-manager.js"></script>
    
    <!-- Основной JavaScript код -->
    <script>
        // Базовый URL API аналитики
        const API_BASE_URL = 'http://localhost:3001';
        const SETTINGS_API_URL = 'http://localhost:3004';
        
        // Константы для состояний станков (совместимые с dashboard.html)
        const STATUS = {
            WORKING: 'working',
            STOPPED: 'stopped',
            SHUTDOWN: 'shutdown'
        };
        
        // Цвета для разных состояний
        const STATUS_COLORS = {
            [STATUS.WORKING]: '#2ecc71',
            [STATUS.STOPPED]: '#e74c3c',
            [STATUS.SHUTDOWN]: '#95a5a6'
        };
        
        // Названия состояний
        const STATUS_LABELS = {
            [STATUS.WORKING]: 'Работает',
            [STATUS.STOPPED]: 'Остановлено',
            [STATUS.SHUTDOWN]: 'Выключено'
        };
        
        // Текущий выбранный период
        let currentPeriod = 'day';
        let currentViewMode = 'workshop';
        
        // Данные о станках
        let machinesList = [];
        let workshopData = {};
        
        // Объекты графиков
        let pieChart, partsChart, horizontalBarChart, machineStatusChart, machinePartsChart, machineHourlyChart;
        
        // Менеджер настроек
        const settingsManager = new SettingsManager();
        
        // DOM элементы
        const DOM = {
            workshopFilter: document.getElementById('workshopFilter'),
            machineFilter: document.getElementById('machineFilter'),
            notification: document.getElementById('notification'),
            startDate: document.getElementById('startDate'),
            endDate: document.getElementById('endDate'),
            applyFilters: document.getElementById('applyFilters'),
            workshopCharts: document.getElementById('workshopCharts'),
            individualCharts: document.getElementById('individualCharts'),
            settingsStatus: document.getElementById('settingsStatus'),
            workshopsInfo: document.getElementById('workshopsInfo')
        };

        /**
         * Загружает настройки цехов и станков
         */
        async function loadSettings() {
            try {
                DOM.settingsStatus.innerHTML = '<i class="fas fa-sync fa-spin"></i> Загрузка настроек...';
                
                const success = await settingsManager.loadSettings();
                if (success) {
                    DOM.settingsStatus.innerHTML = '<i class="fas fa-check-circle" style="color: #2ecc71;"></i> Настройки загружены';
                    updateWorkshopsInfo();
                    return true;
                } else {
                    DOM.settingsStatus.innerHTML = '<i class="fas fa-exclamation-triangle" style="color: #e74c3c;"></i> Ошибка загрузки';
                    return false;
                }
            } catch (error) {
                console.error('Ошибка загрузки настроек:', error);
                DOM.settingsStatus.innerHTML = '<i class="fas fa-exclamation-triangle" style="color: #e74c3c;"></i> Ошибка загрузки';
                return false;
            }
        }

        /**
         * Обновляет информацию о цехах в сайдбаре
         */
        function updateWorkshopsInfo() {
            const workshops = settingsManager.getWorkshops();
            let infoHTML = '';
            
            workshops.forEach(workshop => {
                const machines = settingsManager.getMachinesForWorkshop(workshop.id);
                infoHTML += `
                    <div class="workshop-info-item">
                        <strong>${workshop.name}</strong>: ${machines.length} станков
                    </div>
                `;
            });
            
            DOM.workshopsInfo.innerHTML = infoHTML;
        }

        /**
         * Обновляет фильтр цехов на основе настроек
         */
        function updateWorkshopFilter() {
            console.log('Обновление фильтра цехов...');
            
            const currentWorkshop = DOM.workshopFilter.value;
            DOM.workshopFilter.innerHTML = '<option value="all">Все цеха</option>';
            
            const workshops = settingsManager.getWorkshops();
            workshops.forEach(workshop => {
                const option = document.createElement('option');
                option.value = workshop.id;
                option.textContent = workshop.name;
                DOM.workshopFilter.appendChild(option);
            });
            
            // Восстанавливаем выбранное значение
            if (currentWorkshop && DOM.workshopFilter.querySelector(`option[value="${currentWorkshop}"]`)) {
                DOM.workshopFilter.value = currentWorkshop;
            }
            
            console.log('Фильтр цехов обновлен:', workshops.length, 'цехов');
        }

        /**
         * Форматирует период для отображения в заголовках
         */
        function formatPeriod(startDateStr, endDateStr) {
            const startDate = new Date(startDateStr);
            const endDate = new Date(endDateStr);
            
            // Если выбран период "День", показываем только одну дату
            if (currentPeriod === 'day') {
                return startDateStr;
            }
            
            // Для других периодов показываем диапазон, если даты разные
            if (startDateStr === endDateStr) {
                return startDateStr;
            }
            return `${startDateStr} - ${endDateStr}`;
        }

        /**
         * Показывает уведомление
         */
        function showNotification(message, type = 'success', duration = 3000) {
            DOM.notification.innerHTML = '';
            
            const content = document.createElement('div');
            content.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : 
                                  type === 'error' ? 'fa-exclamation-circle' : 
                                  'fa-spinner fa-spin'}"></i>
                <span>${message}</span>
            `;
            
            DOM.notification.className = `notification show ${type}`;
            DOM.notification.appendChild(content);
            
            if (type !== 'loading') {
                setTimeout(() => {
                    DOM.notification.classList.remove('show');
                }, duration);
            }
        }

        /**
         * Показывает индикатор загрузки
         */
        function showLoadingIndicator(message = 'Загрузка данных...') {
            showNotification(message, 'loading', 0);
        }

        /**
         * Скрывает индикатор загрузки
         */
        function hideLoadingIndicator() {
            if (DOM.notification.classList.contains('loading')) {
                DOM.notification.classList.remove('show');
                setTimeout(() => {
                    DOM.notification.className = 'notification';
                    DOM.notification.innerHTML = '';
                }, 300);
            }
        }

        /**
         * Обработчик ответов от API
         */
        async function handleApiResponse(response) {
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP error! status: ${response.status}, details: ${errorText}`);
            }
            
            const data = await response.json();
            
            if (!data.success) {
                throw new Error(data.error || 'Неизвестная ошибка сервера');
            }
            
            return data;
        }

        /**
         * Загружает список станков из настроек
         */
        async function loadMachineList() {
            try {
                showLoadingIndicator('Загрузка списка станков...');
                
                // Используем данные из настроек
                machinesList = settingsManager.getAllMachines().map(machine => ({
                    id: machine.id.toString(),
                    name: machine.name,
                    workshop: machine.workshop.toString()
                }));
                
                console.log('Получен список станков из настроек:', machinesList);
                updateMachineFilter();
                
            } catch (error) {
                console.error('Ошибка загрузки списка станков:', error);
                showNotification(`Ошибка загрузки списка станков: ${error.message}`, 'error');
            } finally {
                hideLoadingIndicator();
            }
        }
        
        /**
         * Обновляет фильтр станков на основе выбранного цеха
         */
        function updateMachineFilter() {
            console.log('Обновление фильтра станков...');
            
            const currentMachine = DOM.machineFilter.value;
            DOM.machineFilter.innerHTML = '<option value="all">Все станки</option>';
            
            const selectedWorkshop = DOM.workshopFilter.value;
            
            // Фильтруем станки по выбранному цеху
            const filteredMachines = selectedWorkshop === 'all' 
                ? machinesList 
                : machinesList.filter(machine => machine.workshop === selectedWorkshop);
            
            // Добавляем станки в фильтр
            filteredMachines.forEach(machine => {
                const option = document.createElement('option');
                option.value = machine.id;
                
                // Получаем название цеха
                const workshop = settingsManager.getWorkshops().find(w => w.id.toString() === machine.workshop);
                const workshopName = workshop ? workshop.name : `Цех ${machine.workshop}`;
                
                option.textContent = `${machine.name} (${workshopName}, ID: ${machine.id})`;
                DOM.machineFilter.appendChild(option);
            });
            
            if (currentMachine && DOM.machineFilter.querySelector(`option[value="${currentMachine}"]`)) {
                DOM.machineFilter.value = currentMachine;
            }
            
            console.log('Фильтр станков обновлен');
        }

        /**
         * Отладочная функция для проверки данных
         */
        function debugPartsData(chartData) {
            console.log('=== ДЕБАГ ДАННЫХ ДЕТАЛЕЙ ===');
            console.log('Labels:', chartData.labels);
            console.log('Data:', chartData.datasets[0].data);
            console.log('Total:', chartData.datasets[0].data.reduce((a, b) => a + b, 0));
            console.log('============================');
        }

        /**
         * Загружает данные о количестве деталей по дням
         */
        async function loadPartsData() {
            const startDate = DOM.startDate.value;
            const endDate = DOM.endDate.value;
            const workshop = DOM.workshopFilter.value;

            if (!startDate || !endDate) {
                console.log('Даты не выбраны, пропускаем загрузку данных о деталях');
                return;
            }

            try {
                showLoadingIndicator('Загрузка данных о деталях...');
                console.log(`Загрузка данных о деталях для цеха ${workshop} с ${startDate} по ${endDate}`);
                
                // Всегда используем эндпоинт для дневных данных
                const response = await fetch(
                    `${API_BASE_URL}/api/workshops/parts-daily?startDate=${startDate}&endDate=${endDate}&workshop=${workshop}`
                );
                const data = await handleApiResponse(response);
                
                console.log('Получены данные о деталях:', data);
                updatePartsChart(data.data, data.total);
                
            } catch (error) {
                console.error('Ошибка загрузки данных о деталях:', error);
                showNotification(`Ошибка загрузки данных о деталях: ${error.message}`, 'error');
                
                // Показываем нулевые данные при ошибке
                updatePartsChart(null, 0);
            } finally {
                hideLoadingIndicator();
            }
        }

        /**
         * Обновляет график количества деталей по дням
         */
        function updatePartsChart(chartData, totalParts) {
            console.log('Обновление графика деталей по дням', chartData, totalParts);
            
            // Если нет данных, показываем нулевые значения
            if (!chartData || !chartData.labels || !chartData.datasets) {
                console.warn('Нет данных для графика деталей, показываем нули');
                
                // Создаем данные для всех дней в выбранном периоде
                const start = new Date(DOM.startDate.value);
                const end = new Date(DOM.endDate.value);
                const days = [];
                const partsData = [];
                
                let currentDate = new Date(start);
                while (currentDate <= end) {
                    days.push(currentDate.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' }));
                    partsData.push(0);
                    currentDate.setDate(currentDate.getDate() + 1);
                }
                
                chartData = {
                    labels: days,
                    datasets: [{
                        label: 'Количество деталей',
                        data: partsData,
                        backgroundColor: 'rgba(54, 162, 235, 0.7)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1,
                        borderRadius: 3
                    }]
                };
                totalParts = 0;
            }

            // Отладочная информация
            debugPartsData(chartData);

            // Полностью обновляем данные графика
            partsChart.data.labels = chartData.labels;
            partsChart.data.datasets[0].data = chartData.datasets[0].data;
            
            // Обновляем заголовок в зависимости от периода
            const periodText = formatPeriod(DOM.startDate.value, DOM.endDate.value);
            const workshopText = DOM.workshopFilter.value === 'all' ? 'Все цеха' : getWorkshopName(DOM.workshopFilter.value);
            
            if (currentPeriod === 'day') {
                document.getElementById('partsChartTitle').textContent = 
                    `Количество деталей за ${periodText} (${workshopText})`;
            } else {
                document.getElementById('partsChartTitle').textContent = 
                    `Количество деталей по дням (${workshopText}, ${periodText})`;
            }
            
            // Обновляем общее количество
            document.querySelector('#totalParts span').textContent = totalParts;
            
            // Обновляем график
            try {
                partsChart.update('active');
                console.log('График деталей по дням успешно обновлен');
            } catch (e) {
                console.error('Ошибка обновления графика деталей по дням:', e);
            }
        }

        /**
         * Получает название цеха по ID
         */
        function getWorkshopName(workshopId) {
            const workshop = settingsManager.getWorkshops().find(w => w.id.toString() === workshopId);
            return workshop ? workshop.name : `Цех ${workshopId}`;
        }

        /**
         * Загружает данные по цехам
         */
        async function loadWorkshopData() {
            const startDate = DOM.startDate.value;
            const endDate = DOM.endDate.value;
            
            if (!startDate || !endDate) {
                showNotification('Пожалуйста, выберите начальную и конечную дату', 'error');
                return;
            }

            try {
                showLoadingIndicator('Загрузка данных цехов...');
                
                // Для периода "День" используем почасовые данные
                if (currentPeriod === 'day') {
                    await loadWorkshopDataForDay(startDate);
                } else {
                    // Для других периодов используем агрегацию данных
                    const selectedWorkshop = DOM.workshopFilter.value;
                    const workshops = settingsManager.getWorkshops();
                    
                    // Инициализируем данные для всех цехов
                    workshopData = {};
                    
                    if (selectedWorkshop === 'all') {
                        // Загружаем данные для всех цехов
                        for (const workshop of workshops) {
                            workshopData[`workshop${workshop.id}`] = 
                                await aggregateWorkshopDataFromHourly(workshop.id.toString(), startDate, endDate);
                        }
                    } else {
                        // Загружаем данные только для выбранного цеха
                        workshopData[`workshop${selectedWorkshop}`] = 
                            await aggregateWorkshopDataFromHourly(selectedWorkshop, startDate, endDate);
                    }
                    
                    // Рассчитываем общие данные
                    workshopData.total = calculateTotalWorkshopData(workshopData);
                    
                    console.log('Данные цехов:', workshopData);
                }
                
                updateWorkshopCharts();
                
                // Загружаем данные о деталях
                await loadPartsData();
                
                showNotification('Данные цехов успешно загружены', 'success');
                
            } catch (error) {
                console.error('Ошибка загрузки данных цехов:', error);
                showNotification(`Ошибка загрузки данных цехов: ${error.message}`, 'error');
            } finally {
                hideLoadingIndicator();
            }
        }

        /**
         * Рассчитывает общие данные по всем цехам
         */
        function calculateTotalWorkshopData(workshopData) {
            let totalWorking = 0;
            let totalStopped = 0;
            let totalShutdown = 0;
            
            Object.values(workshopData).forEach(data => {
                if (data && typeof data === 'object') {
                    totalWorking += data.working || 0;
                    totalStopped += data.stopped || 0;
                    totalShutdown += data.shutdown || 0;
                }
            });
            
            return {
                working: totalWorking,
                stopped: totalStopped,
                shutdown: totalShutdown
            };
        }

        /**
         * Загружает данные цехов для одного дня
         */
        async function loadWorkshopDataForDay(date) {
            try {
                const selectedWorkshop = DOM.workshopFilter.value;
                const workshops = settingsManager.getWorkshops();
                
                workshopData = {};
                
                if (selectedWorkshop === 'all') {
                    // Загружаем данные для всех цехов
                    for (const workshop of workshops) {
                        const data = await getWorkshopHourlyData(workshop.id.toString(), date);
                        workshopData[`workshop${workshop.id}`] = aggregateHourlyToDaily(data);
                    }
                } else {
                    // Загружаем данные только для выбранного цеха
                    const data = await getWorkshopHourlyData(selectedWorkshop, date);
                    workshopData[`workshop${selectedWorkshop}`] = aggregateHourlyToDaily(data);
                }
                
                // Рассчитываем общие данные
                workshopData.total = calculateTotalWorkshopData(workshopData);
                
                console.log('Данные цехов за день:', workshopData);
                
            } catch (error) {
                console.error('Ошибка загрузки данных цехов за день:', error);
                throw error;
            }
        }

        /**
         * Загружает почасовые данные для цеха за конкретный день
         */
        async function getWorkshopHourlyData(workshop, date) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/workshops/hourly?date=${date}&workshop=${workshop}`);
                const data = await handleApiResponse(response);
                return data.data;
            } catch (error) {
                console.error(`Ошибка загрузки почасовых данных для цеха ${workshop}:`, error);
                return null;
            }
        }

        /**
         * Агрегирует почасовые данные в общие за день
         */
        function aggregateHourlyToDaily(hourlyData) {
            if (!hourlyData || !hourlyData.datasets) {
                return { working: 0, stopped: 0, shutdown: 0 };
            }

            const working = hourlyData.datasets[0].data.reduce((sum, val) => sum + val, 0) / 60; // минуты в часы
            const stopped = hourlyData.datasets[1].data.reduce((sum, val) => sum + val, 0) / 60;
            const shutdown = hourlyData.datasets[2].data.reduce((sum, val) => sum + val, 0) / 60;

            return {
                working: Math.round(working * 100) / 100,
                stopped: Math.round(stopped * 100) / 100,
                shutdown: Math.round(shutdown * 100) / 100
            };
        }

        /**
         * Агрегирует данные цеха из почасовых отчетов
         */
        async function aggregateWorkshopDataFromHourly(workshop, startDate, endDate) {
            let totalWorking = 0;
            let totalStopped = 0;
            let totalShutdown = 0;

            const start = new Date(startDate);
            const end = new Date(endDate);
            const current = new Date(start);

            while (current <= end) {
                const dateStr = current.toISOString().split('T')[0];
                try {
                    const response = await fetch(`${API_BASE_URL}/api/workshops/hourly?date=${dateStr}&workshop=${workshop}`);
                    const data = await handleApiResponse(response);

                    // Суммируем данные за день
                    if (data.data && data.data.datasets) {
                        totalWorking += data.data.datasets[0].data.reduce((a, b) => a + b, 0);
                        totalStopped += data.data.datasets[1].data.reduce((a, b) => a + b, 0);
                        totalShutdown += data.data.datasets[2].data.reduce((a, b) => a + b, 0);
                    }
                } catch (error) {
                    console.error(`Ошибка загрузки данных за ${dateStr}:`, error);
                }
                current.setDate(current.getDate() + 1);
            }

            // Конвертируем минуты в часы
            return {
                working: totalWorking / 60,
                stopped: totalStopped / 60,
                shutdown: totalShutdown / 60
            };
        }

        /**
         * Обновляет графики для режима просмотра цехов
         */
        async function updateWorkshopCharts() {
            console.log('Обновление графиков цехов');
            
            const periodText = formatPeriod(DOM.startDate.value, DOM.endDate.value);
            const workshops = settingsManager.getWorkshops();
            const selectedWorkshop = DOM.workshopFilter.value;
            
            // 1. Круговая диаграмма (общие данные)
            if (workshopData.total) {
                pieChart.data.datasets[0].data = [
                    workshopData.total.working,
                    workshopData.total.stopped,
                    workshopData.total.shutdown
                ];
            }
            
            // 2. Горизонтальная столбчатая диаграмма (сравнение цехов)
            if (selectedWorkshop === 'all') {
                // Показываем все цеха
                horizontalBarChart.data.labels = workshops.map(w => w.name);
                horizontalBarChart.data.datasets[0].data = workshops.map(w => workshopData[`workshop${w.id}`]?.shutdown || 0);
                horizontalBarChart.data.datasets[1].data = workshops.map(w => workshopData[`workshop${w.id}`]?.stopped || 0);
                horizontalBarChart.data.datasets[2].data = workshops.map(w => workshopData[`workshop${w.id}`]?.working || 0);
            } else {
                // Показываем только выбранный цех
                const workshop = workshops.find(w => w.id.toString() === selectedWorkshop);
                horizontalBarChart.data.labels = [workshop ? workshop.name : `Цех ${selectedWorkshop}`];
                horizontalBarChart.data.datasets[0].data = [workshopData[`workshop${selectedWorkshop}`]?.shutdown || 0];
                horizontalBarChart.data.datasets[1].data = [workshopData[`workshop${selectedWorkshop}`]?.stopped || 0];
                horizontalBarChart.data.datasets[2].data = [workshopData[`workshop${selectedWorkshop}`]?.working || 0];
            }
            
            // Обновляем заголовки в зависимости от периода
            const workshopText = selectedWorkshop === 'all' ? 'Все цеха' : getWorkshopName(selectedWorkshop);
            
            if (currentPeriod === 'day') {
                document.getElementById('pieChartTitle').textContent = 
                    `Состояние станков ${workshopText} за ${periodText}`;
                document.getElementById('horizontalBarChartTitle').textContent = 
                    `Состояние цехов за ${periodText}`;
            } else {
                document.getElementById('pieChartTitle').textContent = 
                    `Состояние станков ${workshopText} (${periodText})`;
                document.getElementById('horizontalBarChartTitle').textContent = 
                    `Состояние цехов (${periodText})`;
            }
            
            // Обновляем все графики
            try {
                pieChart.update();
                horizontalBarChart.update();
                console.log('Графики цехов успешно обновлены');
            } catch (e) {
                console.error('Ошибка обновления графиков цехов:', e);
            }
        }

        /**
         * Устанавливает период для отображения данных
         */
        function setPeriod(period) {
            console.log(`Установка периода: ${period}`);
            
            currentPeriod = period;
            const today = new Date();
            let startDate, endDate;
            
            // Обновляем активную кнопку периода
            document.querySelectorAll('.period-buttons button').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.toLowerCase().includes(period)) {
                    btn.classList.add('active');
                }
            });
            
            // Устанавливаем даты в соответствии с периодом
            switch (period) {
                case 'day':
                    startDate = new Date(today);
                    endDate = new Date(today);
                    break;
                    
                case 'week':
                    startDate = new Date(today);
                    startDate.setDate(today.getDate() - today.getDay());
                    endDate = new Date(today);
                    endDate.setDate(today.getDate() + (6 - today.getDay()));
                    break;
                    
                case 'month':
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                    break;
                    
                case 'year':
                    startDate = new Date(today.getFullYear(), 0, 1);
                    endDate = new Date(today.getFullYear(), 11, 31);
                    break;
            }
            
            // Устанавливаем даты в полях ввода
            DOM.startDate.valueAsDate = startDate;
            DOM.endDate.valueAsDate = endDate;
            
            // Загружаем данные для текущего режима просмотра
            if (currentViewMode === 'workshop') {
                loadWorkshopData();
            } else {
                const machineId = DOM.machineFilter.value;
                if (machineId && machineId !== 'all') {
                    loadMachineData(machineId);
                }
            }
        }

        /**
         * Переключает режим просмотра на цеха
         */
        function showWorkshopView() {
            console.log('Переключение в режим просмотра цехов');
            currentViewMode = 'workshop';
            DOM.workshopCharts.style.display = 'grid';
            DOM.individualCharts.style.display = 'none';
            loadWorkshopData();
        }

        /**
         * Переключает режим просмотра на отдельный станок
         */
        function showMachineView() {
            console.log('Переключение в режим просмотра станка');
            currentViewMode = 'individual';
            DOM.workshopCharts.style.display = 'none';
            DOM.individualCharts.style.display = 'grid';
            
            const machineId = DOM.machineFilter.value;
            if (machineId && machineId !== 'all') {
                loadMachineData(machineId);
            }
        }

        /**
         * Загружает данные для отдельного станка
         */
        async function loadMachineData(machineId) {
            try {
                showLoadingIndicator(`Загрузка данных для станка ${machineId}...`);
                
                const startDate = DOM.startDate.value;
                const endDate = DOM.endDate.value;
                
                if (!startDate || !endDate) {
                    showNotification('Пожалуйста, выберите начальную и конечную дату', 'error');
                    return;
                }

                // Загружаем данные о состоянии станка
                const statusResponse = await fetch(
                    `${API_BASE_URL}/api/machines/${machineId}/history/summary?startDate=${startDate}&endDate=${endDate}`
                );
                const statusData = await handleApiResponse(statusResponse);
                
                // Загружаем данные о деталях для станка
                const partsResponse = await fetch(
                    `${API_BASE_URL}/api/machines/${machineId}/parts-daily?startDate=${startDate}&endDate=${endDate}`
                );
                const partsData = await handleApiResponse(partsResponse);
                
                // Загружаем почасовые данные для станка (только для периода "День")
                let hourlyData = null;
                if (currentPeriod === 'day') {
                    try {
                        const hourlyResponse = await fetch(
                            `${API_BASE_URL}/api/machines/${machineId}/hourly?date=${startDate}`
                        );
                        const hourlyResult = await handleApiResponse(hourlyResponse);
                        hourlyData = hourlyResult.data;
                    } catch (error) {
                        console.error('Ошибка загрузки почасовых данных:', error);
                    }
                }
                
                // Обновляем графики
                updateMachineCharts(machineId, statusData.data, partsData.data, partsData.total, hourlyData);
                
                showNotification(`Данные для станка ${machineId} успешно загружены`, 'success');
                
            } catch (error) {
                console.error(`Ошибка загрузки данных для станка ${machineId}:`, error);
                showNotification(`Ошибка загрузки данных для станка: ${error.message}`, 'error');
                
                // Показываем нулевые данные при ошибке
                updateMachineCharts(machineId, {working: 0, stopped: 0, shutdown: 0}, null, 0, null);
            } finally {
                hideLoadingIndicator();
            }
        }

        /**
         * Обновляет графики для отдельного станка
         */
        function updateMachineCharts(machineId, statusData, partsData, totalParts, hourlyData) {
            console.log('Обновление графиков для станка', machineId, statusData, partsData);
            
            const machine = machinesList.find(m => m.id === machineId);
            const machineName = machine ? machine.name : `Станок ${machineId}`;
            const periodText = formatPeriod(DOM.startDate.value, DOM.endDate.value);
            
            // 1. График состояния станка
            machineStatusChart.data.datasets[0].data = [
                statusData.shutdown || 0,
                statusData.stopped || 0,
                statusData.working || 0
            ];
            
            document.getElementById('machineStatusTitle').textContent = 
                `Состояние станка ${machineName} (${periodText})`;
            
            // 2. График деталей
            if (partsData && partsData.labels && partsData.datasets) {
                machinePartsChart.data.labels = partsData.labels;
                machinePartsChart.data.datasets[0].data = partsData.datasets[0].data;
            } else {
                // Если нет данных, показываем нулевые значения
                const start = new Date(DOM.startDate.value);
                const end = new Date(DOM.endDate.value);
                const days = [];
                const partsDataArray = [];
                
                let currentDate = new Date(start);
                while (currentDate <= end) {
                    days.push(currentDate.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' }));
                    partsDataArray.push(0);
                    currentDate.setDate(currentDate.getDate() + 1);
                }
                
                machinePartsChart.data.labels = days;
                machinePartsChart.data.datasets[0].data = partsDataArray;
            }
            
            document.getElementById('machinePartsTitle').textContent = 
                `Количество деталей станка ${machineName} (${periodText})`;
            
            // 3. График почасовых данных (только для периода "День")
            if (hourlyData && currentPeriod === 'day') {
                machineHourlyChart.data.labels = hourlyData.labels;
                machineHourlyChart.data.datasets[0].data = hourlyData.datasets[0].data;
                machineHourlyChart.data.datasets[1].data = hourlyData.datasets[1].data;
                machineHourlyChart.data.datasets[2].data = hourlyData.datasets[2].data;
                document.getElementById('machineHourlyTitle').textContent = 
                    `Работа станка ${machineName} по часам за ${periodText}`;
            } else {
                // Скрываем или очищаем график для других периодов
                machineHourlyChart.data.labels = [];
                machineHourlyChart.data.datasets.forEach(dataset => dataset.data = []);
                document.getElementById('machineHourlyTitle').textContent = 
                    `Работа станка ${machineName} по часам (только для периода "День")`;
            }
            
            // Обновляем общее количество деталей
            document.querySelector('#machineTotalParts span').textContent = totalParts || 0;
            
            // Обновляем графики
            try {
                machineStatusChart.update();
                machinePartsChart.update();
                machineHourlyChart.update();
                console.log('Графики станка успешно обновлены');
            } catch (e) {
                console.error('Ошибка обновления графиков станка:', e);
            }
        }

        /**
         * Инициализирует все графики на странице
         */
        function initCharts() {
            console.log('Инициализация графиков...');
            
            // 1. Круговая диаграмма (статусы станков)
            const pieCtx = document.getElementById('pieChart').getContext('2d');
            pieChart = new Chart(pieCtx, {
                type: 'pie',
                data: {
                    labels: Object.values(STATUS_LABELS),
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: [
                            STATUS_COLORS[STATUS.WORKING],
                            STATUS_COLORS[STATUS.STOPPED],
                            STATUS_COLORS[STATUS.SHUTDOWN]
                        ],
                        borderColor: '#fff',
                        borderWidth: 1,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            position: 'top',
                            labels: {
                                padding: 20,
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                    return `${label}: ${value} ч (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });

            // 2. График деталей по дням (для цехов)
            const partsCtx = document.getElementById('partsChart').getContext('2d');
            partsChart = new Chart(partsCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Количество деталей',
                        data: [],
                        backgroundColor: 'rgba(54, 162, 235, 0.7)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1,
                        borderRadius: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Количество деталей'
                            },
                            ticks: {
                                precision: 0
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Даты'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Детали: ${context.parsed.y}`;
                                }
                            }
                        }
                    }
                }
            });

            // 3. Горизонтальная столбчатая диаграмма (сравнение цехов)
            const horizontalBarCtx = document.getElementById('horizontalBarChart').getContext('2d');
            horizontalBarChart = new Chart(horizontalBarCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: STATUS_LABELS[STATUS.SHUTDOWN],
                            data: [],
                            backgroundColor: STATUS_COLORS[STATUS.SHUTDOWN],
                            borderColor: '#fff',
                            borderWidth: 1
                        },
                        {
                            label: STATUS_LABELS[STATUS.STOPPED],
                            data: [],
                            backgroundColor: STATUS_COLORS[STATUS.STOPPED],
                            borderColor: '#fff',
                            borderWidth: 1
                        },
                        {
                            label: STATUS_LABELS[STATUS.WORKING],
                            data: [],
                            backgroundColor: STATUS_COLORS[STATUS.WORKING],
                            borderColor: '#fff',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                padding: 15,
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.x} ч`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            stacked: true,
                            title: {
                                display: true,
                                text: 'Время (часы)'
                            }
                        },
                        y: {
                            stacked: true
                        }
                    }
                }
            });

            // 4. График состояния отдельного станка
            const machineStatusCtx = document.getElementById('machineStatusChart').getContext('2d');
            machineStatusChart = new Chart(machineStatusCtx, {
                type: 'pie',
                data: {
                    labels: Object.values(STATUS_LABELS),
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: [
                            STATUS_COLORS[STATUS.SHUTDOWN],
                            STATUS_COLORS[STATUS.STOPPED],
                            STATUS_COLORS[STATUS.WORKING]
                        ],
                        borderColor: '#fff',
                        borderWidth: 1,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            position: 'top',
                            labels: {
                                padding: 20,
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                    return `${label}: ${value} ч (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });

            // 5. График деталей для отдельного станка
            const machinePartsCtx = document.getElementById('machinePartsChart').getContext('2d');
            machinePartsChart = new Chart(machinePartsCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Количество деталей',
                        data: [],
                        backgroundColor: 'rgba(255, 159, 64, 0.7)',
                        borderColor: 'rgba(255, 159, 64, 1)',
                        borderWidth: 1,
                        borderRadius: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Количество деталей'
                            },
                            ticks: {
                                precision: 0
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Даты'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Детали: ${context.parsed.y}`;
                                }
                            }
                        }
                    }
                }
            });

            // 6. График почасовых данных для станка
            const machineHourlyCtx = document.getElementById('machineHourlyChart').getContext('2d');
            machineHourlyChart = new Chart(machineHourlyCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Работает',
                            data: [],
                            backgroundColor: 'rgba(46, 204, 113, 0.7)',
                            borderColor: 'rgba(46, 204, 113, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Остановлен',
                            data: [],
                            backgroundColor: 'rgba(231, 76, 60, 0.7)',
                            borderColor: 'rgba(231, 76, 60, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Выключен',
                            data: [],
                            backgroundColor: 'rgba(149, 165, 166, 0.7)',
                            borderColor: 'rgba(149, 165, 166, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: true,
                            title: {
                                display: true,
                                text: 'Часы'
                            }
                        },
                        y: {
                            stacked: true,
                            title: {
                                display: true,
                                text: 'Минуты'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    }
                }
            });

            console.log('Все графики инициализированы');
        }

        /**
         * Инициализирует страницу
         */
        async function initPage() {
            console.log('Инициализация страницы графиков...');
            
            // Сначала загружаем настройки
            await loadSettings();
            
            // Затем инициализируем фильтры
            updateWorkshopFilter();
            
            // Устанавливаем сегодняшнюю дату по умолчанию
            const today = new Date();
            DOM.startDate.valueAsDate = today;
            DOM.endDate.valueAsDate = today;
            
            // Инициализируем графики
            initCharts();
            
            // Загружаем список станков
            loadMachineList();
            
            // Устанавливаем обработчики событий
            DOM.workshopFilter.addEventListener('change', function() {
                console.log('Изменен фильтр цеха:', this.value);
                updateMachineFilter();
                
                if (currentViewMode === 'workshop') {
                    loadWorkshopData();
                }
            });
            
            DOM.machineFilter.addEventListener('change', function() {
                console.log('Изменен фильтр станка:', this.value);
                
                if (this.value === 'all') {
                    showWorkshopView();
                } else {
                    showMachineView();
                }
            });
            
            DOM.applyFilters.addEventListener('click', function() {
                console.log('Применение фильтров');
                
                if (currentViewMode === 'workshop') {
                    loadWorkshopData();
                } else {
                    const machineId = DOM.machineFilter.value;
                    if (machineId && machineId !== 'all') {
                        loadMachineData(machineId);
                    }
                }
            });
            
            // Устанавливаем период по умолчанию
            setPeriod('day');
            
            // Запускаем автоматическое обновление настроек
            settingsManager.startAutoRefresh();
            
            console.log('Страница графиков инициализирована');
        }

        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', initPage);
    </script>
</body>
</html>