<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Графики анализа станков</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment"></script>
    <link rel="icon" type="image/x-icon" href="images/favicon.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="styles2.css">
   
</head>
<body>
    <!-- Шапка страницы -->
    <header>
        <h1>Графики анализа станков</h1>
        <button class="logout-button" onclick="location.href='login.html'">
            <i class="fas fa-sign-out-alt"></i> Выйти
        </button>
    </header>
    
    <!-- Навигационное меню -->
    <nav>
        <button onclick="location.href='dashboard.html'">
            <i class="fas fa-tachometer-alt"></i> Дашборды
        </button>
        <button class="active" onclick="location.href='charts.html'">
            <i class="fas fa-chart-line"></i> Графики анализа
        </button>
        <button onclick="location.href='reports.html'">
            <i class="fas fa-file-alt"></i> Конструктор отчетов
        </button>
        <button onclick="location.href='settings.html'">
            <i class="fas fa-cog"></i> Настройки
        </button>
    </nav>
    
    <!-- Основной контейнер -->
    <div class="container">
        <!-- Боковая панель с фильтрами -->
        <div class="sidebar">
            <h3><i class="fas fa-industry"></i> Цех</h3>
            <select id="workshopFilter">
                <option value="all">Все цеха</option>
                <option value="1">Цех 1</option>
                <option value="2">Цех 2</option>
            </select>
            
            <h3><i class="fas fa-filter"></i> Фильтр по станкам</h3>
            <select id="machineFilter">
                <option value="all">Все станки</option>
            </select>
            
            <h3><i class="fas fa-calendar-alt"></i> Период</h3>
            <div class="period-buttons">
                <button class="active" onclick="setPeriod('day')"><i class="fas fa-calendar-day"></i> День</button>
                <button onclick="setPeriod('week')"><i class="fas fa-calendar-week"></i> Неделя</button>
                <button onclick="setPeriod('month')"><i class="fas fa-calendar"></i> Месяц</button>
                <button onclick="setPeriod('year')"><i class="fas fa-calendar"></i> Год</button>
            </div>
            
            <div>
                <label for="startDate"><i class="fas fa-clock"></i> Начальная дата:</label>
                <input type="date" id="startDate">
            </div>
            <div>
                <label for="endDate"><i class="fas fa-clock"></i> Конечная дата:</label>
                <input type="date" id="endDate">
            </div>
            
            <button id="applyFilters" class="filter-btn">
                <i class="fas fa-filter"></i> Применить фильтры
            </button>
        </div>
        
        <!-- Основное содержимое -->
        <div class="content">
            <!-- Графики для режима просмотра цехов -->
            <div id="workshopCharts" class="charts-row">
                <div class="chart-container">
                    <h3 class="chart-title" id="pieChartTitle">Состояние станков (круговая диаграмма)</h3>
                    <canvas id="pieChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title" id="partsChartTitle">Количество деталей по дням</h3>
                    <canvas id="partsChart"></canvas>
                    <div id="totalParts" class="total-parts">
                        Всего деталей за выбранный период: <span>0</span>
                    </div>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title" id="horizontalBarChartTitle">Состояние станков (горизонтальные столбцы)</h3>
                    <canvas id="horizontalBarChart"></canvas>
                </div>
            </div>
            
            <!-- Графики для режима просмотра отдельных станков -->
            <div id="individualCharts" style="display: none;">
                <div class="chart-container">
                    <h3 class="chart-title" id="chartTitle">Состояние станков</h3>
                    <canvas id="machineStatusChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title" id="timelineChartTitle">График изменения состояния</h3>
                    <canvas id="timelineChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Уведомления -->
    <div class="notification" id="notification"></div>
    
    <!-- Основной JavaScript код -->
    <script>
        // Базовый URL API аналитики
        const API_BASE_URL = 'http://localhost:3001';
        
        // Константы для состояний станков (совместимые с dashboard.html)
        const STATUS = {
            WORKING: 'working',
            STOPPED: 'stopped',
            SHUTDOWN: 'shutdown'
        };
        
        // Цвета для разных состояний
        const STATUS_COLORS = {
            [STATUS.WORKING]: '#2ecc71',
            [STATUS.STOPPED]: '#e74c3c',
            [STATUS.SHUTDOWN]: '#95a5a6'
        };
        
        // Названия состояний
        const STATUS_LABELS = {
            [STATUS.WORKING]: 'Работает',
            [STATUS.STOPPED]: 'Остановлено',
            [STATUS.SHUTDOWN]: 'Выключено'
        };
        
        // Текущий выбранный период
        let currentPeriod = 'day';
        let currentViewMode = 'workshop';
        
        // Данные о станках
        let machinesList = [];
        let workshopData = {
            '1': { working: 0, stopped: 0, shutdown: 0 },
            '2': { working: 0, stopped: 0, shutdown: 0 }
        };
        
        // Объекты графиков
        let pieChart, partsChart, horizontalBarChart, machineStatusChart, timelineChart;
        
        // DOM элементы
        const DOM = {
            workshopFilter: document.getElementById('workshopFilter'),
            machineFilter: document.getElementById('machineFilter'),
            notification: document.getElementById('notification'),
            startDate: document.getElementById('startDate'),
            endDate: document.getElementById('endDate'),
            applyFilters: document.getElementById('applyFilters'),
            workshopCharts: document.getElementById('workshopCharts'),
            individualCharts: document.getElementById('individualCharts')
        };

        /**
         * Форматирует период для отображения в заголовках
         */
        function formatPeriod(startDateStr, endDateStr) {
            const startDate = new Date(startDateStr);
            const endDate = new Date(endDateStr);
            
            // Если выбран период "День", показываем только одну дату
            if (currentPeriod === 'day') {
                return startDateStr;
            }
            
            // Для других периодов показываем диапазон, если даты разные
            if (startDateStr === endDateStr) {
                return startDateStr;
            }
            return `${startDateStr} - ${endDateStr}`;
        }

        /**
         * Показывает уведомление
         * @param {string} message - Текст сообщения
         * @param {string} type - Тип уведомления (success, error, loading)
         * @param {number} [duration=3000] - Время показа в миллисекундах
         */
        function showNotification(message, type = 'success', duration = 3000) {
            // Очищаем предыдущее уведомление
            DOM.notification.innerHTML = '';
            
            // Создаем содержимое уведомления
            const content = document.createElement('div');
            content.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : 
                                  type === 'error' ? 'fa-exclamation-circle' : 
                                  'fa-spinner fa-spin'}"></i>
                <span>${message}</span>
            `;
            
            // Устанавливаем классы и стили
            DOM.notification.className = `notification show ${type}`;
            DOM.notification.appendChild(content);
            
            // Автоматическое скрытие для не-loading уведомлений
            if (type !== 'loading') {
                setTimeout(() => {
                    DOM.notification.classList.remove('show');
                }, duration);
            }
        }

        /**
         * Показывает индикатор загрузки
         * @param {string} [message='Загрузка данных...'] - Текст сообщения
         */
        function showLoadingIndicator(message = 'Загрузка данных...') {
            showNotification(message, 'loading', 0);
        }

        /**
         * Скрывает индикатор загрузки
         */
        function hideLoadingIndicator() {
            if (DOM.notification.classList.contains('loading')) {
                DOM.notification.classList.remove('show');
                setTimeout(() => {
                    DOM.notification.className = 'notification';
                    DOM.notification.innerHTML = '';
                }, 300);
            }
        }

        /**
         * Обработчик ответов от API
         * @param {Response} response - Объект ответа fetch
         * @returns {Promise<object>} - Распарсенные данные
         * @throws {Error} - Если ответ не успешный
         */
        async function handleApiResponse(response) {
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP error! status: ${response.status}, details: ${errorText}`);
            }
            
            const data = await response.json();
            
            if (!data.success) {
                throw new Error(data.error || 'Неизвестная ошибка сервера');
            }
            
            return data;
        }

        /**
         * Проверяет, является ли дата сегодняшним днем
         * @param {string} dateString - Дата в формате YYYY-MM-DD
         * @returns {boolean} - true если дата сегодняшняя
         */
        function isToday(dateString) {
            const today = new Date();
            const todayFormatted = today.toISOString().split('T')[0];
            return dateString === todayFormatted;
        }

        /**
         * Загружает список станков с сервера
         */
        async function loadMachineList() {
            try {
                showLoadingIndicator('Загрузка списка станков...');
                console.log('Загрузка списка станков...');
                
                const response = await fetch(`${API_BASE_URL}/api/machines`);
                const data = await handleApiResponse(response);
                
                machinesList = Object.entries(data.machines).map(([id, machine]) => ({
                    id,
                    name: machine.name,
                    workshop: machine.workshop
                }));
                
                console.log('Получен список станков:', machinesList);
                updateMachineFilter();
                
            } catch (error) {
                console.error('Ошибка загрузки списка станков:', error);
                showNotification(`Ошибка загрузки списка станков: ${error.message}`, 'error');
            } finally {
                hideLoadingIndicator();
            }
        }
        
        /**
         * Обновляет фильтр станков на основе выбранного цеха
         */
        function updateMachineFilter() {
            console.log('Обновление фильтра станков...');
            
            // Сохраняем текущее выбранное значение
            const currentMachine = DOM.machineFilter.value;
            
            // Очищаем список
            DOM.machineFilter.innerHTML = '<option value="all">Все станки</option>';
            
            const selectedWorkshop = DOM.workshopFilter.value;
            
            // Фильтруем станки по выбранному цеху
            const filteredMachines = selectedWorkshop === 'all' 
                ? machinesList 
                : machinesList.filter(machine => machine.workshop === selectedWorkshop);
            
            // Добавляем станки в фильтр
            filteredMachines.forEach(machine => {
                const option = document.createElement('option');
                option.value = machine.id;
                option.textContent = `${machine.name} (ID: ${machine.id})`;
                DOM.machineFilter.appendChild(option);
            });
            
            // Восстанавливаем выбранное значение, если оно есть в новом списке
            if (currentMachine && DOM.machineFilter.querySelector(`option[value="${currentMachine}"]`)) {
                DOM.machineFilter.value = currentMachine;
            }
            
            console.log('Фильтр станков обновлен');
        }

        /**
         * Отладочная функция для проверки данных
         */
        function debugPartsData(chartData) {
            console.log('=== ДЕБАГ ДАННЫХ ДЕТАЛЕЙ ===');
            console.log('Labels:', chartData.labels);
            console.log('Data:', chartData.datasets[0].data);
            console.log('Total:', chartData.datasets[0].data.reduce((a, b) => a + b, 0));
            console.log('============================');
        }

        /**
         * Загружает данные о количестве деталей по дням
         */
        async function loadPartsData() {
            const startDate = DOM.startDate.value;
            const endDate = DOM.endDate.value;
            const workshop = DOM.workshopFilter.value;

            if (!startDate || !endDate) {
                console.log('Даты не выбраны, пропускаем загрузку данных о деталях');
                return;
            }

            try {
                showLoadingIndicator('Загрузка данных о деталях...');
                console.log(`Загрузка данных о деталях для цеха ${workshop} с ${startDate} по ${endDate}`);
                
                // Всегда используем эндпоинт для дневных данных
                const response = await fetch(
                    `${API_BASE_URL}/api/workshops/parts-daily?startDate=${startDate}&endDate=${endDate}&workshop=${workshop}`
                );
                const data = await handleApiResponse(response);
                
                console.log('Получены данные о деталях:', data);
                updatePartsChart(data.data, data.total);
                
            } catch (error) {
                console.error('Ошибка загрузки данных о деталях:', error);
                showNotification(`Ошибка загрузки данных о деталях: ${error.message}`, 'error');
                
                // Показываем нулевые данные при ошибке
                updatePartsChart(null, 0);
            } finally {
                hideLoadingIndicator();
            }
        }

        /**
         * Обновляет график количества деталей по дням
         * @param {object} chartData - Данные для графика
         * @param {number} totalParts - Общее количество деталей
         */
        function updatePartsChart(chartData, totalParts) {
            console.log('Обновление графика деталей по дням', chartData, totalParts);
            
            // Если нет данных, показываем нулевые значения
            if (!chartData || !chartData.labels || !chartData.datasets) {
                console.warn('Нет данных для графика деталей, показываем нули');
                
                // Создаем данные для всех дней в выбранном периоде
                const start = new Date(DOM.startDate.value);
                const end = new Date(DOM.endDate.value);
                const days = [];
                const partsData = [];
                
                let currentDate = new Date(start);
                while (currentDate <= end) {
                    days.push(currentDate.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' }));
                    partsData.push(0);
                    currentDate.setDate(currentDate.getDate() + 1);
                }
                
                chartData = {
                    labels: days,
                    datasets: [{
                        label: 'Количество деталей',
                        data: partsData,
                        backgroundColor: 'rgba(54, 162, 235, 0.7)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1,
                        borderRadius: 3
                    }]
                };
                totalParts = 0;
            }

            // Отладочная информация
            debugPartsData(chartData);

            // Полностью обновляем данные графика
            partsChart.data.labels = chartData.labels;
            partsChart.data.datasets[0].data = chartData.datasets[0].data;
            
            // Обновляем заголовок в зависимости от периода
            const periodText = formatPeriod(DOM.startDate.value, DOM.endDate.value);
            const workshopText = DOM.workshopFilter.value === 'all' ? 'Все цеха' : `Цех ${DOM.workshopFilter.value}`;
            
            if (currentPeriod === 'day') {
                document.getElementById('partsChartTitle').textContent = 
                    `Количество деталей за ${periodText} (${workshopText})`;
            } else {
                document.getElementById('partsChartTitle').textContent = 
                    `Количество деталей по дням (${workshopText}, ${periodText})`;
            }
            
            // Обновляем общее количество
            document.querySelector('#totalParts span').textContent = totalParts;
            
            // Обновляем график
            try {
                partsChart.update('active');
                console.log('График деталей по дням успешно обновлен');
            } catch (e) {
                console.error('Ошибка обновления графика деталей по дням:', e);
            }
        }

        /**
         * Загружает данные по цехам
         */
        async function loadWorkshopData() {
            const startDate = DOM.startDate.value;
            const endDate = DOM.endDate.value;
            
            if (!startDate || !endDate) {
                showNotification('Пожалуйста, выберите начальную и конечную дату', 'error');
                return;
            }

            try {
                showLoadingIndicator('Загрузка данных цехов...');
                
                // Для периода "День" используем почасовые данные
                if (currentPeriod === 'day') {
                    await loadWorkshopDataForDay(startDate);
                } else {
                    // Для других периодов используем агрегацию данных
                    const selectedWorkshop = DOM.workshopFilter.value;
                    
                    const workshop1Data = selectedWorkshop === 'all' || selectedWorkshop === '1' ? 
                        await aggregateWorkshopDataFromHourly('1', startDate, endDate) : 
                        { working: 0, stopped: 0, shutdown: 0 };
                        
                    const workshop2Data = selectedWorkshop === 'all' || selectedWorkshop === '2' ? 
                        await aggregateWorkshopDataFromHourly('2', startDate, endDate) : 
                        { working: 0, stopped: 0, shutdown: 0 };

                    workshopData = {
                        workshop1: workshop1Data,
                        workshop2: workshop2Data,
                        total: {
                            working: workshop1Data.working + workshop2Data.working,
                            stopped: workshop1Data.stopped + workshop2Data.stopped,
                            shutdown: workshop1Data.shutdown + workshop2Data.shutdown
                        }
                    };
                    
                    console.log('Данные цехов:', workshopData);
                    updateWorkshopCharts();
                }
                
                // Загружаем данные о деталях
                await loadPartsData();
                
                showNotification('Данные цехов успешно загружены', 'success');
                
            } catch (error) {
                console.error('Ошибка загрузки данных цехов:', error);
                showNotification(`Ошибка загрузки данных цехов: ${error.message}`, 'error');
            } finally {
                hideLoadingIndicator();
            }
        }

        /**
         * Загружает данные цехов для одного дня
         */
        async function loadWorkshopDataForDay(date) {
            try {
                const selectedWorkshop = DOM.workshopFilter.value;
                
                // Загружаем почасовые данные для цехов
                const workshop1Data = selectedWorkshop === 'all' || selectedWorkshop === '1' ? 
                    await getWorkshopHourlyData('1', date) : 
                    { working: 0, stopped: 0, shutdown: 0 };
                    
                const workshop2Data = selectedWorkshop === 'all' || selectedWorkshop === '2' ? 
                    await getWorkshopHourlyData('2', date) : 
                    { working: 0, stopped: 0, shutdown: 0 };

                // Агрегируем почасовые данные в общие за день
                workshopData = {
                    workshop1: aggregateHourlyToDaily(workshop1Data),
                    workshop2: aggregateHourlyToDaily(workshop2Data),
                    total: {
                        working: aggregateHourlyToDaily(workshop1Data).working + aggregateHourlyToDaily(workshop2Data).working,
                        stopped: aggregateHourlyToDaily(workshop1Data).stopped + aggregateHourlyToDaily(workshop2Data).stopped,
                        shutdown: aggregateHourlyToDaily(workshop1Data).shutdown + aggregateHourlyToDaily(workshop2Data).shutdown
                    }
                };
                
                console.log('Данные цехов за день:', workshopData);
                updateWorkshopCharts();
                
            } catch (error) {
                console.error('Ошибка загрузки данных цехов за день:', error);
                throw error;
            }
        }

        /**
         * Загружает почасовые данные для цеха за конкретный день
         */
        async function getWorkshopHourlyData(workshop, date) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/workshops/hourly?date=${date}&workshop=${workshop}`);
                const data = await handleApiResponse(response);
                return data.data;
            } catch (error) {
                console.error(`Ошибка загрузки почасовых данных для цеха ${workshop}:`, error);
                return null;
            }
        }

        /**
         * Агрегирует почасовые данные в общие за день
         */
        function aggregateHourlyToDaily(hourlyData) {
            if (!hourlyData || !hourlyData.datasets) {
                return { working: 0, stopped: 0, shutdown: 0 };
            }

            const working = hourlyData.datasets[0].data.reduce((sum, val) => sum + val, 0) / 60; // минуты в часы
            const stopped = hourlyData.datasets[1].data.reduce((sum, val) => sum + val, 0) / 60;
            const shutdown = hourlyData.datasets[2].data.reduce((sum, val) => sum + val, 0) / 60;

            return {
                working: Math.round(working * 100) / 100,
                stopped: Math.round(stopped * 100) / 100,
                shutdown: Math.round(shutdown * 100) / 100
            };
        }

        /**
         * Агрегирует данные цеха из почасовых отчетов
         */
        async function aggregateWorkshopDataFromHourly(workshop, startDate, endDate) {
            let totalWorking = 0;
            let totalStopped = 0;
            let totalShutdown = 0;

            const start = new Date(startDate);
            const end = new Date(endDate);
            const current = new Date(start);

            while (current <= end) {
                const dateStr = current.toISOString().split('T')[0];
                try {
                    const response = await fetch(`${API_BASE_URL}/api/workshops/hourly?date=${dateStr}&workshop=${workshop}`);
                    const data = await handleApiResponse(response);

                    // Суммируем данные за день
                    if (data.data && data.data.datasets) {
                        totalWorking += data.data.datasets[0].data.reduce((a, b) => a + b, 0);
                        totalStopped += data.data.datasets[1].data.reduce((a, b) => a + b, 0);
                        totalShutdown += data.data.datasets[2].data.reduce((a, b) => a + b, 0);
                    }
                } catch (error) {
                    console.error(`Ошибка загрузки данных за ${dateStr}:`, error);
                }
                current.setDate(current.getDate() + 1);
            }

            // Конвертируем минуты в часы
            return {
                working: totalWorking / 60,
                stopped: totalStopped / 60,
                shutdown: totalShutdown / 60
            };
        }

        /**
         * Обновляет графики для режима просмотра цехов
         */
        async function updateWorkshopCharts() {
            console.log('Обновление графиков цехов');
            
            const periodText = formatPeriod(DOM.startDate.value, DOM.endDate.value);
            
            // 1. Круговая диаграмма (общие данные)
            pieChart.data.datasets[0].data = [
                workshopData.total.working,
                workshopData.total.stopped,
                workshopData.total.shutdown
            ];
            
            // 2. Горизонтальная столбчатая диаграмма (сравнение цехов)
            horizontalBarChart.data.datasets[0].data = [
                workshopData.workshop1.shutdown,
                workshopData.workshop2.shutdown
            ];
            horizontalBarChart.data.datasets[1].data = [
                workshopData.workshop1.stopped,
                workshopData.workshop2.stopped
            ];
            horizontalBarChart.data.datasets[2].data = [
                workshopData.workshop1.working,
                workshopData.workshop2.working
            ];
            
            // Обновляем заголовки в зависимости от периода
            if (currentPeriod === 'day') {
                document.getElementById('pieChartTitle').textContent = 
                    `Состояние станков всех цехов за ${periodText}`;
                document.getElementById('horizontalBarChartTitle').textContent = 
                    `Сравнение цехов за ${periodText}`;
            } else {
                document.getElementById('pieChartTitle').textContent = 
                    `Состояние станков всех цехов (${periodText})`;
                document.getElementById('horizontalBarChartTitle').textContent = 
                    `Сравнение цехов (${periodText})`;
            }
            
            // Обновляем все графики
            try {
                pieChart.update();
                horizontalBarChart.update();
                console.log('Графики цехов успешно обновлены');
            } catch (e) {
                console.error('Ошибка обновления графиков цехов:', e);
            }
        }

        /**
         * Устанавливает период для отображения данных
         * @param {string} period - Тип периода (day, week, month, year)
         */
        function setPeriod(period) {
            console.log(`Установка периода: ${period}`);
            
            currentPeriod = period;
            const today = new Date();
            let startDate, endDate;
            
            // Обновляем активную кнопку периода
            document.querySelectorAll('.period-buttons button').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.toLowerCase().includes(period)) {
                    btn.classList.add('active');
                }
            });
            
            // Устанавливаем даты в соответствии с периодом
            switch (period) {
                case 'day':
                    // Для периода "День" используем только текущий день
                    startDate = new Date(today);
                    endDate = new Date(today);
                    break;
                    
                case 'week':
                    startDate = new Date(today);
                    startDate.setDate(today.getDate() - today.getDay());
                    endDate = new Date(today);
                    endDate.setDate(today.getDate() + (6 - today.getDay()));
                    break;
                    
                case 'month':
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                    break;
                    
                case 'year':
                    startDate = new Date(today.getFullYear(), 0, 1);
                    endDate = new Date(today.getFullYear(), 11, 31);
                    break;
            }
            
            // Устанавливаем даты в полях ввода
            DOM.startDate.valueAsDate = startDate;
            DOM.endDate.valueAsDate = endDate;
            
            // Загружаем данные для текущего режима просмотра
            if (currentViewMode === 'workshop') {
                loadWorkshopData();
            } else {
                const machineId = DOM.machineFilter.value;
                if (machineId && machineId !== 'all') {
                    loadMachineData(machineId);
                }
            }
        }

        /**
         * Переключает режим просмотра на цеха
         */
        function showWorkshopView() {
            console.log('Переключение в режим просмотра цехов');
            currentViewMode = 'workshop';
            DOM.workshopCharts.style.display = 'grid';
            DOM.individualCharts.style.display = 'none';
            loadWorkshopData();
        }

        /**
         * Переключает режим просмотра на отдельный станок
         */
        function showMachineView() {
            console.log('Переключение в режим просмотра станка');
            currentViewMode = 'individual';
            DOM.workshopCharts.style.display = 'none';
            DOM.individualCharts.style.display = 'block';
            
            const machineId = DOM.machineFilter.value;
            if (machineId && machineId !== 'all') {
                loadMachineData(machineId);
            }
        }

        /**
         * Инициализирует все графики на странице
         */
        function initCharts() {
            console.log('Инициализация графиков...');
            
            // 1. Круговая диаграмма (статусы станков)
            const pieCtx = document.getElementById('pieChart').getContext('2d');
            pieChart = new Chart(pieCtx, {
                type: 'pie',
                data: {
                    labels: Object.values(STATUS_LABELS),
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: [
                            STATUS_COLORS[STATUS.WORKING],
                            STATUS_COLORS[STATUS.STOPPED],
                            STATUS_COLORS[STATUS.SHUTDOWN]
                        ],
                        borderColor: '#fff',
                        borderWidth: 1,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            position: 'top',
                            labels: {
                                padding: 20,
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                    return `${label}: ${value.toFixed(1)} ч (${percentage}%)`;
                                }
                            }
                        }
                    },
                    animation: {
                        animateScale: true,
                        animateRotate: true
                    }
                }
            });
            
            // 2. График количества деталей по дням - ВЕРТИКАЛЬНАЯ СТОЛБЧАТАЯ ДИАГРАММА
            const partsCtx = document.getElementById('partsChart').getContext('2d');
            partsChart = new Chart(partsCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Количество деталей',
                        data: [],
                        backgroundColor: 'rgba(54, 162, 235, 0.7)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1,
                        borderRadius: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Дни',
                                padding: {top: 10}
                            },
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Количество деталей',
                                padding: {bottom: 10}
                            },
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Деталей: ${context.raw}`;
                                }
                            }
                        },
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 12,
                                padding: 20
                            }
                        }
                    }
                }
            });
            
            // 3. Горизонтальная столбчатая диаграмма (сравнение цехов)
            const horizontalBarCtx = document.getElementById('horizontalBarChart').getContext('2d');
            horizontalBarChart = new Chart(horizontalBarCtx, {
                type: 'bar',
                data: {
                    labels: ['ЦЕХ-1', 'ЦЕХ-2'],
                    datasets: [
                        {
                            label: STATUS_LABELS[STATUS.SHUTDOWN],
                            data: [0, 0],
                            backgroundColor: STATUS_COLORS[STATUS.SHUTDOWN],
                            borderColor: STATUS_COLORS[STATUS.SHUTDOWN],
                            borderWidth: 1,
                            borderRadius: 3
                        },
                        {
                            label: STATUS_LABELS[STATUS.STOPPED],
                            data: [0, 0],
                            backgroundColor: STATUS_COLORS[STATUS.STOPPED],
                            borderColor: STATUS_COLORS[STATUS.STOPPED],
                            borderWidth: 1,
                            borderRadius: 3
                        },
                        {
                            label: STATUS_LABELS[STATUS.WORKING],
                            data: [0, 0],
                            backgroundColor: STATUS_COLORS[STATUS.WORKING],
                            borderColor: STATUS_COLORS[STATUS.WORKING],
                            borderWidth: 1,
                            borderRadius: 3
                        }
                    ]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { 
                            stacked: true,
                            title: {
                                display: true,
                                text: 'Часы работы',
                                padding: {top: 10}
                            }
                        },
                        y: { 
                            stacked: true,
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.raw.toFixed(1)} ч`;
                                }
                            }
                        },
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 12,
                                padding: 20
                            }
                        }
                    }
                }
            });
            
            // 4. График статусов для отдельного станка
            const machineCtx = document.getElementById('machineStatusChart').getContext('2d');
            machineStatusChart = new Chart(machineCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: STATUS_LABELS[STATUS.SHUTDOWN],
                            data: [],
                            backgroundColor: STATUS_COLORS[STATUS.SHUTDOWN],
                            borderColor: STATUS_COLORS[STATUS.SHUTDOWN],
                            borderWidth: 1,
                            borderRadius: 3
                        },
                        {
                            label: STATUS_LABELS[STATUS.STOPPED],
                            data: [],
                            backgroundColor: STATUS_COLORS[STATUS.STOPPED],
                            borderColor: STATUS_COLORS[STATUS.STOPPED],
                            borderWidth: 1,
                            borderRadius: 3
                        },
                        {
                            label: STATUS_LABELS[STATUS.WORKING],
                            data: [],
                            backgroundColor: STATUS_COLORS[STATUS.WORKING],
                            borderColor: STATUS_COLORS[STATUS.WORKING],
                            borderWidth: 1,
                            borderRadius: 3
                        }
                    ]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { 
                            stacked: true,
                            title: {
                                display: true,
                                text: 'Часы работы',
                                padding: {top: 10}
                            }
                        },
                        y: { 
                            stacked: true,
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.raw.toFixed(1)} ч`;
                                }
                            }
                        },
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 12,
                                padding: 20
                            }
                        }
                    }
                }
            });
            
            // 5. График временной шкалы для отдельного станка
            const timelineCtx = document.getElementById('timelineChart').getContext('2d');
            timelineChart = new Chart(timelineCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Статус станка',
                            data: [],
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.1,
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            pointBackgroundColor: '#3498db'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            min: 0,
                            max: 2,
                            ticks: {
                                callback: function(value) {
                                    return STATUS_LABELS[Object.keys(STATUS_LABELS)[value]];
                                },
                                stepSize: 1
                            },
                            title: {
                                display: true,
                                text: 'Статус'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Время'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return STATUS_LABELS[Object.keys(STATUS_LABELS)[context.raw]];
                                }
                            }
                        },
                        legend: {
                            display: false
                        }
                    }
                }
            });
            
            console.log('Все графики инициализированы');
        }

        // Инициализация приложения после загрузки DOM
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM загружен, инициализация приложения...');
            
            // 1. Инициализируем графики
            initCharts();
            
            // 2. Загружаем список станков
            loadMachineList();
            
            // 3. Устанавливаем текущую дату по умолчанию
            const today = new Date();
            DOM.startDate.valueAsDate = today;
            DOM.endDate.valueAsDate = today;
            
            // 4. Настраиваем обработчики событий
            DOM.workshopFilter.addEventListener('change', function() {
                console.log('Изменен фильтр цеха:', this.value);
                updateMachineFilter();
                showWorkshopView();
            });
            
            DOM.machineFilter.addEventListener('change', function() {
                console.log('Изменен фильтр станка:', this.value);
                if (this.value === 'all') {
                    showWorkshopView();
                } else {
                    showMachineView();
                }
            });
            
            DOM.applyFilters.addEventListener('click', function() {
                console.log('Применение фильтров...');
                if (currentViewMode === 'workshop') {
                    loadWorkshopData();
                } else {
                    const machineId = DOM.machineFilter.value;
                    if (machineId && machineId !== 'all') {
                        loadMachineData(machineId);
                    }
                }
            });
            
            // 5. Загружаем начальные данные за сегодняшний день
            setTimeout(() => {
                loadWorkshopData();
            }, 500);
            
            console.log('Приложение инициализировано');
        });

        // Функция для загрузки данных станка (заглушка)
        async function loadMachineData(machineId) {
            console.log(`Загрузка данных для станка ${machineId}`);
            showNotification(`Загрузка данных для станка ${machineId}...`, 'loading');
            
            // Здесь будет реализация загрузки данных конкретного станка
            setTimeout(() => {
                showNotification('Функционал для отдельных станков в разработке', 'success');
            }, 1000);
        }
    </script>
</body>
</html>